'use strict';const _0x306c19=_0x5ecd;(function(_0x265886,_0x471a85){const _0x3ed8db=_0x5ecd,_0x488e4b=_0x265886();while(!![]){try{const _0x498914=parseInt(_0x3ed8db(0x1b0))/0x1*(-parseInt(_0x3ed8db(0x11b))/0x2)+-parseInt(_0x3ed8db(0x136))/0x3+parseInt(_0x3ed8db(0x128))/0x4*(-parseInt(_0x3ed8db(0x135))/0x5)+-parseInt(_0x3ed8db(0x149))/0x6*(parseInt(_0x3ed8db(0x19e))/0x7)+-parseInt(_0x3ed8db(0x171))/0x8*(-parseInt(_0x3ed8db(0x118))/0x9)+parseInt(_0x3ed8db(0x16d))/0xa*(parseInt(_0x3ed8db(0x19d))/0xb)+parseInt(_0x3ed8db(0x12b))/0xc;if(_0x498914===_0x471a85)break;else _0x488e4b['push'](_0x488e4b['shift']());}catch(_0x561726){_0x488e4b['push'](_0x488e4b['shift']());}}}(_0x2475,0xf0a3c));function _0x5ecd(_0x391226,_0x3038ee){const _0x247588=_0x2475();return _0x5ecd=function(_0x5ecd02,_0x3769c4){_0x5ecd02=_0x5ecd02-0x118;let _0x10adc0=_0x247588[_0x5ecd02];return _0x10adc0;},_0x5ecd(_0x391226,_0x3038ee);}var __decorate=this&&this[_0x306c19(0x16f)]||function(_0x2463a8,_0x16cc52,_0x378ebb,_0xfe8963){const _0x3b27c1=_0x306c19;var _0x4a9daf=arguments['length'],_0x3be9c5=_0x4a9daf<0x3?_0x16cc52:_0xfe8963===null?_0xfe8963=Object[_0x3b27c1(0x17e)](_0x16cc52,_0x378ebb):_0xfe8963,_0x462ece;if(typeof Reflect===_0x3b27c1(0x17c)&&typeof Reflect[_0x3b27c1(0x14e)]===_0x3b27c1(0x15e))_0x3be9c5=Reflect[_0x3b27c1(0x14e)](_0x2463a8,_0x16cc52,_0x378ebb,_0xfe8963);else{for(var _0xa3cfee=_0x2463a8[_0x3b27c1(0x15f)]-0x1;_0xa3cfee>=0x0;_0xa3cfee--)if(_0x462ece=_0x2463a8[_0xa3cfee])_0x3be9c5=(_0x4a9daf<0x3?_0x462ece(_0x3be9c5):_0x4a9daf>0x3?_0x462ece(_0x16cc52,_0x378ebb,_0x3be9c5):_0x462ece(_0x16cc52,_0x378ebb))||_0x3be9c5;}return _0x4a9daf>0x3&&_0x3be9c5&&Object[_0x3b27c1(0x134)](_0x16cc52,_0x378ebb,_0x3be9c5),_0x3be9c5;},__metadata=this&&this['__metadata']||function(_0x5f2234,_0x519708){const _0x454b11=_0x306c19;if(typeof Reflect===_0x454b11(0x17c)&&typeof Reflect[_0x454b11(0x1c7)]===_0x454b11(0x15e))return Reflect[_0x454b11(0x1c7)](_0x5f2234,_0x519708);},__param=this&&this[_0x306c19(0x144)]||function(_0x17a4f1,_0x24ed30){return function(_0x463860,_0x42872c){_0x24ed30(_0x463860,_0x42872c,_0x17a4f1);};};Object[_0x306c19(0x134)](exports,_0x306c19(0x152),{'value':!![]}),exports[_0x306c19(0x129)]=void 0x0;const globalConfig_service_1=require(_0x306c19(0x13a)),typeorm_1=require('@nestjs/typeorm'),balance_entity_1=require(_0x306c19(0x132)),common_1=require('@nestjs/common'),typeorm_2=require(_0x306c19(0x122)),balance_constant_1=require(_0x306c19(0x18b)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x306c19(0x140)),config_entity_1=require(_0x306c19(0x14d)),cramiPackage_entity_1=require(_0x306c19(0x181)),userBalance_entity_1=require(_0x306c19(0x192)),date_1=require(_0x306c19(0x1ad)),user_entity_1=require(_0x306c19(0x180)),salesUsers_entity_1=require(_0x306c19(0x147)),sales_service_1=require(_0x306c19(0x151)),whiteList_entity_1=require(_0x306c19(0x163));let UserBalanceService=class UserBalanceService{constructor(_0x53bafa,_0x597556,_0x2b006d,_0x1318ad,_0xa21835,_0xc8ae9,_0x3b6b53,_0x252b05,_0x38968a,_0x5cb14a){const _0x85f02d=_0x306c19;this[_0x85f02d(0x14b)]=_0x53bafa,this[_0x85f02d(0x167)]=_0x597556,this[_0x85f02d(0x1cc)]=_0x2b006d,this[_0x85f02d(0x190)]=_0x1318ad,this['configEntity']=_0xa21835,this[_0x85f02d(0x1a3)]=_0xc8ae9,this[_0x85f02d(0x1b2)]=_0x3b6b53,this[_0x85f02d(0x1aa)]=_0x252b05,this['salesService']=_0x38968a,this[_0x85f02d(0x18a)]=_0x5cb14a;}async[_0x306c19(0x175)](_0x2979ab,_0x5ba264){const _0x436978=_0x306c19;try{const _0x276d4d=await this[_0x436978(0x1bd)][_0x436978(0x153)]({'where':{'configKey':(0x0,typeorm_2['In'])(['registerSendStatus','registerSendModel3Count',_0x436978(0x1a4),'registerSendDrawMjCount',_0x436978(0x12c),_0x436978(0x1ac),_0x436978(0x154),_0x436978(0x143),'firstRregisterSendDrawMjCount',_0x436978(0x1ae),'inviteGiveSendModel3Count','inviteGiveSendModel4Count',_0x436978(0x196),_0x436978(0x142),'invitedGuestSendDrawMjCount',_0x436978(0x119)])}}),_0x1788e9=_0x276d4d['reduce']((_0xe68274,_0x428ebe)=>{const _0x4a31b2=_0x436978,_0x1765ed=Number(_0x428ebe[_0x4a31b2(0x1a9)]),_0x295700=Number[_0x4a31b2(0x15d)](_0x1765ed)&&_0x1765ed>0x0?_0x1765ed:0x0;return _0xe68274[_0x428ebe[_0x4a31b2(0x183)]]=_0x295700,_0xe68274;},{});let _0x40c7a2=0x0,_0x12ef15=0x0,_0x52aa4d=0x0;_0x1788e9[_0x436978(0x1a5)]===0x1&&(_0x40c7a2=_0x40c7a2+_0x1788e9[_0x436978(0x1b5)],_0x12ef15=_0x12ef15+_0x1788e9['registerSendModel4Count'],_0x52aa4d=_0x52aa4d+_0x1788e9[_0x436978(0x199)]),_0x1788e9[_0x436978(0x1a5)]===0x1&&_0x1788e9['firstRegisterSendStatus']===0x1&&_0x2979ab<=_0x1788e9[_0x436978(0x1ac)]&&(_0x40c7a2=_0x40c7a2+_0x1788e9['firstRregisterSendModel3Count'],_0x12ef15=_0x12ef15+_0x1788e9[_0x436978(0x143)],_0x52aa4d=_0x52aa4d+_0x1788e9[_0x436978(0x18d)]),await this[_0x436978(0x158)]({'userId':_0x2979ab,'rechargeType':balance_constant_1[_0x436978(0x1c6)][_0x436978(0x176)],'model3Count':_0x40c7a2,'drawMjCount':_0x52aa4d,'model4Count':_0x12ef15}),_0x5ba264&&(Number(_0x1788e9[_0x436978(0x1ae)])===0x1&&(_0x40c7a2=_0x40c7a2+Number(_0x1788e9[_0x436978(0x142)]),_0x12ef15=_0x12ef15+Number(_0x1788e9[_0x436978(0x119)]),_0x52aa4d=_0x52aa4d+Number(_0x1788e9[_0x436978(0x161)]),await this[_0x436978(0x158)]({'userId':_0x2979ab,'rechargeType':balance_constant_1[_0x436978(0x1c6)][_0x436978(0x124)],'model3Count':_0x1788e9[_0x436978(0x142)],'model4Count':_0x1788e9[_0x436978(0x119)],'drawMjCount':_0x1788e9[_0x436978(0x161)]}),await this['addBalanceToUser'](_0x5ba264,{'model3Count':_0x1788e9[_0x436978(0x126)],'model4Count':_0x1788e9['inviteGiveSendModel4Count'],'drawMjCount':_0x1788e9[_0x436978(0x196)]}),await this[_0x436978(0x158)]({'userId':_0x5ba264,'rechargeType':balance_constant_1[_0x436978(0x1c6)][_0x436978(0x195)],'model3Count':_0x1788e9[_0x436978(0x126)],'model4Count':_0x1788e9['inviteGiveSendModel4Count'],'drawMjCount':_0x1788e9[_0x436978(0x196)]}))),await this[_0x436978(0x167)][_0x436978(0x12a)]({'userId':_0x2979ab,'model3Count':_0x40c7a2,'model4Count':_0x12ef15,'drawMjCount':_0x52aa4d,'useTokens':0x0});}catch(_0x43469b){console[_0x436978(0x120)](_0x436978(0x177),_0x43469b);throw new common_1['HttpException']('注册赠送失败,请联系管理员！',common_1[_0x436978(0x141)][_0x436978(0x1c0)]);}}async[_0x306c19(0x1c4)](_0x52094f,_0x25c31e,_0xd7754d){const _0x38e7e4=_0x306c19;let _0x480bb6=await this[_0x38e7e4(0x167)][_0x38e7e4(0x19b)]({'where':{'userId':_0x52094f}});!_0x480bb6&&(_0x480bb6=await this[_0x38e7e4(0x1b4)](_0x52094f));const _0x1a732a=await this[_0x38e7e4(0x1bd)]['findOne']({'where':{'configKey':'vxNumber'}}),_0x44f549=_0x1a732a?_0x1a732a['configVal']:'---',_0x7e3387=_0x25c31e===_0x38e7e4(0x13d)?_0x38e7e4(0x19a):_0x25c31e==='model4'?'memberModel4Count':_0x25c31e===_0x38e7e4(0x11f)?_0x38e7e4(0x187):null,_0x1dfa16=_0x25c31e===_0x38e7e4(0x13d)?_0x38e7e4(0x11a):_0x25c31e===_0x38e7e4(0x131)?_0x38e7e4(0x184):_0x25c31e==='mjDraw'?_0x38e7e4(0x12d):null;if(_0x480bb6[_0x38e7e4(0x1a0)]&&_0x480bb6[_0x7e3387]<_0xd7754d){if(_0x480bb6[_0x1dfa16]<_0xd7754d)throw new common_1[(_0x38e7e4(0x198))](_0x38e7e4(0x19c)+_0x44f549+'>\x20或购买专属套餐\x20！',common_1[_0x38e7e4(0x141)][_0x38e7e4(0x16a)]);}if(!_0x480bb6[_0x38e7e4(0x1a0)]&&_0x480bb6[_0x1dfa16]<_0xd7754d)throw new common_1[(_0x38e7e4(0x198))](_0x38e7e4(0x19c)+_0x44f549+_0x38e7e4(0x18e),common_1[_0x38e7e4(0x141)][_0x38e7e4(0x16a)]);return _0x480bb6;}async[_0x306c19(0x13e)](_0x2d1587,_0x5d657d,_0x8f1f52,_0x5802b0=0x0){const _0x5ba848=_0x306c19,_0x4636ad=await this[_0x5ba848(0x167)][_0x5ba848(0x19b)]({'where':{'userId':_0x2d1587}});if(!_0x4636ad)throw new common_1[(_0x5ba848(0x198))](_0x5ba848(0x1b9),common_1[_0x5ba848(0x141)][_0x5ba848(0x1c0)]);const _0x38f8cc=_0x5d657d===_0x5ba848(0x13d)?_0x5ba848(0x19a):_0x5d657d==='model4'?_0x5ba848(0x16b):_0x5d657d===_0x5ba848(0x11f)?_0x5ba848(0x187):null,_0x15e535=_0x5d657d===_0x5ba848(0x13d)?_0x5ba848(0x11a):_0x5d657d===_0x5ba848(0x131)?_0x5ba848(0x184):_0x5d657d===_0x5ba848(0x11f)?_0x5ba848(0x12d):null,_0x4c461d=_0x4636ad[_0x5ba848(0x1a0)]&&_0x4636ad[_0x38f8cc]<_0x8f1f52?_0x15e535:_0x4636ad[_0x5ba848(0x1a0)]?_0x38f8cc:_0x15e535;let _0x5e0b0b=null;_0x4c461d[_0x5ba848(0x150)]('odel3')&&(_0x5e0b0b='useModel3Token');_0x4c461d[_0x5ba848(0x150)](_0x5ba848(0x1bb))&&(_0x5e0b0b='useModel4Token');_0x4c461d[_0x5ba848(0x150)](_0x5ba848(0x1cb))&&(_0x5e0b0b=_0x5ba848(0x18f));const _0x5312e5={[_0x4c461d]:_0x4636ad[_0x4c461d]-_0x8f1f52<0x0?0x0:_0x4636ad[_0x4c461d]-_0x8f1f52,[_0x5e0b0b]:_0x4636ad[_0x5e0b0b]+_0x5802b0};_0x5e0b0b===_0x5ba848(0x169)&&(_0x5312e5['useModel3Count']=_0x4636ad['useModel3Count']+0x1),_0x5e0b0b===_0x5ba848(0x19f)&&(_0x5312e5[_0x5ba848(0x127)]=_0x4636ad[_0x5ba848(0x127)]+0x1);const _0x2eb59f=await this[_0x5ba848(0x167)][_0x5ba848(0x13b)]({'userId':_0x2d1587},_0x5312e5);if(_0x2eb59f[_0x5ba848(0x1c2)]===0x0)throw new common_1[(_0x5ba848(0x198))]('消费余额失败！',common_1['HttpStatus']['BAD_REQUEST']);}async[_0x306c19(0x1ab)](_0x328852){const _0x3b7ed6=_0x306c19;try{const _0x12f5ca=await this[_0x3b7ed6(0x167)][_0x3b7ed6(0x19b)]({'where':{'userId':_0x328852},'select':[_0x3b7ed6(0x1a0),_0x3b7ed6(0x11a),_0x3b7ed6(0x184),'drawMjCount','memberModel3Count',_0x3b7ed6(0x16b),'memberDrawMjCount',_0x3b7ed6(0x11d),_0x3b7ed6(0x127),_0x3b7ed6(0x169),_0x3b7ed6(0x19f),_0x3b7ed6(0x18f),_0x3b7ed6(0x130)]});if(!_0x12f5ca){const _0x5657d9=await this[_0x3b7ed6(0x1b4)](_0x328852);if(_0x5657d9)return await this[_0x3b7ed6(0x1ab)](_0x328852);else throw new common_1[(_0x3b7ed6(0x198))](_0x3b7ed6(0x148),common_1['HttpStatus'][_0x3b7ed6(0x1c0)]);}return _0x12f5ca[_0x3b7ed6(0x1c9)]=_0x12f5ca[_0x3b7ed6(0x1a0)]?_0x12f5ca[_0x3b7ed6(0x11a)]+_0x12f5ca[_0x3b7ed6(0x19a)]:_0x12f5ca[_0x3b7ed6(0x11a)],_0x12f5ca[_0x3b7ed6(0x18c)]=_0x12f5ca['packageId']?_0x12f5ca[_0x3b7ed6(0x184)]+_0x12f5ca[_0x3b7ed6(0x16b)]:_0x12f5ca['model4Count'],_0x12f5ca[_0x3b7ed6(0x12e)]=_0x12f5ca[_0x3b7ed6(0x1a0)]?_0x12f5ca[_0x3b7ed6(0x12d)]+_0x12f5ca[_0x3b7ed6(0x187)]:_0x12f5ca[_0x3b7ed6(0x12d)],_0x12f5ca['expirationTime']=_0x12f5ca[_0x3b7ed6(0x130)]?(0x0,date_1[_0x3b7ed6(0x11c)])(_0x12f5ca['expirationTime'],_0x3b7ed6(0x166)):null,_0x12f5ca;}catch(_0x331f9c){console['log'](_0x3b7ed6(0x177),_0x331f9c);}}async[_0x306c19(0x158)](_0x241a56){const _0x22e738=_0x306c19,{userId:_0x2e485b,rechargeType:_0x37fccd,model3Count:_0x3f624f,model4Count:_0x39410f,drawMjCount:_0xc4c05,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x241a56;if(!_0x2e485b)throw new common_1[(_0x22e738(0x198))]('当前用户不存在,记录充值日志异常',common_1[_0x22e738(0x141)]['BAD_REQUEST']);const _0x109fda=(0x0,utils_1[_0x22e738(0x13f)])();return await this[_0x22e738(0x1cc)][_0x22e738(0x12a)]({'userId':_0x2e485b,'rechargeType':_0x37fccd,'model3Count':_0x3f624f,'model4Count':_0x39410f,'drawMjCount':_0xc4c05,'days':days,'extent':extent,'uid':_0x109fda,'pkgName':pkgName});}async[_0x306c19(0x1b4)](_0x4d3f93,_0x3cdc98={}){const _0x98ff60=_0x306c19,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3cdc98,_0x38b7e6=await this[_0x98ff60(0x167)][_0x98ff60(0x19b)]({'where':{'userId':_0x4d3f93}});if(_0x38b7e6)throw new common_1[(_0x98ff60(0x198))]('当前用户无需创建账户信息！',common_1[_0x98ff60(0x141)][_0x98ff60(0x1c0)]);return await this['userBalanceEntity'][_0x98ff60(0x12a)]({'userId':_0x4d3f93,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x306c19(0x173)](_0x318a47,_0x5f2649,_0x39ee76=-0x1){const _0x41036f=_0x306c19;try{const _0x3112bc=await this[_0x41036f(0x167)][_0x41036f(0x19b)]({'where':{'userId':_0x318a47}})||await this[_0x41036f(0x1b4)](_0x318a47);if(!_0x3112bc)throw new common_1[(_0x41036f(0x198))](_0x41036f(0x170),common_1[_0x41036f(0x141)][_0x41036f(0x1c0)]);const {model3Count:_0x275211,model4Count:_0x187c92,drawMjCount:_0x50c79b,memberModel3Count:_0x20be25,memberModel4Count:_0x512bde,memberDrawMjCount:_0x5a9185}=_0x3112bc;let _0x339108={};if(_0x39ee76>0x0){const {packageId:_0x3b0f68}=_0x5f2649;if(!_0x3b0f68)throw new common_1[(_0x41036f(0x198))]('缺失当前套餐ID、充值失败！',common_1[_0x41036f(0x141)][_0x41036f(0x1c0)]);const _0x1bbec9=await this[_0x41036f(0x190)][_0x41036f(0x19b)]({'where':{'id':_0x3b0f68}});if(!_0x1bbec9)throw new common_1['HttpException'](_0x41036f(0x172),common_1[_0x41036f(0x141)][_0x41036f(0x1c0)]);const {weight:_0x471d5a}=_0x1bbec9;if(!_0x3112bc[_0x41036f(0x1a0)])_0x339108={'memberModel3Count':_0x275211+_0x5f2649[_0x41036f(0x11a)],'memberModel4Count':_0x187c92+_0x5f2649[_0x41036f(0x184)],'memberDrawMjCount':_0x50c79b+_0x5f2649[_0x41036f(0x12d)],'expirationTime':(0x0,date_1[_0x41036f(0x159)])()[_0x41036f(0x157)](_0x39ee76>0x0?_0x39ee76:0x0,_0x41036f(0x123))[_0x41036f(0x133)](_0x41036f(0x155)),'packageId':_0x3b0f68};else{const _0x114867=await this['cramiPackageEntity'][_0x41036f(0x19b)]({'where':{'id':_0x3112bc[_0x41036f(0x1a0)]}});_0x471d5a>=_0x114867['weight']&&(_0x339108={'memberModel3Count':_0x20be25+_0x5f2649[_0x41036f(0x11a)],'memberModel4Count':_0x512bde+_0x5f2649[_0x41036f(0x184)],'memberDrawMjCount':_0x5a9185+_0x5f2649[_0x41036f(0x12d)],'expirationTime':(0x0,date_1[_0x41036f(0x159)])(_0x3112bc[_0x41036f(0x130)])[_0x41036f(0x157)](_0x39ee76>0x0?_0x39ee76:0x0,_0x41036f(0x123))[_0x41036f(0x133)](_0x41036f(0x155)),'packageId':_0x3b0f68}),_0x471d5a<_0x114867[_0x41036f(0x1ca)]&&(_0x339108={'memberModel3Count':_0x20be25+_0x5f2649[_0x41036f(0x11a)],'memberModel4Count':_0x512bde+_0x5f2649[_0x41036f(0x184)],'memberDrawMjCount':_0x5a9185+_0x5f2649[_0x41036f(0x12d)]});}}_0x39ee76<=0x0&&(_0x339108={'model3Count':_0x275211+_0x5f2649[_0x41036f(0x11a)],'model4Count':_0x187c92+_0x5f2649[_0x41036f(0x184)],'drawMjCount':_0x50c79b+_0x5f2649[_0x41036f(0x12d)]});const _0x4e706f=await this[_0x41036f(0x167)]['update']({'userId':_0x318a47},_0x339108);if(_0x4e706f['affected']===0x0)throw new common_1[(_0x41036f(0x198))](_0x318a47+_0x41036f(0x1b7),common_1[_0x41036f(0x141)][_0x41036f(0x1c0)]);}catch(_0x3a5bc4){console['log'](_0x41036f(0x177),_0x3a5bc4);throw new common_1['HttpException'](_0x41036f(0x193),common_1['HttpStatus'][_0x41036f(0x1c0)]);}}async[_0x306c19(0x1c1)](_0x275235){const _0x1cbd56=_0x306c19;console['log'](_0x1cbd56(0x1bf),_0x275235);try{const {userId:_0x45a611,goodsId:_0xa7cdc6}=_0x275235,_0x4662cb=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x275235[_0x1cbd56(0x12f)],'status':0x1}});if(!_0x4662cb)throw new common_1[(_0x1cbd56(0x198))](_0x1cbd56(0x1b8),common_1[_0x1cbd56(0x141)][_0x1cbd56(0x1c0)]);const {model3Count:_0x2fc0dc,model4Count:_0x935ca,drawMjCount:_0x5b4123,days:_0x289f43,name:_0xbdf981}=_0x4662cb,_0x5be403={'model3Count':_0x2fc0dc,'model4Count':_0x935ca,'drawMjCount':_0x5b4123,'days':_0x289f43,'packageId':_0x275235[_0x1cbd56(0x12f)]};await this[_0x1cbd56(0x173)](_0x45a611,_0x5be403,_0x289f43),await this[_0x1cbd56(0x158)]({'userId':_0x45a611,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x2fc0dc,'model4Count':_0x935ca,'drawMjCount':_0x5b4123,'pkgName':_0xbdf981,'days':_0x289f43});const _0x4fa6cf=await this[_0x1cbd56(0x1a3)][_0x1cbd56(0x19b)]({'where':{'id':_0x45a611}}),{invitedBy:_0x5c7b83}=_0x4fa6cf;if(_0x5c7b83){const _0x1dca78=await this[_0x1cbd56(0x1a3)][_0x1cbd56(0x19b)]({'where':{'inviteCode':_0x5c7b83}}),_0x2cc0af=await this[_0x1cbd56(0x1b2)]['findOne']({'where':{'userId':_0x1dca78['id']}});if(!_0x1dca78)return;const {id:_0x33136d}=_0x1dca78,{performanceRatio:_0x53201c}=_0x2cc0af,_0xf8c82e={'inviterUserId':_0x33136d,'inviteeUserId':_0x45a611,'orderId':_0x275235['id'],'orderPrice':_0x275235['total'],'commissionPercentage':_0x53201c,'commissionAmount':(_0x275235[_0x1cbd56(0x178)]*_0x53201c/0x64)[_0x1cbd56(0x1be)](0x2)};await this[_0x1cbd56(0x197)][_0x1cbd56(0x164)](_0xf8c82e),await this[_0x1cbd56(0x197)][_0x1cbd56(0x189)](_0x33136d,_0xf8c82e[_0x1cbd56(0x1a6)]);}}catch(_0x13dc07){console['log'](_0x1cbd56(0x177),_0x13dc07);throw new common_1[(_0x1cbd56(0x198))](_0x1cbd56(0x1a7),common_1['HttpStatus'][_0x1cbd56(0x1c0)]);}}async[_0x306c19(0x194)](_0x35661b,_0xb1fd22){const _0x5c6f7d=_0x306c19,{page:page=0x1,size:size=0x14}=_0xb1fd22,{id:_0x511e21}=_0x35661b[_0x5c6f7d(0x168)],[_0x3ceb10,_0x58c227]=await this[_0x5c6f7d(0x1cc)][_0x5c6f7d(0x1b6)]({'where':{'userId':_0x511e21},'order':{'id':_0x5c6f7d(0x156)},'skip':(page-0x1)*size,'take':size});return _0x3ceb10['forEach'](_0x234901=>{const _0x2c3ef4=_0x5c6f7d;_0x234901[_0x2c3ef4(0x17d)]=_0x234901[_0x2c3ef4(0x14a)]>0x0?_0x234901[_0x2c3ef4(0x14a)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x3ceb10),'count':_0x58c227};}async[_0x306c19(0x138)](_0x3e267f,_0x51fe8b){const _0x218b30=_0x306c19;try{const {page:page=0x1,size:size=0xa,userId:_0xf14ebd,rechargeType:_0x13faea,packageId:_0x17bb99}=_0x51fe8b,{role:_0xb2a585}=_0x3e267f['user'],_0x4ee62f={};_0x13faea&&(_0x4ee62f[_0x218b30(0x16e)]=_0x13faea),_0xf14ebd&&(_0x4ee62f['userId']=_0xf14ebd),_0x17bb99&&(_0x4ee62f[_0x218b30(0x1a0)]={'$like':'%'+_0x17bb99+'%'});const [_0x412782,_0x4b5564]=await this['accountLogEntity'][_0x218b30(0x1b6)]({'where':_0x4ee62f,'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size}),_0x3279bb=_0x412782[_0x218b30(0x125)](_0x154410=>_0x154410[_0x218b30(0x14c)]),_0x596940=await this[_0x218b30(0x1a3)][_0x218b30(0x153)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3279bb)}});return _0x412782[_0x218b30(0x14f)](_0x2c0129=>{const _0x53240f=_0x218b30,_0x5b04b0=_0x596940['find'](_0x50e6a8=>_0x50e6a8['id']===_0x2c0129[_0x53240f(0x14c)]);_0x2c0129[_0x53240f(0x165)]=_0x5b04b0['username'],_0x2c0129['email']=_0x5b04b0[_0x53240f(0x145)],_0x2c0129['phone']=_0x5b04b0[_0x53240f(0x121)],_0x2c0129['status']=_0x5b04b0[_0x53240f(0x1c8)],_0x2c0129[_0x53240f(0x1a2)]=_0x5b04b0['avatar'];}),_0xb2a585!==_0x218b30(0x17a)&&_0x412782[_0x218b30(0x14f)](_0x175edd=>{const _0x349135=_0x218b30;_0x175edd[_0x349135(0x145)]=_0x175edd[_0x349135(0x145)]?(0x0,utils_1[_0x349135(0x1cd)])(_0x175edd['email']):'',_0x175edd[_0x349135(0x121)]=_0x175edd['phone']?(0x0,utils_1[_0x349135(0x1cd)])(_0x175edd[_0x349135(0x121)]):'';}),{'rows':_0x412782,'count':_0x4b5564};}catch(_0x48e9b8){console['log'](_0x218b30(0x177),_0x48e9b8);throw new common_1['HttpException'](_0x218b30(0x137),common_1[_0x218b30(0x141)][_0x218b30(0x1c0)]);}}async[_0x306c19(0x188)](_0x43a840){const _0x2610dc=_0x306c19;return await this[_0x2610dc(0x167)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x43a840)}});}async[_0x306c19(0x179)](_0x142e3c,_0x3ce4d9){const _0x436240=_0x306c19;await this[_0x436240(0x173)](_0x142e3c,{'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0x3ce4d9}),await this['saveRecordRechargeLog']({'userId':_0x142e3c,'rechargeType':balance_constant_1[_0x436240(0x1c6)]['DRAW_FAIL_REFUND'],'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0x3ce4d9}),common_1[_0x436240(0x17f)][_0x436240(0x162)]('用户'+_0x142e3c+_0x436240(0x15b)+_0x3ce4d9,_0x436240(0x16c));}async[_0x306c19(0x160)](){const _0x2cd925=_0x306c19,_0x2becb2=await this['userEntity'][_0x2cd925(0x153)]();if(!_0x2becb2['length'])return;const _0x4a9bdd=await this['globalConfigService'][_0x2cd925(0x1a1)](['upgradeStatus']);if(!_0x4a9bdd)await this[_0x2cd925(0x18a)][_0x2cd925(0x139)]({'settings':[{'configKey':_0x2cd925(0x1c5),'configVal':'1'}]});else throw new common_1['HttpException']('您已经升级过了、请勿重复操作！',common_1[_0x2cd925(0x141)][_0x2cd925(0x1c0)]);_0x2becb2['forEach'](_0x237c8a=>{const _0xfad3ac=_0x2cd925,{id:_0x486989}=_0x237c8a;this[_0xfad3ac(0x14b)]['findOne']({'where':{'userId':_0x486989}})[_0xfad3ac(0x174)](_0xb84bcd=>{const _0x598280=_0xfad3ac;if(!_0xb84bcd)return;this[_0x598280(0x1ba)](_0x486989,_0xb84bcd);});});}async['writeOldBalanceToNewTable'](_0x23b453,_0x5714ab){const _0x2416d9=_0x306c19,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x5714ab,_0x2f52e2=await this['whiteListEntity'][_0x2416d9(0x19b)]({'where':{'userId':_0x23b453}}),_0x487b13={'userId':_0x23b453,'model3Count':Number(usesLeft),'model4Count':(_0x2f52e2===null||_0x2f52e2===void 0x0?void 0x0:_0x2f52e2[_0x2416d9(0x1c3)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x2f52e2===null||_0x2f52e2===void 0x0?void 0x0:_0x2f52e2[_0x2416d9(0x13c)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x15996e=await this[_0x2416d9(0x167)][_0x2416d9(0x19b)]({'where':{'userId':_0x23b453}});_0x15996e?common_1[_0x2416d9(0x17f)][_0x2416d9(0x162)]('用户'+_0x23b453+_0x2416d9(0x1a8),_0x2416d9(0x16c)):this[_0x2416d9(0x167)][_0x2416d9(0x12a)](_0x487b13)[_0x2416d9(0x174)](_0x3c4213=>{const _0x4a6e29=_0x2416d9;common_1[_0x4a6e29(0x17f)][_0x4a6e29(0x162)]('用户'+_0x23b453+_0x4a6e29(0x1af),_0x4a6e29(0x16c));})[_0x2416d9(0x1ce)](_0x1de5c2=>{const _0x1000dc=_0x2416d9;console[_0x1000dc(0x120)](_0x1000dc(0x177),_0x1de5c2),common_1[_0x1000dc(0x17f)][_0x1000dc(0x162)]('用户'+_0x23b453+'旧账户信息迁移失败',_0x1000dc(0x16c));});}};function _0x2475(){const _0x1347f2=['HttpException','registerSendDrawMjCount','memberModel3Count','findOne','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','811635XPDXOv','7SeWfGa','useModel4Token','packageId','getConfigs','avatar','userEntity','registerSendModel4Count','registerSendStatus','commissionAmount','充值失败！','账户信息已经存在、迁移无效','configVal','whiteListEntity','queryUserBalance','firstRegisterSendRank','../../common/utils/date','inviteSendStatus','旧账户信息迁移成功','1773887AdDiTd','InjectRepository','salesUsersEntity','UserBalanceEntity','createBaseUserBalance','registerSendModel3Count','findAndCount','充值失败','非法操作、当前充值套餐暂不存在！','缺失当前用户账户记录！','writeOldBalanceToNewTable','odel4','Injectable','configEntity','toFixed','充值的工单信息:','BAD_REQUEST','addBalanceToOrder','affected','count','validateBalance','upgradeStatus','RechargeType','metadata','status','sumModel3Count','weight','MjCount','accountLogEntity','hideString','catch','9ONadjo','invitedGuestSendModel4Count','model3Count','2VPjkIq','formatDate','useModel3Count','BalanceEntity','mjDraw','log','phone','typeorm','day','INVITE_GIFT','map','inviteGiveSendModel3Count','useModel4Count','3750728jMhKad','UserBalanceService','save','48024480pitadg','firstRegisterSendStatus','drawMjCount','sumDrawMjCount','goodsId','expirationTime','model4','./balance.entity','format','defineProperty','5zPeIwX','1537338KxNKcT','查询用户账户失败！','getAccountLog','setConfig','./../globalConfig/globalConfig.service','update','useCount','model3','deductFromBalance','createRandomUid','../../common/utils','HttpStatus','invitedGuestSendModel3Count','firstRregisterSendModel4Count','__param','email','design:paramtypes','../sales/salesUsers.entity','查询当前用户余额失败！','10283610NjLlVo','days','balanceEntity','userId','../globalConfig/config.entity','decorate','forEach','includes','../sales/sales.service','__esModule','find','firstRregisterSendModel3Count','YYYY-MM-DD\x20HH:mm:ss','DESC','add','saveRecordRechargeLog','default','ConfigEntity','绘画失败退款--------》','Repository','isInteger','function','length','upgradeBalance','invitedGuestSendDrawMjCount','debug','../chatgpt/whiteList.entity','createSalesRecords','username','YYYY-MM-DD','userBalanceEntity','user','useModel3Token','PAYMENT_REQUIRED','memberModel4Count','BalanceService','10SAmdbW','rechargeType','__decorate','查询用户账户信息失败！','14782280syaaDS','当前套餐不存在！','addBalanceToUser','then','addBalanceToNewUser','REG_GIFT','error:\x20','total','refundMjBalance','super','AccountLogEntity','object','expireDateCn','getOwnPropertyDescriptor','Logger','../user/user.entity','../crami/cramiPackage.entity','SalesService','configKey','model4Count','SalesUsersEntity','WhiteListEntity','memberDrawMjCount','queryUserBalanceByIds','saveCommissionAmount','globalConfigService','../../common/constants/balance.constant','sumModel4Count','firstRregisterSendDrawMjCount','>\x20或购买专属套餐\x20！','useDrawMjToken','cramiPackageEntity','CramiPackageEntity','./userBalance.entity','用户充值失败！','getRechargeLog','REFER_GIFT','inviteGiveSendDrawMjCount','salesService'];_0x2475=function(){return _0x1347f2;};return _0x2475();}UserBalanceService=__decorate([(0x0,common_1[_0x306c19(0x1bc)])(),__param(0x0,(0x0,typeorm_1[_0x306c19(0x1b1)])(balance_entity_1[_0x306c19(0x11e)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x306c19(0x1b3)])),__param(0x2,(0x0,typeorm_1[_0x306c19(0x1b1)])(accountLog_entity_1[_0x306c19(0x17b)])),__param(0x3,(0x0,typeorm_1[_0x306c19(0x1b1)])(cramiPackage_entity_1[_0x306c19(0x191)])),__param(0x4,(0x0,typeorm_1[_0x306c19(0x1b1)])(config_entity_1[_0x306c19(0x15a)])),__param(0x5,(0x0,typeorm_1[_0x306c19(0x1b1)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x306c19(0x185)])),__param(0x7,(0x0,typeorm_1[_0x306c19(0x1b1)])(whiteList_entity_1[_0x306c19(0x186)])),__metadata(_0x306c19(0x146),[typeorm_2[_0x306c19(0x15c)],typeorm_2[_0x306c19(0x15c)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x306c19(0x15c)],typeorm_2['Repository'],typeorm_2[_0x306c19(0x15c)],typeorm_2['Repository'],sales_service_1[_0x306c19(0x182)],globalConfig_service_1['GlobalConfigService']])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;