'use strict';const _0x21141b=_0x43c7;(function(_0x26b831,_0x2b6253){const _0x5af3ec=_0x43c7,_0x231fe0=_0x26b831();while(!![]){try{const _0x20fde8=parseInt(_0x5af3ec(0x25d))/0x1+parseInt(_0x5af3ec(0x294))/0x2*(-parseInt(_0x5af3ec(0x1b2))/0x3)+parseInt(_0x5af3ec(0x1da))/0x4+-parseInt(_0x5af3ec(0x22d))/0x5*(parseInt(_0x5af3ec(0x283))/0x6)+parseInt(_0x5af3ec(0x259))/0x7+-parseInt(_0x5af3ec(0x21b))/0x8+parseInt(_0x5af3ec(0x251))/0x9;if(_0x20fde8===_0x2b6253)break;else _0x231fe0['push'](_0x231fe0['shift']());}catch(_0x325c93){_0x231fe0['push'](_0x231fe0['shift']());}}}(_0x10b6,0xc8cef));var __decorate=this&&this['__decorate']||function(_0x1b76a4,_0x16ff25,_0xb83490,_0x5ce28a){const _0x30fcb4=_0x43c7;var _0xfbe11=arguments[_0x30fcb4(0x1e8)],_0x49574f=_0xfbe11<0x3?_0x16ff25:_0x5ce28a===null?_0x5ce28a=Object[_0x30fcb4(0x223)](_0x16ff25,_0xb83490):_0x5ce28a,_0x467a35;if(typeof Reflect===_0x30fcb4(0x1f2)&&typeof Reflect[_0x30fcb4(0x1c8)]===_0x30fcb4(0x270))_0x49574f=Reflect[_0x30fcb4(0x1c8)](_0x1b76a4,_0x16ff25,_0xb83490,_0x5ce28a);else{for(var _0x146074=_0x1b76a4[_0x30fcb4(0x1e8)]-0x1;_0x146074>=0x0;_0x146074--)if(_0x467a35=_0x1b76a4[_0x146074])_0x49574f=(_0xfbe11<0x3?_0x467a35(_0x49574f):_0xfbe11>0x3?_0x467a35(_0x16ff25,_0xb83490,_0x49574f):_0x467a35(_0x16ff25,_0xb83490))||_0x49574f;}return _0xfbe11>0x3&&_0x49574f&&Object['defineProperty'](_0x16ff25,_0xb83490,_0x49574f),_0x49574f;},__metadata=this&&this[_0x21141b(0x24a)]||function(_0xfbca3c,_0x40fee2){const _0x5e0b40=_0x21141b;if(typeof Reflect===_0x5e0b40(0x1f2)&&typeof Reflect[_0x5e0b40(0x222)]==='function')return Reflect[_0x5e0b40(0x222)](_0xfbca3c,_0x40fee2);},__param=this&&this[_0x21141b(0x1cd)]||function(_0x43be1b,_0x4da0f2){return function(_0x3d9537,_0x4e0aa5){_0x4da0f2(_0x3d9537,_0x4e0aa5,_0x43be1b);};};Object['defineProperty'](exports,_0x21141b(0x268),{'value':!![]}),exports[_0x21141b(0x243)]=void 0x0;const upload_service_1=require(_0x21141b(0x1bd)),user_service_1=require(_0x21141b(0x245)),nestjs_config_1=require('nestjs-config'),common_1=require(_0x21141b(0x1bf)),errorMessage_constant_1=require(_0x21141b(0x20e)),utils_1=require(_0x21141b(0x23d)),axios_1=require(_0x21141b(0x1d3)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x21141b(0x1a5)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require('uuid'),config_entity_1=require(_0x21141b(0x281)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x21141b(0x20a)),autoreply_service_1=require(_0x21141b(0x202)),gptkeys_entity_1=require(_0x21141b(0x1c9)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),whiteList_entity_1=require(_0x21141b(0x228)),user_entity_1=require(_0x21141b(0x1b5)),fanyi_service_1=require('../fanyi/fanyi.service'),dayjs=require(_0x21141b(0x23a)),app_entity_1=require(_0x21141b(0x1c3));let ChatgptService=class ChatgptService{constructor(_0x3e4874,_0x1b6784,_0x15fa25,_0x23119c,_0x7dc9f0,_0x19c65e,_0x5471f7,_0x44f738,_0x4414a7,_0x3279bc,_0x7b4c4e,_0x53790a,_0x1ea06b,_0x4187be){const _0x31954b=_0x21141b;this['userEntity']=_0x3e4874,this['gptKeysEntity']=_0x1b6784,this[_0x31954b(0x1f7)]=_0x15fa25,this[_0x31954b(0x217)]=_0x23119c,this[_0x31954b(0x1fa)]=_0x7dc9f0,this[_0x31954b(0x246)]=_0x19c65e,this['userBalanceService']=_0x5471f7,this[_0x31954b(0x1a4)]=_0x44f738,this[_0x31954b(0x213)]=_0x4414a7,this[_0x31954b(0x1dc)]=_0x3279bc,this[_0x31954b(0x1b6)]=_0x7b4c4e,this[_0x31954b(0x1ac)]=_0x53790a,this[_0x31954b(0x1a0)]=_0x1ea06b,this[_0x31954b(0x1d2)]=_0x4187be,this[_0x31954b(0x247)]=[],this[_0x31954b(0x28f)]={'list3':[],'list4':[]};}async[_0x21141b(0x1cf)](){const _0x47b796=_0x21141b;await this[_0x47b796(0x204)]();let _0x11cf53=await(0x0,utils_1['importDynamic'])(_0x47b796(0x232)),_0x3a6c94=await(0x0,utils_1[_0x47b796(0x218)])(_0x47b796(0x229)),_0x276725=await(0x0,utils_1['importDynamic'])('keyv');_0x11cf53=(_0x11cf53===null||_0x11cf53===void 0x0?void 0x0:_0x11cf53[_0x47b796(0x219)])?_0x11cf53['default']:_0x11cf53,_0x3a6c94=(_0x3a6c94===null||_0x3a6c94===void 0x0?void 0x0:_0x3a6c94['default'])?_0x3a6c94[_0x47b796(0x219)]:_0x3a6c94,_0x276725=(_0x276725===null||_0x276725===void 0x0?void 0x0:_0x276725[_0x47b796(0x219)])?_0x276725['default']:_0x276725;const {ChatGPTAPI:_0x2ab22a,ChatGPTError:_0x31db9e,ChatGPTUnofficialProxyAPI:_0x312e64}=_0x11cf53,_0x5a3be1=_0x47b796(0x1aa),_0x253227=+process[_0x47b796(0x210)][_0x47b796(0x25a)],_0xdb5069=process[_0x47b796(0x210)]['REDIS_HOST'],_0x2fba8b=process['env']['REDIS_PASSWORD'],_0x60495d=process[_0x47b796(0x210)][_0x47b796(0x28d)],_0x2eda48=_0x47b796(0x267)+(_0x60495d||'')+':'+(_0x2fba8b||'')+'@'+_0xdb5069+':'+_0x253227,_0x4b3f8d=new _0x3a6c94(_0x2eda48),_0x156708=new _0x276725({'store':_0x4b3f8d,'namespace':'nineai-chatlog'});this[_0x47b796(0x237)]=new _0x2ab22a({'apiKey':_0x47b796(0x272),'apiBaseUrl':_0x5a3be1+'/v1','messageStore':_0x156708});}async[_0x21141b(0x288)](_0x5ae450){const _0x9d29cc=_0x21141b,{list3:_0x262511,list4:_0x362619}=this['keyPool'];if(_0x262511[_0x9d29cc(0x1e8)]===0x0&&_0x362619['length']===0x0)throw new common_1['HttpException'](_0x9d29cc(0x215),common_1[_0x9d29cc(0x1f8)][_0x9d29cc(0x1f1)]);if(_0x5ae450===0x3){if(_0x262511['length']===0x0)throw new common_1[(_0x9d29cc(0x21c))](_0x9d29cc(0x26f),common_1[_0x9d29cc(0x1f8)][_0x9d29cc(0x1f1)]);return(0x0,utils_1['selectKeyWithWeight'])(_0x262511);}if(_0x5ae450===0x4){if(_0x362619[_0x9d29cc(0x1e8)]===0x0){const _0x19e5f4=await this[_0x9d29cc(0x1a0)][_0x9d29cc(0x1e5)]([_0x9d29cc(0x25e)]);if(Number(_0x19e5f4)!==0x1)throw new common_1[(_0x9d29cc(0x21c))](_0x9d29cc(0x19e),common_1[_0x9d29cc(0x1f8)]['BAD_REQUEST']);common_1['Logger'][_0x9d29cc(0x1c4)]('有4的权限但是卡池没有配置、降级为3的卡池');if(_0x262511[_0x9d29cc(0x1e8)]===0x0)throw new common_1[(_0x9d29cc(0x21c))]('未配置有效key、请先前往后台系统配置！',common_1[_0x9d29cc(0x1f8)][_0x9d29cc(0x1f1)]);else return(0x0,utils_1[_0x9d29cc(0x1e6)])(_0x262511);}else return(0x0,utils_1[_0x9d29cc(0x1e6)])(_0x362619);}}async['getGptParams'](_0x8afc73,_0x1ea0bb,_0x50f1ad){const _0x138722=_0x21141b,{parentMessageId:parentMessageId=0x0,temperature:temperature=0.5,top_p:_0x1f28a8,model:_0x258650=0x3}=_0x1ea0bb,_0xc7ab39=await this[_0x138722(0x1a3)](_0x8afc73,_0x258650),{openaiTimeoutMs:_0x5e927e}=_0xc7ab39,_0x371896=await this[_0x138722(0x1a0)]['getConfigs']([_0x138722(0x252)]),_0x121ba0=_0x5e927e||_0x371896||0x64*0x3e8,{model:_0x551e16,key:_0x348cd1}=_0xc7ab39,_0x26221f={'parentMessageId':parentMessageId,'timeoutMs':+_0x121ba0,'completionParams':{'model':_0x551e16,'temperature':temperature}};return _0x50f1ad&&(_0x26221f['systemMessage']=_0x50f1ad),{'options':_0x26221f,'detailKeyInfo':_0xc7ab39};}async[_0x21141b(0x208)](_0x36c00a,_0x2ad84d,_0x21de94){const _0x40adc7=_0x21141b;var _0x4ffa71,_0x252a35,_0x483b7b,_0x2c2d27,_0x185ffd;const _0x19df55=_0x2ad84d[_0x40adc7(0x1ee)],{options:options={},systemMessage:_0x39f566,appId:_0x487bdc,cusromPrompt:_0x1f12bf}=_0x36c00a,{prompt:_0x3fa50b}=_0x36c00a,{groupId:_0xc15399,temperature:temperature=0.5,usingNetwork:_0xd066e3}=options,{model:model=0x3}=options;await this[_0x40adc7(0x213)][_0x40adc7(0x282)](_0x2ad84d['user']['id']),await this[_0x40adc7(0x28b)][_0x40adc7(0x201)](_0x2ad84d[_0x40adc7(0x241)]['id'],(options===null||options===void 0x0?void 0x0:options[_0x40adc7(0x1db)])===0x4?'model4':_0x40adc7(0x234),0x1),_0x21de94&&_0x21de94['setHeader']('Content-type',_0x40adc7(0x207));if(await this[_0x40adc7(0x1b6)]['checkBadWords'](_0x3fa50b)){const _0x52fbbb={'message':_0x40adc7(0x1dd),'code':0x1f4};if(_0x21de94)return _0x21de94[_0x40adc7(0x225)](JSON[_0x40adc7(0x27e)](_0x52fbbb)),_0x21de94[_0x40adc7(0x24e)]();else throw new common_1['HttpException'](_0x52fbbb[_0x40adc7(0x1f4)],common_1[_0x40adc7(0x1f8)][_0x40adc7(0x1f1)]);}const _0x22b150=await this['autoreplyService']['checkAutoReply'](_0x3fa50b);if(_0x22b150&&_0x21de94){const _0x38e1f8={'message':_0x22b150,'code':0x1f4};return _0x21de94[_0x40adc7(0x225)](JSON[_0x40adc7(0x27e)](_0x38e1f8)),_0x21de94[_0x40adc7(0x24e)]();}let _0x1b2970=_0x39f566;if(_0x487bdc){const _0x146cac=await this[_0x40adc7(0x1fa)][_0x40adc7(0x22b)]({'where':{'id':_0x487bdc,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x146cac)throw new common_1[(_0x40adc7(0x21c))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x40adc7(0x1f8)][_0x40adc7(0x1f1)]);_0x146cac[_0x40adc7(0x22e)]&&(_0x1b2970=_0x146cac['preset']);}else{if(_0x1f12bf)_0x1b2970=_0x39f566;else{const _0x370733=new Date()[_0x40adc7(0x26b)]()[_0x40adc7(0x1ff)]('T')[0x0],_0x29ee98=await this['globalConfigService']['getConfigs']([_0x40adc7(0x227)]);_0x1b2970=_0x29ee98+('\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'+_0x370733);}}let _0x5e1c6f='';if(_0xd066e3){_0x5e1c6f=await(0x0,utils_1[_0x40adc7(0x1cb)])(_0x3fa50b);const _0x48e7a8=new Date()[_0x40adc7(0x26b)]()[_0x40adc7(0x1ff)]('T')[0x0],_0x3dd72b=await this['globalConfigService'][_0x40adc7(0x1e5)]([_0x40adc7(0x227)]);_0x1b2970=_0x3dd72b+(_0x40adc7(0x285)+_0x48e7a8);}const _0x2990dd=await this[_0x40adc7(0x1ae)](_0x2ad84d['user']['id'],options,_0x1b2970),{options:_0x42459f,detailKeyInfo:_0x36b775}=_0x2990dd,{key:_0x2140a1,maxToken:_0x76c7f5,maxTokenRes:_0x17783e,proxyUrl:_0x5c3a9b}=await this['formatModelToken'](_0x36b775);this[_0x40adc7(0x237)][_0x40adc7(0x1d6)]=(0x0,utils_1[_0x40adc7(0x1a9)])(_0x2140a1),this[_0x40adc7(0x237)][_0x40adc7(0x26e)]=_0x5c3a9b+_0x40adc7(0x260),this[_0x40adc7(0x237)]['maxModelTokens']=_0x76c7f5,this['api']['maxResponseTokens']=_0x17783e,common_1[_0x40adc7(0x22a)][_0x40adc7(0x24b)](_0x36b775['model']+_0x40adc7(0x1e4)+_0x2ad84d[_0x40adc7(0x241)]['id']+_0x40adc7(0x286)+_0x76c7f5+_0x40adc7(0x1fe)+_0x17783e+'\x20',_0x40adc7(0x243)),_0x21de94&&_0x21de94[_0x40adc7(0x23e)](0xc8);let _0x5be1ce=null;try{if(_0x21de94){let _0x109ccd=null,_0x353641=![];_0x21de94['on'](_0x40adc7(0x287),async()=>{const _0x9f7c7a=_0x40adc7;var _0x153781,_0x5287b4,_0x14c8d9,_0xc19572;if(_0x353641)return;_0x19df55['abort']();const _0x3d7e6c=await this[_0x9f7c7a(0x237)][_0x9f7c7a(0x230)](_0x3fa50b)||0x0,_0x32f780=await this[_0x9f7c7a(0x237)][_0x9f7c7a(0x230)]((_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd[_0x9f7c7a(0x226)])||''),_0x5b8411=_0x3d7e6c+_0x32f780,_0x23d199=(0x0,utils_1[_0x9f7c7a(0x284)])(_0x2ad84d);await this[_0x9f7c7a(0x1a4)][_0x9f7c7a(0x233)]({'appId':_0x487bdc,'curIp':_0x23d199,'userId':_0x2ad84d['user']['id'],'type':balance_constant_1['DeductionKey'][_0x9f7c7a(0x1cc)],'prompt':_0x3fa50b,'answer':'','promptTokens':_0x3d7e6c,'completionTokens':0x0,'totalTokens':_0x3d7e6c,'model':(_0x153781=_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd['detail'])===null||_0x153781===void 0x0?void 0x0:_0x153781[_0x9f7c7a(0x1db)],'role':_0x9f7c7a(0x241),'groupId':_0xc15399,'requestOptions':JSON[_0x9f7c7a(0x27e)]({'options':null,'prompt':_0x3fa50b})}),await this[_0x9f7c7a(0x1a4)]['saveChatLog']({'appId':_0x487bdc,'curIp':_0x23d199,'userId':_0x2ad84d[_0x9f7c7a(0x241)]['id'],'type':balance_constant_1[_0x9f7c7a(0x264)][_0x9f7c7a(0x1cc)],'prompt':_0x3fa50b,'answer':_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd[_0x9f7c7a(0x226)],'promptTokens':_0x3d7e6c,'completionTokens':_0x32f780,'totalTokens':_0x5b8411,'model':(_0x5287b4=_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd[_0x9f7c7a(0x20f)])===null||_0x5287b4===void 0x0?void 0x0:_0x5287b4[_0x9f7c7a(0x1db)],'role':'assistant','groupId':_0xc15399,'requestOptions':JSON[_0x9f7c7a(0x27e)]({'options':{'model':(_0x14c8d9=_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd['detail'])===null||_0x14c8d9===void 0x0?void 0x0:_0x14c8d9['model'],'temperature':temperature},'prompt':_0x3fa50b}),'conversationOptions':JSON[_0x9f7c7a(0x27e)]({'conversationId':_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd[_0x9f7c7a(0x292)],'model':(_0xc19572=_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd[_0x9f7c7a(0x20f)])===null||_0xc19572===void 0x0?void 0x0:_0xc19572['model'],'parentMessageId':_0x109ccd===null||_0x109ccd===void 0x0?void 0x0:_0x109ccd['id'],'temperature':temperature})});let _0x42948f=0x3;[0x3,0x4][_0x9f7c7a(0x27a)](model)?_0x42948f=model:_0x42948f=model['includes'](0x4)?0x4:0x3,await this[_0x9f7c7a(0x28b)][_0x9f7c7a(0x1e3)](_0x2ad84d['user']['id'],_0x9f7c7a(0x1db)+_0x42948f,0x1,_0x5b8411);});let _0x30b16c=!![];_0x5be1ce=await this[_0x40adc7(0x237)][_0x40adc7(0x1d7)](_0xd066e3?_0x5e1c6f:_0x3fa50b,Object[_0x40adc7(0x1df)](Object['assign']({},_0x42459f),{'onProgress':_0x4c0898=>{const _0x430d52=_0x40adc7;_0x21de94[_0x430d52(0x225)](_0x30b16c?JSON[_0x430d52(0x27e)](_0x4c0898):'\x0a'+JSON[_0x430d52(0x27e)](_0x4c0898)),_0x30b16c=![],_0x109ccd=_0x4c0898;},'abortSignal':_0x19df55[_0x40adc7(0x1c0)]})),_0x353641=!![];}else _0x5be1ce=await this[_0x40adc7(0x237)][_0x40adc7(0x1d7)](_0xd066e3?_0x5e1c6f:_0x3fa50b,_0x42459f);const {prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=(_0x4ffa71=_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce[_0x40adc7(0x20f)])===null||_0x4ffa71===void 0x0?void 0x0:_0x4ffa71[_0x40adc7(0x212)];let _0x4c894a=0x3;[0x3,0x4][_0x40adc7(0x27a)](model)?_0x4c894a=model:_0x4c894a=model[_0x40adc7(0x27a)](0x4)?0x4:0x3;await this[_0x40adc7(0x28b)][_0x40adc7(0x1e3)](_0x2ad84d[_0x40adc7(0x241)]['id'],_0x40adc7(0x1db)+_0x4c894a,0x1,total_tokens);const _0x185e8d=(0x0,utils_1[_0x40adc7(0x284)])(_0x2ad84d);await this[_0x40adc7(0x1a4)]['saveChatLog']({'appId':_0x487bdc,'curIp':_0x185e8d,'userId':_0x2ad84d[_0x40adc7(0x241)]['id'],'type':balance_constant_1[_0x40adc7(0x264)][_0x40adc7(0x1cc)],'prompt':_0x3fa50b,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':prompt_tokens,'model':(_0x252a35=_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce[_0x40adc7(0x20f)])===null||_0x252a35===void 0x0?void 0x0:_0x252a35[_0x40adc7(0x1db)],'role':_0x40adc7(0x241),'groupId':_0xc15399,'requestOptions':JSON[_0x40adc7(0x27e)]({'options':null,'prompt':_0x3fa50b})}),await this[_0x40adc7(0x1a4)][_0x40adc7(0x233)]({'appId':_0x487bdc,'curIp':_0x185e8d,'userId':_0x2ad84d['user']['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x3fa50b,'answer':_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce[_0x40adc7(0x226)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':(_0x483b7b=_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce[_0x40adc7(0x20f)])===null||_0x483b7b===void 0x0?void 0x0:_0x483b7b['model'],'role':_0x40adc7(0x19d),'groupId':_0xc15399,'requestOptions':JSON[_0x40adc7(0x27e)]({'options':{'model':(_0x2c2d27=_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce[_0x40adc7(0x20f)])===null||_0x2c2d27===void 0x0?void 0x0:_0x2c2d27[_0x40adc7(0x1db)],'temperature':temperature},'prompt':_0x3fa50b}),'conversationOptions':JSON[_0x40adc7(0x27e)]({'conversationId':_0x5be1ce[_0x40adc7(0x292)],'model':(_0x185ffd=_0x5be1ce===null||_0x5be1ce===void 0x0?void 0x0:_0x5be1ce['detail'])===null||_0x185ffd===void 0x0?void 0x0:_0x185ffd[_0x40adc7(0x1db)],'parentMessageId':_0x5be1ce['id'],'temperature':temperature})}),common_1[_0x40adc7(0x22a)][_0x40adc7(0x24b)](_0x40adc7(0x1e1)+model+_0x40adc7(0x257)+_0x2140a1,_0x40adc7(0x243));const _0x32b6ec=await this[_0x40adc7(0x28b)][_0x40adc7(0x271)](_0x2ad84d['user']['id']);return _0x5be1ce[_0x40adc7(0x20f)][_0x40adc7(0x1d9)]=Object[_0x40adc7(0x1df)]({},_0x32b6ec),_0x21de94?_0x21de94[_0x40adc7(0x225)]('\x0a'+JSON[_0x40adc7(0x27e)](_0x5be1ce)):_0x5be1ce[_0x40adc7(0x226)];}catch(_0x5ebf21){console[_0x40adc7(0x250)](_0x40adc7(0x238),_0x5ebf21);const _0x47b8d6=_0x5ebf21[_0x40adc7(0x255)];if(_0x5ebf21[_0x40adc7(0x23e)]&&_0x5ebf21[_0x40adc7(0x23e)]===0x192){const _0xd6c28f={'message':_0x5ebf21[_0x40adc7(0x1f4)],'code':0x192};if(_0x21de94)return _0x21de94[_0x40adc7(0x225)](JSON[_0x40adc7(0x27e)](_0xd6c28f));else throw new common_1[(_0x40adc7(0x21c))](_0x5ebf21[_0x40adc7(0x1f4)],common_1[_0x40adc7(0x1f8)][_0x40adc7(0x1f5)]);}if(!_0x47b8d6){if(_0x21de94)return _0x21de94[_0x40adc7(0x225)](JSON[_0x40adc7(0x27e)]({'message':_0x5ebf21['message'],'code':0x1f4}));else throw new common_1[(_0x40adc7(0x21c))](_0x5ebf21['message'],common_1[_0x40adc7(0x1f8)]['BAD_REQUEST']);}(_0x5ebf21===null||_0x5ebf21===void 0x0?void 0x0:_0x5ebf21['statusCode'])===0x1ad&&_0x5ebf21['message'][_0x40adc7(0x27a)](_0x40adc7(0x28c))&&await this['lockKey'](_0x2140a1);_0x47b8d6===0x190&&console[_0x40adc7(0x250)]('上下文过长错误！！！！',_0x5ebf21,_0x5ebf21[_0x40adc7(0x1f4)]);const _0x14ee8=errorMessage_constant_1[_0x40adc7(0x254)][_0x47b8d6]?errorMessage_constant_1[_0x40adc7(0x254)][_0x47b8d6]:_0x40adc7(0x214),_0x37e539={'message':_0x14ee8||_0x40adc7(0x26a),'code':_0x47b8d6===0x191?0x190:_0x47b8d6||0x1f4};if(_0x21de94)return _0x21de94[_0x40adc7(0x225)](JSON[_0x40adc7(0x27e)](_0x37e539));else throw new common_1[(_0x40adc7(0x21c))](_0x37e539['message'],common_1[_0x40adc7(0x1f8)][_0x40adc7(0x1f1)]);}finally{_0x21de94&&_0x21de94[_0x40adc7(0x24e)]();}}async['draw'](_0x583a5a,_0x38191d){const _0x2ec6d5=_0x21141b;var _0x553dac,_0x408b93,_0x167bf5,_0x13d061;if(await this['badwordsService'][_0x2ec6d5(0x275)](_0x583a5a[_0x2ec6d5(0x28a)]))throw new common_1[(_0x2ec6d5(0x21c))](_0x2ec6d5(0x266),common_1[_0x2ec6d5(0x1f8)]['BAD_REQUEST']);common_1['Logger'][_0x2ec6d5(0x250)](_0x2ec6d5(0x224)+_0x583a5a[_0x2ec6d5(0x28a)],_0x2ec6d5(0x21a)),await this['userService']['checkUserStatus'](_0x38191d['user']['id']),await this['userBalanceService'][_0x2ec6d5(0x201)](_0x38191d[_0x2ec6d5(0x241)]['id'],balance_constant_1[_0x2ec6d5(0x264)][_0x2ec6d5(0x277)],_0x583a5a['n']||0x1);const _0x1d7176=await this['globalConfigService']['getConfigs']([_0x2ec6d5(0x216)])||_0x2ec6d5(0x1aa),_0x45d212=_0x1d7176+_0x2ec6d5(0x23c);let _0x3fdc70=[];const _0x406f4a=await this[_0x2ec6d5(0x288)](0x3),{key:_0x2495de}=_0x406f4a;try{const _0x2cc032=await axios_1[_0x2ec6d5(0x219)][_0x2ec6d5(0x1ba)](_0x45d212,Object['assign'](Object['assign']({},_0x583a5a),{'response_format':'b64_json'}),{'headers':{'Authorization':'Bearer\x20'+_0x2495de}});_0x3fdc70=_0x2cc032[_0x2ec6d5(0x19f)][_0x2ec6d5(0x19f)];}catch(_0x3b020e){console[_0x2ec6d5(0x250)](_0x2ec6d5(0x1e0),_0x3b020e);const _0x4ab971=((_0x553dac=_0x3b020e===null||_0x3b020e===void 0x0?void 0x0:_0x3b020e[_0x2ec6d5(0x1a2)])===null||_0x553dac===void 0x0?void 0x0:_0x553dac[_0x2ec6d5(0x23e)])||0x1f4,_0x51efb6=(_0x13d061=(_0x167bf5=(_0x408b93=_0x3b020e===null||_0x3b020e===void 0x0?void 0x0:_0x3b020e['response'])===null||_0x408b93===void 0x0?void 0x0:_0x408b93[_0x2ec6d5(0x19f)])===null||_0x167bf5===void 0x0?void 0x0:_0x167bf5[_0x2ec6d5(0x1c4)])===null||_0x13d061===void 0x0?void 0x0:_0x13d061[_0x2ec6d5(0x1f4)];if(_0x4ab971===0x1ad)throw new common_1[(_0x2ec6d5(0x21c))](_0x2ec6d5(0x1be),common_1[_0x2ec6d5(0x1f8)][_0x2ec6d5(0x1f1)]);if(_0x4ab971===0x190||_0x51efb6[_0x2ec6d5(0x27a)](_0x2ec6d5(0x1f6)))throw new common_1[(_0x2ec6d5(0x21c))](_0x2ec6d5(0x1ea),common_1[_0x2ec6d5(0x1f8)][_0x2ec6d5(0x1f1)]);if(_0x4ab971===0x1f4)throw new common_1[(_0x2ec6d5(0x21c))](_0x2ec6d5(0x20c),common_1['HttpStatus'][_0x2ec6d5(0x1f1)]);if(_0x4ab971===0x191)throw new common_1[(_0x2ec6d5(0x21c))](_0x2ec6d5(0x27b),common_1['HttpStatus']['BAD_REQUEST']);throw new common_1[(_0x2ec6d5(0x21c))]('绘制图片失败，请稍后试试吧！',common_1[_0x2ec6d5(0x1f8)][_0x2ec6d5(0x1f1)]);}const _0x2995dc=[];for(const _0x3f9939 of _0x3fdc70){const _0x5a729b=uuid['v4']()['slice'](0x0,0xa)+_0x2ec6d5(0x279),_0x392de0=Buffer[_0x2ec6d5(0x289)](_0x3f9939['b64_json'],_0x2ec6d5(0x27d));_0x2995dc[_0x2ec6d5(0x1c6)](this[_0x2ec6d5(0x1dc)][_0x2ec6d5(0x20d)]({'filename':_0x5a729b,'buffer':_0x392de0}));}const _0xb58ee4=await Promise[_0x2ec6d5(0x239)](_0x2995dc);await this[_0x2ec6d5(0x28b)]['deductFromBalance'](_0x38191d[_0x2ec6d5(0x241)]['id'],_0x2ec6d5(0x234),_0x583a5a['n'],_0x583a5a['n']||0x1);const _0x1c5a00=(0x0,utils_1[_0x2ec6d5(0x284)])(_0x38191d),_0x520f63=[],_0x16b9b5=await this[_0x2ec6d5(0x1dc)][_0x2ec6d5(0x269)](),[_0x143ac,_0x3901a4]=_0x583a5a[_0x2ec6d5(0x21d)][_0x2ec6d5(0x1ff)]('x');return _0xb58ee4['forEach'](_0x5c3b45=>{const _0x20deec=_0x2ec6d5;_0x520f63[_0x20deec(0x1c6)](this[_0x20deec(0x1a4)][_0x20deec(0x233)]({'curIp':_0x1c5a00,'userId':_0x38191d['user']['id'],'type':balance_constant_1[_0x20deec(0x264)]['PAINT_TYPE'],'prompt':_0x583a5a[_0x20deec(0x28a)],'answer':_0x5c3b45,'fileInfo':JSON[_0x20deec(0x27e)]({'cosType':_0x16b9b5,'width':_0x143ac,'height':_0x3901a4,'cosUrl':_0x5c3b45}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x20deec(0x231)}));}),await Promise[_0x2ec6d5(0x239)](_0x520f63),_0xb58ee4;}async[_0x21141b(0x28e)](_0x3f28f){const _0xdf4b5a=_0x21141b;var _0x2c336a;const _0x293a70=await this[_0xdf4b5a(0x1a0)][_0xdf4b5a(0x1e5)]([_0xdf4b5a(0x216)])||_0xdf4b5a(0x1aa),_0x386e41=_0x293a70;try{const _0x381eba={'Content-Type':_0xdf4b5a(0x1a7),'Authorization':_0xdf4b5a(0x1b7)+_0x3f28f},_0x2232de=dayjs()['format'](_0xdf4b5a(0x221)),_0x82a64b=dayjs()['subtract'](0x63,_0xdf4b5a(0x249))[_0xdf4b5a(0x200)](_0xdf4b5a(0x221)),_0xa8b4d7=await axios_1[_0xdf4b5a(0x219)]['get'](_0x386e41+_0xdf4b5a(0x280)+_0x82a64b+'&end_date='+_0x2232de,{'headers':_0x381eba}),_0x4f8162=(_0x2c336a=_0xa8b4d7===null||_0xa8b4d7===void 0x0?void 0x0:_0xa8b4d7['data']['total_usage'])!==null&&_0x2c336a!==void 0x0?_0x2c336a:0x0,_0x222b82=await axios_1[_0xdf4b5a(0x219)][_0xdf4b5a(0x20b)](_0x386e41+_0xdf4b5a(0x274),{'headers':_0x381eba}),{has_payment_method:_0x855fa1,hard_limit_usd:_0x23fb7a,access_until:_0x53af57}=_0x222b82['data'],_0xcf0159=(_0x4f8162/0x64)[_0xdf4b5a(0x1b0)](0x2),_0x36230d=Number(_0x23fb7a)[_0xdf4b5a(0x1b0)](0x0);return{'totalAmount':_0x36230d+'$','useAmount':_0xcf0159+'$','balance':(Number(_0x36230d)-Number(_0xcf0159))[_0xdf4b5a(0x1b0)](0x2)+'$','isBindCard':_0x855fa1,'expirDate':dayjs(_0x53af57*0x3e8)[_0xdf4b5a(0x200)](_0xdf4b5a(0x1ab)),'status':0x1};}catch(_0xa2a213){return{'status':-0x1};}}async[_0x21141b(0x1a3)](_0x109270,_0xb76987){const _0x393ea8=_0x21141b;let _0x495020={};_0xb76987===0x3?_0x495020=await this[_0x393ea8(0x288)](0x3):_0x495020=await this[_0x393ea8(0x288)](0x4);const {model:_0x147e39,key:_0x426355,id:_0x2eaa8a}=_0x495020;return await this[_0x393ea8(0x1e9)]['createQueryBuilder']()[_0x393ea8(0x273)](gptkeys_entity_1[_0x393ea8(0x1ca)])['set']({'useCount':()=>_0x393ea8(0x1d0)})[_0x393ea8(0x206)]('id\x20=\x20:id',{'id':_0x2eaa8a})[_0x393ea8(0x1b4)](),_0x495020;}async['getGptModelList'](_0x494d35){const _0x481d1a=_0x21141b,_0x4e39a7=await this[_0x481d1a(0x1a0)]['getConfigs']([_0x481d1a(0x216)])||_0x481d1a(0x1aa),_0x448d8b=_0x4e39a7+_0x481d1a(0x1ed);try{const _0x4fd75=await axios_1[_0x481d1a(0x219)][_0x481d1a(0x20b)](_0x448d8b,{'headers':{'Authorization':_0x481d1a(0x1b7)+_0x494d35}}),_0xc39930=_0x4fd75[_0x481d1a(0x19f)][_0x481d1a(0x19f)][_0x481d1a(0x290)](_0x3cf325=>_0x3cf325['id']),_0x369d48=[_0x481d1a(0x244),'gpt-4-0314',_0x481d1a(0x1ad),_0x481d1a(0x1e2),_0x481d1a(0x220),'gpt-3.5-turbo-16k-0613',_0x481d1a(0x263),_0x481d1a(0x1bb),'ada',_0x481d1a(0x261)],_0x46412e=_0x369d48['filter'](_0x4a55f0=>_0xc39930[_0x481d1a(0x27a)](_0x4a55f0));return _0x46412e;}catch(_0xae5f31){throw new common_1[(_0x481d1a(0x21c))](_0x481d1a(0x256),common_1['HttpStatus'][_0x481d1a(0x1f1)]);}}async[_0x21141b(0x1ce)](_0x1a2966,_0x1b2713){const _0x3edc94=_0x21141b;try{const _0x230cc3={},{page:page=0x1,size:size=0xa,key:_0xd88bf2,status:_0x547350,keyStatus:_0x5927aa,model:_0x331f8}=_0x1a2966;_0xd88bf2&&(_0x230cc3[_0x3edc94(0x253)]=(0x0,typeorm_1[_0x3edc94(0x25c)])('%'+_0xd88bf2+'%')),_0x5927aa&&(_0x230cc3['keyStatus']=_0x5927aa),_0x331f8&&(_0x230cc3[_0x3edc94(0x1db)]=_0x331f8),[0x0,0x1,'0','1','-1',-0x1][_0x3edc94(0x27a)](_0x547350)&&(_0x230cc3[_0x3edc94(0x23e)]=_0x547350);const [_0x1ea6be,_0x363fb7]=await this[_0x3edc94(0x1e9)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x230cc3,'order':{'id':_0x3edc94(0x1d8)}}),_0x28edb9=[];_0x1ea6be[_0x3edc94(0x25f)](_0x36a151=>_0x28edb9['push'](this[_0x3edc94(0x28e)](_0x36a151['key'])));const _0x29e796=await Promise['all'](_0x28edb9);return _0x1ea6be['forEach']((_0x58bb9b,_0x4a6e86)=>_0x58bb9b[_0x3edc94(0x209)]=_0x29e796[_0x4a6e86]),_0x1b2713[_0x3edc94(0x241)][_0x3edc94(0x24c)]!==_0x3edc94(0x1d5)&&_0x1ea6be[_0x3edc94(0x25f)](_0x47b3fe=>{const _0x1ffb69=_0x3edc94;_0x47b3fe['key']=_0x47b3fe['key']?(0x0,utils_1[_0x1ffb69(0x1d1)])(_0x47b3fe[_0x1ffb69(0x253)]):'',_0x47b3fe[_0x1ffb69(0x1f0)]=_0x47b3fe['openaiProxyUrl']?(0x0,utils_1[_0x1ffb69(0x1d1)])(_0x47b3fe[_0x1ffb69(0x1f0)]):'';}),{'rows':_0x1ea6be,'count':_0x363fb7};}catch(_0x181ae7){console['log'](_0x3edc94(0x25b),_0x181ae7);throw new common_1[(_0x3edc94(0x21c))](_0x3edc94(0x1b3),common_1['HttpStatus'][_0x3edc94(0x1f1)]);}}async[_0x21141b(0x1eb)](_0x487a92){const _0x2b7c54=_0x21141b,{key:_0x217a3b}=_0x487a92,_0x4d4a54=await this[_0x2b7c54(0x1e9)]['findOne']({'where':{'key':_0x217a3b}});if(_0x4d4a54)throw new common_1[(_0x2b7c54(0x21c))]('key已存在',common_1['HttpStatus']['BAD_REQUEST']);const _0x7d9cc8=await this['gptKeysEntity'][_0x2b7c54(0x1a6)](_0x487a92);return await this[_0x2b7c54(0x204)](),_0x7d9cc8;}async['bulkCreateKey'](_0x1cc3c3){const _0x3c18c8=_0x21141b,{keyList:_0x4c5df0}=_0x1cc3c3,_0x161c0d=await this[_0x3c18c8(0x1e9)][_0x3c18c8(0x24d)]({'where':{'key':(0x0,typeorm_1['In'])(_0x4c5df0)}}),_0x333968=_0x161c0d['map'](_0x1ae13b=>_0x1ae13b[_0x3c18c8(0x253)]),_0x259964=_0x4c5df0['filter'](_0x48f1c8=>!_0x333968[_0x3c18c8(0x27a)](_0x48f1c8)),_0x4076bf=_0x259964['map'](_0x33adac=>{const _0x2076eb=_0x3c18c8;return{'key':_0x33adac,'status':0x1,'model':_0x2076eb(0x22c)};}),_0x3dd9e2=await this[_0x3c18c8(0x1e9)][_0x3c18c8(0x1a6)](_0x4076bf);let _0x36739f=_0x3c18c8(0x242)+_0x4076bf[_0x3c18c8(0x1e8)]+_0x3c18c8(0x1a1);return _0x333968['length']&&(_0x36739f+=_0x3c18c8(0x1c7)+_0x333968[_0x3c18c8(0x1e8)]+'个已被排除！'),_0x36739f;}async['updateKey'](_0x51a40d){const _0x2a4d2a=_0x21141b,{id:_0x4fd947}=_0x51a40d,_0x5d1343=await this['gptKeysEntity'][_0x2a4d2a(0x22b)]({'where':{'id':_0x4fd947}});if(!_0x5d1343)throw new common_1[(_0x2a4d2a(0x21c))](_0x2a4d2a(0x278),common_1['HttpStatus']['BAD_REQUEST']);const _0x22e857=await this[_0x2a4d2a(0x1e9)][_0x2a4d2a(0x273)]({'id':_0x4fd947},_0x51a40d);if(_0x22e857[_0x2a4d2a(0x265)]>0x0)return await this[_0x2a4d2a(0x204)](),_0x2a4d2a(0x262);else throw new common_1['HttpException'](_0x2a4d2a(0x1de),common_1[_0x2a4d2a(0x1f8)][_0x2a4d2a(0x1f1)]);}async[_0x21141b(0x205)](_0x2e8258){const _0x1d6d22=_0x21141b,{id:_0x5d20fe}=_0x2e8258,_0x33b851=await this[_0x1d6d22(0x1e9)][_0x1d6d22(0x22b)]({'where':{'id':_0x5d20fe}});if(!_0x33b851)throw new common_1[(_0x1d6d22(0x21c))](_0x1d6d22(0x278),common_1['HttpStatus'][_0x1d6d22(0x1f1)]);const _0x35fa37=await this[_0x1d6d22(0x1e9)][_0x1d6d22(0x1f9)]({'id':_0x5d20fe});if(_0x35fa37[_0x1d6d22(0x265)]>0x0)return await this[_0x1d6d22(0x204)](),_0x1d6d22(0x1b1);else throw new common_1['HttpException'](_0x1d6d22(0x26c),common_1['HttpStatus'][_0x1d6d22(0x1f1)]);}async[_0x21141b(0x204)](){const _0x1e6cbe=_0x21141b,_0x48b297=await this[_0x1e6cbe(0x1e9)]['find']({'where':{'status':0x1},'select':['id',_0x1e6cbe(0x253),_0x1e6cbe(0x1fd),_0x1e6cbe(0x1db),_0x1e6cbe(0x258),_0x1e6cbe(0x240),'openaiProxyUrl',_0x1e6cbe(0x252)]}),_0x5aeb8d=_0x48b297['filter'](_0x3fa766=>_0x3fa766[_0x1e6cbe(0x1db)][_0x1e6cbe(0x27a)]('gpt-3')),_0x9557e8=_0x48b297[_0x1e6cbe(0x1bc)](_0x1bfab2=>_0x1bfab2[_0x1e6cbe(0x1db)][_0x1e6cbe(0x27a)]('gpt-4'));this[_0x1e6cbe(0x28f)]={'list3':_0x5aeb8d,'list4':_0x9557e8};}async['getUserWhiteList'](){const _0x5ac957=_0x21141b,_0x315bee=await this['whiteListEntity']['find']({'where':{'status':0x1,'count':(0x0,typeorm_1[_0x5ac957(0x236)])(0x0)},'select':['userId']});this[_0x5ac957(0x247)]=_0x315bee[_0x5ac957(0x290)](_0x414265=>_0x414265['userId']);}async['addWhiteUser'](_0x458f33){const _0x4a5628=_0x21141b,{userId:_0x31a63e,count:_0x1ea804}=_0x458f33,_0x333d2f=await this[_0x4a5628(0x217)][_0x4a5628(0x22b)]({'where':{'userId':_0x31a63e}});if(_0x333d2f)throw new common_1[(_0x4a5628(0x21c))](_0x4a5628(0x291),common_1[_0x4a5628(0x1f8)][_0x4a5628(0x1f1)]);const _0x98815a=await this[_0x4a5628(0x217)][_0x4a5628(0x1a6)](_0x458f33);return await this[_0x4a5628(0x203)](),_0x98815a;}async['updateWhiteUser'](_0x5f3d9b){const _0x19820b=_0x21141b,{id:_0x349ad6}=_0x5f3d9b,_0xec77ed=await this[_0x19820b(0x217)][_0x19820b(0x22b)]({'where':{'id':_0x349ad6}});if(!_0xec77ed)throw new common_1[(_0x19820b(0x21c))](_0x19820b(0x23f),common_1[_0x19820b(0x1f8)][_0x19820b(0x1f1)]);const _0x43e8c3=await this[_0x19820b(0x217)][_0x19820b(0x273)]({'id':_0x349ad6},_0x5f3d9b);if(_0x43e8c3[_0x19820b(0x265)]>0x0)return await this[_0x19820b(0x203)](),_0x19820b(0x1e7);else throw new common_1['HttpException']('修改白名单失败',common_1['HttpStatus'][_0x19820b(0x1f1)]);}async[_0x21141b(0x1fb)](_0x237378,_0x286c0b){const _0x2e6cdc=_0x21141b,{page:page=0x1,size:size=0xa}=_0x237378,[_0x208bbc,_0x423cdb]=await this[_0x2e6cdc(0x217)][_0x2e6cdc(0x27f)]({'skip':(page-0x1)*size,'take':size,'order':{'id':'DESC'}}),_0x59e6a5=_0x208bbc['map'](_0x812260=>_0x812260[_0x2e6cdc(0x22f)]),_0x402185=await this['userEntity'][_0x2e6cdc(0x24d)]({'where':{'id':(0x0,typeorm_1['In'])(_0x59e6a5)}});return _0x208bbc[_0x2e6cdc(0x25f)](_0x2ff15b=>{const _0x11ff46=_0x2e6cdc;var _0x1efab2,_0x1f7cdc;const _0x1465cd=_0x402185[_0x11ff46(0x24d)](_0x45828f=>_0x45828f['id']===_0x2ff15b[_0x11ff46(0x22f)]);_0x2ff15b['username']=(_0x1efab2=_0x1465cd===null||_0x1465cd===void 0x0?void 0x0:_0x1465cd[_0x11ff46(0x21e)])!==null&&_0x1efab2!==void 0x0?_0x1efab2:'',_0x2ff15b[_0x11ff46(0x1c1)]=(_0x1f7cdc=_0x1465cd===null||_0x1465cd===void 0x0?void 0x0:_0x1465cd[_0x11ff46(0x1c1)])!==null&&_0x1f7cdc!==void 0x0?_0x1f7cdc:'';}),_0x286c0b['user'][_0x2e6cdc(0x24c)]!==_0x2e6cdc(0x1d5)&&_0x208bbc['forEach'](_0x5ec31e=>_0x5ec31e[_0x2e6cdc(0x1c1)]=(0x0,utils_1[_0x2e6cdc(0x1c5)])(_0x5ec31e[_0x2e6cdc(0x1c1)])),{'rows':_0x208bbc,'count':_0x423cdb};}async[_0x21141b(0x293)](_0x146ff3){const _0x252eaf=_0x21141b,_0x2b57a2=await this['gptKeysEntity'][_0x252eaf(0x273)]({'key':_0x146ff3},{'status':-0x1,'keyStatus':0x0});common_1[_0x252eaf(0x22a)][_0x252eaf(0x1c4)](_0x252eaf(0x1af)+_0x146ff3+'\x20欠费，已被系统自动锁定'),await this[_0x252eaf(0x204)]();}async['formatModelToken'](_0x1595c4){const _0x2018c6=_0x21141b,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this['globalConfigService'][_0x2018c6(0x1e5)]([_0x2018c6(0x1a8),'openaiModel3MaxTokensRes','openaiModel3MaxTokens16k',_0x2018c6(0x248),_0x2018c6(0x235),_0x2018c6(0x23b),_0x2018c6(0x1f3),'openaiModel4MaxTokens32kRes',_0x2018c6(0x216)]);let _0x4fa2ec=null,_0x4a8f5b=null,_0x4a8722=null;const {model:_0x721b63,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,openaiProxyUrl:openaiProxyUrl='',key:_0x520d4b}=_0x1595c4;return _0x721b63['toLowerCase']()[_0x2018c6(0x27a)](_0x2018c6(0x244))&&(_0x721b63['toLowerCase']()['includes']('32k')?(_0x4fa2ec=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x4a8f5b=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x4fa2ec=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x4a8f5b=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x721b63[_0x2018c6(0x1ef)]()[_0x2018c6(0x27a)]('gpt-3')&&(_0x721b63['toLowerCase']()[_0x2018c6(0x27a)](_0x2018c6(0x1b8))?(_0x4fa2ec=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x4a8f5b=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x4fa2ec=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x4a8f5b=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x4a8722=openaiProxyUrl||openaiBaseUrl||'https://api.openai.com',_0x4a8f5b>=_0x4fa2ec&&(_0x4a8f5b=Math['floor'](_0x4fa2ec/0x2),common_1[_0x2018c6(0x22a)][_0x2018c6(0x24b)]('key:\x20'+_0x520d4b+_0x2018c6(0x26d)+_0x4a8f5b)),{'key':_0x520d4b,'maxToken':_0x4fa2ec,'maxTokenRes':_0x4a8f5b,'proxyUrl':_0x4a8722};}};ChatgptService=__decorate([(0x0,common_1[_0x21141b(0x24f)])(),__param(0x0,(0x0,typeorm_2[_0x21141b(0x1b9)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_2[_0x21141b(0x1b9)])(gptkeys_entity_1[_0x21141b(0x1ca)])),__param(0x2,(0x0,typeorm_2[_0x21141b(0x1b9)])(config_entity_1[_0x21141b(0x21f)])),__param(0x3,(0x0,typeorm_2[_0x21141b(0x1b9)])(whiteList_entity_1[_0x21141b(0x276)])),__param(0x4,(0x0,typeorm_2[_0x21141b(0x1b9)])(app_entity_1['AppEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x21141b(0x211)],typeorm_1[_0x21141b(0x211)],typeorm_1['Repository'],typeorm_1[_0x21141b(0x211)],typeorm_1[_0x21141b(0x211)],nestjs_config_1[_0x21141b(0x1c2)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x21141b(0x1d4)],user_service_1[_0x21141b(0x1fc)],upload_service_1[_0x21141b(0x27c)],badwords_service_1[_0x21141b(0x1ec)],autoreply_service_1['AutoreplyService'],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService']])],ChatgptService),exports[_0x21141b(0x243)]=ChatgptService;function _0x43c7(_0x638e4b,_0x28bc13){const _0x10b69e=_0x10b6();return _0x43c7=function(_0x43c7a4,_0x44a508){_0x43c7a4=_0x43c7a4-0x19d;let _0x429e5=_0x10b69e[_0x43c7a4];return _0x429e5;},_0x43c7(_0x638e4b,_0x28bc13);}function _0x10b6(){const _0x3c74f3=['未配置有效key、请先前往后台系统配置！','openaiBaseUrl','whiteListEntity','importDynamic','default','DrawService','7520800gEzEjf','HttpException','size','username','ConfigEntity','gpt-3.5-turbo-0301','YYYY-MM-DD','metadata','getOwnPropertyDescriptor','draw\x20paompt\x20info\x20<======*******======>\x20','write','text','systemPreMessage','./whiteList.entity','@keyv/redis','Logger','findOne','gpt-3.5-turbo-16k-0613','1062095NSqNBP','preset','userId','getTokenCount','DALL-E2','chatgpt-nine-ai','saveChatLog','model3','openaiModel4MaxTokens','MoreThan','api','openai-error','all','dayjs','openaiModel4MaxTokensRes','/v1/images/generations','../../common/utils','status','当前记录不存在！','maxResponseTokens','user','本次成功添加','ChatgptService','gpt-4','./../user/user.service','configService','whiteListUser','openaiModel3MaxTokens16kRes','day','__metadata','debug','role','find','end','Injectable','log','13185954mXIcHf','openaiTimeoutMs','key','OpenAiErrorCodeMessage','statusCode','获取模型列表失败，请检查你的key是否正确！','\x20key\x20->\x20','maxModelTokens','10374651xtBLby','REDIS_PORT','error:\x20','Like','1060857hWozkv','openaiaAtoDowngrade','forEach','/v1','davinci','修改成功','gpt-3.5-turbo-16k','DeductionKey','affected','您的绘画描述词中含有不合规信息、请检查后重新提交！','redis://','__esModule','getUploadType','Please\x20check\x20the\x20back-end\x20console','toISOString','删除失败','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','apiBaseUrl','未配置[卡池3]的有效key、请先前往后台系统配置！','function','queryUserBalance','nine-ai-default-key','update','/v1/dashboard/billing/subscription','checkBadWords','WhiteListEntity','PAINT_TYPE','key不存在','.png','includes','绘制图片失败，此次绘画被拒绝了！','UploadService','base64','stringify','findAndCount','/v1/dashboard/billing/usage?start_date=','../globalConfig/config.entity','checkUserStatus','42iFRPLU','getClientIp','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','->\x20maxModelTokens:\x20','close','getRandomGptKeyDetail','from','prompt','userBalanceService','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','REDIS_USER','getKeyDetail','keyPool','map','用户已在白名单中！','conversationId','lockKey','3235978UhMLky','assistant','未配置[卡池4]的有效key、请先前往后台系统配置！','data','globalConfigService','个key','response','getModelAndKeyFromUser','chatLogService','../../common/constants/balance.constant','save','application/json','openaiModel3MaxTokens','removeSpecialCharacters','https://api.openai.com','YYYY年M月D日','autoreplyService','gpt-4-0613','getGptParams','key:\x20','toFixed','删除成功','3fLcSUt','查询key列表失败','execute','../user/user.entity','badwordsService','Bearer\x20','16k','InjectRepository','post','code-davinci-002','filter','./../upload/upload.service','当前请求已过载、请稍等会儿再试试吧！','@nestjs/common','signal','email','ConfigService','../app/app.entity','error','maskEmail','push','、重复key','decorate','./gptkeys.entity','GptKeysEntity','compileNetwork','CHAT_TYPE','__param','getKeyList','onModuleInit','useCount\x20+\x201','hideString','fanyiService','axios','ChatLogService','super','apiKey','sendMessage','DESC','userBanance','3437908CtauNT','model','uploadService','内容中含有敏感词汇、我们已对您的账号进行标记、多次违规将触发账号永久封禁、请注意您的言论！','修改失败','assign','openai-draw','本次使用的:\x20model:\x20','gpt-3.5-turbo','deductFromBalance','->userId\x20','getConfigs','selectKeyWithWeight','修改白名单成功','length','gptKeysEntity','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','addKey','BadwordsService','/v1/models','abortController','toLowerCase','openaiProxyUrl','BAD_REQUEST','object','openaiModel4MaxTokens32k','message','PAYMENT_REQUIRED','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','configEntity','HttpStatus','delete','appEntity','getWhiteListUser','UserService','weight','\x20maxResponseTokens:\x20','split','format','validateBalance','../autoreply/autoreply.service','getUserWhiteList','getAllKeyList','deleteKey','where','application/octet-stream;\x20charset=utf-8','chatProcess','keyDetail','../badwords/badwords.service','get','绘制图片失败，请检查你的提示词是否有非法描述！','uploadFile','../../common/constants/errorMessage.constant','detail','env','Repository','usage','userService','服务异常、请重新试试吧！！！'];_0x10b6=function(){return _0x3c74f3;};return _0x10b6();}