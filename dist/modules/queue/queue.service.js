'use strict';function _0x4194(){const _0xc12b7d=['__decorate','REGENERATE','ZOOM','decorate','mjDraw','jobIds','../../common/utils','MidjourneyService','getConfigs','getDrawActionDetail','3214315JVLilZ','design:paramtypes','addDrawQueue','defineProperty','MJDRAW','Logger','getQueue','InjectQueue','108342NatIIx','3410480VxOyvu','metadata','../../common/constants/midjourney.constant','onApplicationBootstrap','37343614mxNiXj','5464368THvyTv','assign','UPSCALE','mjDrawQueue','globalConfigService','add','cleanQueue','813156kxohRt','MidjourneyActionEnum','@nestjs/bull','HttpStatus','deductFromBalance','active','addMjDrawQueue','UserBalanceService','object','QueueService','DRAW','createRandomUid','checkLimit','validateBalance','3357516BElmsQ','userBalanceService','服务启动时清除所有之前未执行完毕的队列任务！','midjourneyService','__param','checkIsUpscale','length','user','push','../globalConfig/globalConfig.service','缺少必要参数！','../userBalance/userBalance.service','HttpException','mjTimeoutMs','VARY','debug','function'];_0x4194=function(){return _0xc12b7d;};return _0x4194();}const _0x495e82=_0x5e10;(function(_0x1e10d7,_0x4263dd){const _0x479cc8=_0x5e10,_0x3f933f=_0x1e10d7();while(!![]){try{const _0x28fca8=-parseInt(_0x479cc8(0x16d))/0x1+-parseInt(_0x479cc8(0x188))/0x2+-parseInt(_0x479cc8(0x17a))/0x3+-parseInt(_0x479cc8(0x16e))/0x4+-parseInt(_0x479cc8(0x165))/0x5+-parseInt(_0x479cc8(0x173))/0x6+parseInt(_0x479cc8(0x172))/0x7;if(_0x28fca8===_0x4263dd)break;else _0x3f933f['push'](_0x3f933f['shift']());}catch(_0x3a3eee){_0x3f933f['push'](_0x3f933f['shift']());}}}(_0x4194,0xd4827));var __decorate=this&&this[_0x495e82(0x199)]||function(_0x29d336,_0x1d1ffe,_0xc6ad4,_0x388e24){const _0x2d1882=_0x495e82;var _0x4243b6=arguments[_0x2d1882(0x18e)],_0x53350b=_0x4243b6<0x3?_0x1d1ffe:_0x388e24===null?_0x388e24=Object['getOwnPropertyDescriptor'](_0x1d1ffe,_0xc6ad4):_0x388e24,_0x2af46a;if(typeof Reflect==='object'&&typeof Reflect[_0x2d1882(0x19c)]===_0x2d1882(0x198))_0x53350b=Reflect['decorate'](_0x29d336,_0x1d1ffe,_0xc6ad4,_0x388e24);else{for(var _0xb05c21=_0x29d336[_0x2d1882(0x18e)]-0x1;_0xb05c21>=0x0;_0xb05c21--)if(_0x2af46a=_0x29d336[_0xb05c21])_0x53350b=(_0x4243b6<0x3?_0x2af46a(_0x53350b):_0x4243b6>0x3?_0x2af46a(_0x1d1ffe,_0xc6ad4,_0x53350b):_0x2af46a(_0x1d1ffe,_0xc6ad4))||_0x53350b;}return _0x4243b6>0x3&&_0x53350b&&Object[_0x2d1882(0x168)](_0x1d1ffe,_0xc6ad4,_0x53350b),_0x53350b;},__metadata=this&&this['__metadata']||function(_0x14e9d1,_0x3d31a0){const _0x1382b5=_0x495e82;if(typeof Reflect===_0x1382b5(0x182)&&typeof Reflect[_0x1382b5(0x16f)]==='function')return Reflect[_0x1382b5(0x16f)](_0x14e9d1,_0x3d31a0);},__param=this&&this[_0x495e82(0x18c)]||function(_0x3eb706,_0x3b2427){return function(_0x4ad855,_0x3aabc2){_0x3b2427(_0x4ad855,_0x3aabc2,_0x3eb706);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x495e82(0x183)]=void 0x0;const common_1=require('@nestjs/common'),bull_1=require(_0x495e82(0x17c)),utils_1=require(_0x495e82(0x161)),midjourney_service_1=require('../midjourney/midjourney.service'),midjourney_constant_1=require(_0x495e82(0x170)),userBalance_service_1=require(_0x495e82(0x193)),globalConfig_service_1=require(_0x495e82(0x191));let QueueService=class QueueService{constructor(_0x4193d7,_0x302f29,_0x68e104,_0x3eff1b){const _0x5dba7a=_0x495e82;this[_0x5dba7a(0x176)]=_0x4193d7,this['midjourneyService']=_0x302f29,this['userBalanceService']=_0x68e104,this['globalConfigService']=_0x3eff1b,this['jobIds']=[];}async[_0x495e82(0x171)](){const _0xbd928e=_0x495e82;common_1[_0xbd928e(0x16a)][_0xbd928e(0x197)](_0xbd928e(0x18a),'QueueService'),await this[_0xbd928e(0x176)]['clean'](0x0,_0xbd928e(0x17f)),await this[_0xbd928e(0x18b)][_0xbd928e(0x179)]();}async[_0x495e82(0x180)](_0x1589e2,_0xdbdbc0){const _0x5a25cd=_0x495e82,{prompt:_0x3a4dba,imgUrl:_0x344f40,extraParam:_0x248cd4,orderId:_0x4c17ac,action:action=0x1,drawId:_0x602ba8}=_0x1589e2;await this['midjourneyService'][_0x5a25cd(0x186)](_0xdbdbc0),await this[_0x5a25cd(0x189)][_0x5a25cd(0x187)](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),action===0x2?0x1:0x4);if(action===midjourney_constant_1[_0x5a25cd(0x17b)][_0x5a25cd(0x184)]||action===midjourney_constant_1[_0x5a25cd(0x17b)]['GENERATE']){const _0x297c10=''+(0x0,utils_1[_0x5a25cd(0x185)])(),_0x348c7e=Object[_0x5a25cd(0x174)](Object['assign']({},_0x1589e2),{'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id'],'randomDrawId':_0x297c10}),_0x24879d=await this[_0x5a25cd(0x18b)][_0x5a25cd(0x167)](_0x348c7e),_0x3999f0=await this['globalConfigService'][_0x5a25cd(0x163)]([_0x5a25cd(0x195)])||0x30d40,_0x23e1f9=await this[_0x5a25cd(0x176)]['add'](_0x5a25cd(0x15f),{'id':_0x24879d['id'],'action':_0x344f40?0x4:0x1,'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']},{'delay':0x3e8,'timeout':+_0x3999f0});return this['jobIds'][_0x5a25cd(0x190)](_0x23e1f9['id']),await this[_0x5a25cd(0x189)]['deductFromBalance'](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),0x4,0x4),!![];}if(!_0x602ba8||!_0x4c17ac)throw new common_1[(_0x5a25cd(0x194))](_0x5a25cd(0x192),common_1[_0x5a25cd(0x17d)]['BAD_REQUEST']);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x5a25cd(0x175)]){const _0x274805=await this[_0x5a25cd(0x18b)][_0x5a25cd(0x164)](action,_0x602ba8,_0x4c17ac),{custom_id:_0x5bfa6c}=_0x274805;await this[_0x5a25cd(0x18b)][_0x5a25cd(0x18d)](_0x5bfa6c);const _0x514ae1=Object[_0x5a25cd(0x174)](Object[_0x5a25cd(0x174)](Object[_0x5a25cd(0x174)]({},_0x1589e2),{'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']}),_0x274805),_0x4c7c2e=await this[_0x5a25cd(0x18b)]['addDrawQueue'](_0x514ae1),_0x1d2bef=await this[_0x5a25cd(0x177)]['getConfigs']([_0x5a25cd(0x195)])||0x30d40,_0x1df373=await this[_0x5a25cd(0x176)][_0x5a25cd(0x178)](_0x5a25cd(0x15f),{'id':_0x4c7c2e['id'],'action':action,'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']},{'delay':0x3e8,'timeout':+_0x1d2bef});await this['userBalanceService']['deductFromBalance'](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),0x1,0x1),this[_0x5a25cd(0x160)][_0x5a25cd(0x190)](_0x1df373['id']);return;}if(action===midjourney_constant_1['MidjourneyActionEnum']['VARIATION']){const _0x58c1fe=await this['midjourneyService'][_0x5a25cd(0x164)](action,_0x602ba8,_0x4c17ac),_0x3185e0=Object[_0x5a25cd(0x174)](Object[_0x5a25cd(0x174)](Object['assign']({},_0x1589e2),{'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']}),_0x58c1fe),_0x508706=await this['midjourneyService'][_0x5a25cd(0x167)](_0x3185e0),_0x13e95d=await this[_0x5a25cd(0x177)]['getConfigs']([_0x5a25cd(0x195)])||0x30d40,_0x3cef02=await this[_0x5a25cd(0x176)][_0x5a25cd(0x178)](_0x5a25cd(0x15f),{'id':_0x508706['id'],'action':action,'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']},{'delay':0x3e8,'timeout':+_0x13e95d});this['jobIds'][_0x5a25cd(0x190)](_0x3cef02['id']),await this[_0x5a25cd(0x189)][_0x5a25cd(0x17e)](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],'mjDraw',0x4,0x4);return;}if(action===midjourney_constant_1[_0x5a25cd(0x17b)][_0x5a25cd(0x19a)]){const _0x2977b9=await this[_0x5a25cd(0x18b)][_0x5a25cd(0x164)](action,_0x602ba8,_0x4c17ac),_0x20c0d7=Object[_0x5a25cd(0x174)](Object[_0x5a25cd(0x174)](Object['assign']({},_0x1589e2),{'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']}),_0x2977b9),_0x10f513=await this[_0x5a25cd(0x18b)][_0x5a25cd(0x167)](_0x20c0d7),_0x2e01e9=await this[_0x5a25cd(0x177)][_0x5a25cd(0x163)]([_0x5a25cd(0x195)])||0x30d40,_0x342d80=await this['mjDrawQueue']['add'](_0x5a25cd(0x15f),{'id':_0x10f513['id'],'action':action,'userId':_0xdbdbc0['user']['id']},{'delay':0x3e8,'timeout':+_0x2e01e9});this['jobIds'][_0x5a25cd(0x190)](_0x342d80['id']),await this['userBalanceService']['deductFromBalance'](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),0x4,0x4);return;}if(action===midjourney_constant_1[_0x5a25cd(0x17b)][_0x5a25cd(0x196)]){const _0x48cbbc=await this['midjourneyService'][_0x5a25cd(0x164)](action,_0x602ba8,_0x4c17ac),_0x256491=Object[_0x5a25cd(0x174)](Object[_0x5a25cd(0x174)](Object['assign']({},_0x1589e2),{'userId':_0xdbdbc0['user']['id']}),_0x48cbbc),_0x5254f1=await this['midjourneyService']['addDrawQueue'](_0x256491),_0x455107=await this[_0x5a25cd(0x177)]['getConfigs']([_0x5a25cd(0x195)])||0x30d40,_0x5d6718=await this['mjDrawQueue'][_0x5a25cd(0x178)](_0x5a25cd(0x15f),{'id':_0x5254f1['id'],'action':action,'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']},{'delay':0x3e8,'timeout':+_0x455107});this[_0x5a25cd(0x160)][_0x5a25cd(0x190)](_0x5d6718['id']),await this[_0x5a25cd(0x189)][_0x5a25cd(0x17e)](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),0x4,0x4);return;}if(action===midjourney_constant_1[_0x5a25cd(0x17b)][_0x5a25cd(0x19b)]){const _0x5b6789=await this[_0x5a25cd(0x18b)][_0x5a25cd(0x164)](action,_0x602ba8,_0x4c17ac),_0x1276ed=Object[_0x5a25cd(0x174)](Object['assign'](Object[_0x5a25cd(0x174)]({},_0x1589e2),{'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']}),_0x5b6789),_0x47d761=await this[_0x5a25cd(0x18b)]['addDrawQueue'](_0x1276ed),_0x474b69=await this[_0x5a25cd(0x177)][_0x5a25cd(0x163)]([_0x5a25cd(0x195)])||0x30d40,_0x2f896c=await this['mjDrawQueue'][_0x5a25cd(0x178)]('mjDraw',{'id':_0x47d761['id'],'action':action,'userId':_0xdbdbc0[_0x5a25cd(0x18f)]['id']},{'delay':0x3e8,'timeout':+_0x474b69});this[_0x5a25cd(0x160)][_0x5a25cd(0x190)](_0x2f896c['id']),await this['userBalanceService'][_0x5a25cd(0x17e)](_0xdbdbc0[_0x5a25cd(0x18f)]['id'],_0x5a25cd(0x15f),0x4,0x4);return;}}async[_0x495e82(0x16b)](){const _0xc518bb=_0x495e82;return{'jobIds':this[_0xc518bb(0x160)]};}};function _0x5e10(_0x4e1341,_0x37737e){const _0x419408=_0x4194();return _0x5e10=function(_0x5e10d9,_0x57c533){_0x5e10d9=_0x5e10d9-0x15f;let _0xad7db3=_0x419408[_0x5e10d9];return _0xad7db3;},_0x5e10(_0x4e1341,_0x37737e);}QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x495e82(0x16c)])(_0x495e82(0x169))),__metadata(_0x495e82(0x166),[Object,midjourney_service_1[_0x495e82(0x162)],userBalance_service_1[_0x495e82(0x181)],globalConfig_service_1['GlobalConfigService']])],QueueService),exports[_0x495e82(0x183)]=QueueService;