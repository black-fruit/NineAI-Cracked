'use strict';const _0x3579ba=_0x1b88;(function(_0x360556,_0x2b7307){const _0x5ad757=_0x1b88,_0x535e88=_0x360556();while(!![]){try{const _0x27dc10=parseInt(_0x5ad757(0xe8))/0x1*(-parseInt(_0x5ad757(0xff))/0x2)+parseInt(_0x5ad757(0xe9))/0x3+-parseInt(_0x5ad757(0xd5))/0x4*(parseInt(_0x5ad757(0xf0))/0x5)+-parseInt(_0x5ad757(0x102))/0x6+-parseInt(_0x5ad757(0xd8))/0x7+-parseInt(_0x5ad757(0xea))/0x8*(parseInt(_0x5ad757(0xed))/0x9)+parseInt(_0x5ad757(0xda))/0xa;if(_0x27dc10===_0x2b7307)break;else _0x535e88['push'](_0x535e88['shift']());}catch(_0x518013){_0x535e88['push'](_0x535e88['shift']());}}}(_0x1af9,0x47424));var __decorate=this&&this[_0x3579ba(0xf6)]||function(_0x393f05,_0x254502,_0x17487c,_0x46a49c){const _0x353155=_0x3579ba;var _0x5af803=arguments[_0x353155(0xef)],_0x403ee2=_0x5af803<0x3?_0x254502:_0x46a49c===null?_0x46a49c=Object[_0x353155(0x106)](_0x254502,_0x17487c):_0x46a49c,_0x37a630;if(typeof Reflect===_0x353155(0xfa)&&typeof Reflect[_0x353155(0xdc)]==='function')_0x403ee2=Reflect[_0x353155(0xdc)](_0x393f05,_0x254502,_0x17487c,_0x46a49c);else{for(var _0x31c487=_0x393f05[_0x353155(0xef)]-0x1;_0x31c487>=0x0;_0x31c487--)if(_0x37a630=_0x393f05[_0x31c487])_0x403ee2=(_0x5af803<0x3?_0x37a630(_0x403ee2):_0x5af803>0x3?_0x37a630(_0x254502,_0x17487c,_0x403ee2):_0x37a630(_0x254502,_0x17487c))||_0x403ee2;}return _0x5af803>0x3&&_0x403ee2&&Object[_0x353155(0xe1)](_0x254502,_0x17487c,_0x403ee2),_0x403ee2;},__metadata=this&&this['__metadata']||function(_0x28fab6,_0x5ca438){const _0x3aacb1=_0x3579ba;if(typeof Reflect===_0x3aacb1(0xfa)&&typeof Reflect[_0x3aacb1(0xd1)]==='function')return Reflect[_0x3aacb1(0xd1)](_0x28fab6,_0x5ca438);},__param=this&&this[_0x3579ba(0xd2)]||function(_0x1fac28,_0x3b445a){return function(_0x7a33a5,_0xadaaa8){_0x3b445a(_0x7a33a5,_0xadaaa8,_0x1fac28);};};Object[_0x3579ba(0xe1)](exports,'__esModule',{'value':!![]}),exports[_0x3579ba(0xf7)]=void 0x0;function _0x1b88(_0x32302f,_0x5a4b88){const _0x1af9a9=_0x1af9();return _0x1b88=function(_0x1b885b,_0x38f737){_0x1b885b=_0x1b885b-0xcc;let _0x211fa0=_0x1af9a9[_0x1b885b];return _0x211fa0;},_0x1b88(_0x32302f,_0x5a4b88);}const globalConfig_service_1=require(_0x3579ba(0xfd)),status_constant_1=require('./../../common/constants/status.constant'),typeorm_1=require(_0x3579ba(0xe2)),typeorm_2=require(_0x3579ba(0xe6)),verifycation_entity_1=require(_0x3579ba(0xcf)),common_1=require('@nestjs/common'),utils_1=require(_0x3579ba(0x107)),redisCache_service_1=require(_0x3579ba(0x108)),Core=require(_0x3579ba(0xf3));let VerificationService=class VerificationService{constructor(_0x3074c5,_0x119007,_0x464374){const _0x4ed669=_0x3579ba;this[_0x4ed669(0xf1)]=_0x3074c5,this[_0x4ed669(0xfb)]=_0x119007,this[_0x4ed669(0xfe)]=_0x464374;}async['createVerification'](_0x12331c,_0xf93bf5,_0x5ebb98=0x1e*0x3c){const _0xab8e6c=_0x3579ba,_0x4f7f0b=await this[_0xab8e6c(0xf1)][_0xab8e6c(0xf8)]({'where':{'userId':_0x12331c['id'],'type':_0xf93bf5},'order':{'createdAt':'DESC'}});if(_0x4f7f0b&&_0x4f7f0b[_0xab8e6c(0xd0)]['getTime']()+0x1*0x3c*0x3e8>Date['now']()){const _0x1cdf1f=Math[_0xab8e6c(0xeb)]((_0x4f7f0b[_0xab8e6c(0xd0)][_0xab8e6c(0xdf)]()+0x1*0x3c*0x3e8-Date[_0xab8e6c(0xdd)]())/0x3e8);throw new common_1[(_0xab8e6c(0xe5))](_0x1cdf1f+_0xab8e6c(0xe7),common_1['HttpStatus'][_0xab8e6c(0x10c)]);}const _0x41ee74=(0x0,utils_1['createRandomCode'])(),_0x28871b=new Date(Date[_0xab8e6c(0xdd)]()+_0x5ebb98*0x3e8),{id:_0x50a72c,email:_0x3d7be6}=_0x12331c,_0x4a0d34={'userId':_0x50a72c,'type':_0xf93bf5,'code':_0x41ee74,'expiresAt':_0x28871b,'email':_0x3d7be6};return await this['verifycationEntity']['save'](_0x4a0d34);}async[_0x3579ba(0xcd)]({code:_0x46c928,id:_0x207377},_0x1ad833){const _0x398da4=_0x3579ba,_0x2efe28=await this[_0x398da4(0xf1)][_0x398da4(0xf8)]({'where':{'id':_0x207377,'type':_0x1ad833},'order':{'createdAt':_0x398da4(0x101)}});if(!_0x2efe28)throw new common_1[(_0x398da4(0xe5))]('验证码不存在',common_1['HttpStatus'][_0x398da4(0x10c)]);if(_0x2efe28[_0x398da4(0xce)]===status_constant_1['VerificationUseStatusEnum']['USED'])throw new common_1[(_0x398da4(0xe5))]('当前验证码已被使用！',common_1[_0x398da4(0xf9)]['BAD_REQUEST']);else _0x2efe28[_0x398da4(0xce)]=status_constant_1[_0x398da4(0xdb)]['USED'],await this[_0x398da4(0xf1)]['update']({'id':_0x207377},_0x2efe28);if(Number(_0x2efe28[_0x398da4(0x100)])!==Number(_0x46c928))throw new common_1[(_0x398da4(0xe5))](_0x398da4(0xd6),common_1[_0x398da4(0xf9)][_0x398da4(0x10c)]);if(_0x2efe28['expiresAt']<new Date())throw new common_1['HttpException'](_0x398da4(0xd7),common_1[_0x398da4(0xf9)]['BAD_REQUEST']);return _0x2efe28;}async['verifyCaptcha'](_0x266ec3){const _0x4500aa=_0x3579ba,{captchaId:_0xd8980d,captchaCode:_0xffd17c}=_0x266ec3,_0x5c9085=await this[_0x4500aa(0xfb)][_0x4500aa(0xd4)](),_0x3b5162=_0x5c9085+_0x4500aa(0xec)+_0xd8980d,_0x1ffcf1=await this[_0x4500aa(0xfe)][_0x4500aa(0xe4)]({'key':_0x3b5162});await this['redisCacheService'][_0x4500aa(0x104)]({'key':_0x3b5162});if(!_0x1ffcf1)throw new common_1['HttpException'](_0x4500aa(0x10a),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x1ffcf1||_0x1ffcf1!==_0xffd17c)throw new common_1[(_0x4500aa(0xe5))]('图形验证码错误、请检查填写!',common_1[_0x4500aa(0xf9)][_0x4500aa(0x10c)]);}async[_0x3579ba(0x109)](_0x5b301d){const _0x154972=_0x3579ba;var _0x576087;const {accessKeyId:_0x458aba,accessKeySecret:_0x1f14fd,SignName:_0x33151c,TemplateCode:_0x2cb2b7}=await this['globalConfigService'][_0x154972(0xe0)](),{phone:_0xddc95e,code:_0x257488}=_0x5b301d;if(!_0xddc95e||!_0x257488)throw new common_1[(_0x154972(0xe5))]('确实必要参数错误！',common_1[_0x154972(0xf9)][_0x154972(0x10c)]);const _0x47ca4b=new Core({'accessKeyId':_0x458aba,'accessKeySecret':_0x1f14fd,'endpoint':_0x154972(0xee),'apiVersion':_0x154972(0xd3)}),_0x1403fe={'PhoneNumbers':_0xddc95e,'SignName':_0x33151c,'TemplateCode':_0x2cb2b7,'TemplateParam':JSON[_0x154972(0xde)]({'code':_0x257488})},_0x21a938={'method':_0x154972(0x103),'formatParams':![]};try{const _0x32de9a=await _0x47ca4b[_0x154972(0x105)]('SendSms',_0x1403fe,_0x21a938);if(_0x32de9a['Code']==='OK')return!![];else throw new common_1[(_0x154972(0xe5))](_0x32de9a[_0x154972(0xf2)]||'验证码发送失败！',common_1[_0x154972(0xf9)][_0x154972(0x10c)]);}catch(_0x1dc892){throw new common_1[(_0x154972(0xe5))](((_0x576087=_0x1dc892===null||_0x1dc892===void 0x0?void 0x0:_0x1dc892[_0x154972(0xd9)])===null||_0x576087===void 0x0?void 0x0:_0x576087['Message'])||_0x154972(0xfc),common_1[_0x154972(0xf9)][_0x154972(0x10c)]);}}};function _0x1af9(){const _0x4ef1de=['图形验证码已过期、请重新输入!','design:paramtypes','BAD_REQUEST','InjectRepository','GlobalConfigService','verifyCode','used','./verifycation.entity','createdAt','metadata','__param','2017-05-25','getNamespace','2185204TlXgrw','验证码错误','验证码已过期','2406215athFYo','data','16735460ivDlTp','VerificationUseStatusEnum','decorate','now','stringify','getTime','getPhoneVerifyConfig','defineProperty','@nestjs/typeorm','VerifycationEntity','get','HttpException','typeorm','S内不得重新发送','1fEJCyB','1208352MTIeYo','3082648rKueGU','ceil',':CAPTCHA:','9iUYUjz','https://dysmsapi.aliyuncs.com','length','5tSPsYM','verifycationEntity','Message','@alicloud/pop-core','Repository','RedisCacheService','__decorate','VerificationService','findOne','HttpStatus','object','globalConfigService','验证码发送失败！','../globalConfig/globalConfig.service','redisCacheService','988688OyXOCO','code','DESC','88398VZTjQM','POST','del','request','getOwnPropertyDescriptor','../../common/utils','../redisCache/redisCache.service','sendPhoneCode'];_0x1af9=function(){return _0x4ef1de;};return _0x1af9();}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3579ba(0x10d)])(verifycation_entity_1[_0x3579ba(0xe3)])),__metadata(_0x3579ba(0x10b),[typeorm_2[_0x3579ba(0xf4)],globalConfig_service_1[_0x3579ba(0xcc)],redisCache_service_1[_0x3579ba(0xf5)]])],VerificationService),exports[_0x3579ba(0xf7)]=VerificationService;