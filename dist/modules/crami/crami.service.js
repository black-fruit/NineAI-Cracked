'use strict';const _0x4068a8=_0x4265;(function(_0x44b7fb,_0x4e7cb7){const _0x43581c=_0x4265,_0x1e5f78=_0x44b7fb();while(!![]){try{const _0x44222f=parseInt(_0x43581c(0x97))/0x1+parseInt(_0x43581c(0xae))/0x2+-parseInt(_0x43581c(0x99))/0x3+parseInt(_0x43581c(0xbd))/0x4+-parseInt(_0x43581c(0xc1))/0x5+parseInt(_0x43581c(0x9c))/0x6*(-parseInt(_0x43581c(0x8f))/0x7)+parseInt(_0x43581c(0xac))/0x8;if(_0x44222f===_0x4e7cb7)break;else _0x1e5f78['push'](_0x1e5f78['shift']());}catch(_0x23871f){_0x1e5f78['push'](_0x1e5f78['shift']());}}}(_0xfa17,0x9e211));var __decorate=this&&this[_0x4068a8(0x7a)]||function(_0x2a3319,_0x21406e,_0x2f9171,_0x41ee97){const _0x50c9d7=_0x4068a8;var _0x3b5193=arguments['length'],_0xa675bb=_0x3b5193<0x3?_0x21406e:_0x41ee97===null?_0x41ee97=Object[_0x50c9d7(0x6a)](_0x21406e,_0x2f9171):_0x41ee97,_0x1de326;if(typeof Reflect===_0x50c9d7(0xa7)&&typeof Reflect['decorate']===_0x50c9d7(0x75))_0xa675bb=Reflect[_0x50c9d7(0xbe)](_0x2a3319,_0x21406e,_0x2f9171,_0x41ee97);else{for(var _0x1f98a7=_0x2a3319['length']-0x1;_0x1f98a7>=0x0;_0x1f98a7--)if(_0x1de326=_0x2a3319[_0x1f98a7])_0xa675bb=(_0x3b5193<0x3?_0x1de326(_0xa675bb):_0x3b5193>0x3?_0x1de326(_0x21406e,_0x2f9171,_0xa675bb):_0x1de326(_0x21406e,_0x2f9171))||_0xa675bb;}return _0x3b5193>0x3&&_0xa675bb&&Object[_0x50c9d7(0xc0)](_0x21406e,_0x2f9171,_0xa675bb),_0xa675bb;},__metadata=this&&this[_0x4068a8(0x93)]||function(_0x3b8c9d,_0x446ad6){const _0x34369f=_0x4068a8;if(typeof Reflect==='object'&&typeof Reflect[_0x34369f(0x8d)]===_0x34369f(0x75))return Reflect[_0x34369f(0x8d)](_0x3b8c9d,_0x446ad6);},__param=this&&this['__param']||function(_0x47d62e,_0x356736){return function(_0x402ecc,_0x39e725){_0x356736(_0x402ecc,_0x39e725,_0x47d62e);};};function _0x4265(_0x2946e4,_0x2c4558){const _0xfa177b=_0xfa17();return _0x4265=function(_0x4265fa,_0x4a015c){_0x4265fa=_0x4265fa-0x6a;let _0x234da4=_0xfa177b[_0x4265fa];return _0x234da4;},_0x4265(_0x2946e4,_0x2c4558);}Object[_0x4068a8(0xc0)](exports,_0x4068a8(0xaf),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require('./crami.entity'),typeorm_1=require(_0x4068a8(0x9d)),typeorm_2=require(_0x4068a8(0x7f)),cramiPackage_entity_1=require(_0x4068a8(0x84)),utils_1=require(_0x4068a8(0x9b)),user_entity_1=require(_0x4068a8(0xba)),userBalance_service_1=require(_0x4068a8(0x79)),balance_constant_1=require('../../common/constants/balance.constant');function _0xfa17(){const _0x2163a8=['当前卡密不存在、请确认您要删除的卡密是否存在！','Not','当前卡密已被使用、已使用的卡密禁止删除！','UserBalanceService','packageId','InjectRepository','code','../user/user.entity','every','MoreThan','535224ZVmHXh','decorate','delete','defineProperty','3989890hHerDV','error:\x20','BAD_REQUEST','删除卡密成功！','getOwnPropertyDescriptor','name','saveRecordRechargeLog','DESC','packageName','delCrami','update','save','HttpException','当前卡密不存在、请确认您输入的卡密是否正确！','HttpStatus','function','cramiPackageEntity','CramiEntity','username','../userBalance/userBalance.service','__decorate','maskEmail','UserEntity','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','queryAllPackage','typeorm','createCrami','batchDelCrami','updatePackage','CramiService','./cramiPackage.entity','userEntity','map','userBalanceService','email','findAndCount','LessThanOrEqual','forEach','status','metadata','super','154HgPprb','addBalanceToUser','count','useCrami','__metadata','findOne','design:paramtypes','当前套餐不存在、请确认您选择的套餐是否存在！','739604laHivI','Repository','530742VakHAn','user','../../common/utils','182022XROAbu','@nestjs/typeorm','maskCrami','find','assign','Injectable','generateCrami','role','CramiPackageEntity','当前卡密已被使用、请确认您输入的卡密是否正确！','cramiEntity','object','useId','queryAllCrami','套餐名称或套餐等级重复、请检查！','使用卡密成功','7446224OXPHMg','createPackage','971630EvKqUo','__esModule','Like','log','更新套餐失败、请重试！'];_0xfa17=function(){return _0x2163a8;};return _0xfa17();}let CramiService=class CramiService{constructor(_0x4ae562,_0x4dbdeb,_0x189642,_0x3f3fc2){this['cramiEntity']=_0x4ae562,this['cramiPackageEntity']=_0x4dbdeb,this['userEntity']=_0x189642,this['userBalanceService']=_0x3f3fc2;}async['queryOnePackage'](_0x44fe94){const _0x286ab4=_0x4068a8;return await this[_0x286ab4(0x76)][_0x286ab4(0x94)]({'where':{'id':_0x44fe94}});}async[_0x4068a8(0x7e)](_0x2c05ac){const _0x2e2d63=_0x4068a8;try{const {page:page=0x1,size:size=0xa,name:_0x652840,status:_0x4002b5,type:_0x56a621}=_0x2c05ac,_0x45807c={};_0x652840&&Object['assign'](_0x45807c,{'name':(0x0,typeorm_2[_0x2e2d63(0xb0)])('%'+_0x652840+'%')}),_0x4002b5&&Object[_0x2e2d63(0xa0)](_0x45807c,{'status':_0x4002b5});_0x56a621&&(_0x56a621>0x0?Object[_0x2e2d63(0xa0)](_0x45807c,{'days':(0x0,typeorm_2[_0x2e2d63(0xbc)])(0x0)}):Object['assign'](_0x45807c,{'days':(0x0,typeorm_2[_0x2e2d63(0x8a)])(0x0)}));const [_0x5eaab4,_0x3ef300]=await this[_0x2e2d63(0x76)][_0x2e2d63(0x89)]({'skip':(page-0x1)*size,'take':size,'where':_0x45807c,'order':{'order':_0x2e2d63(0x6d)}});return{'rows':_0x5eaab4,'count':_0x3ef300};}catch(_0x5bf184){console[_0x2e2d63(0xb1)]('error:\x20',_0x5bf184);}}async[_0x4068a8(0xad)](_0x2f89f3){const _0x186dfc=_0x4068a8,{name:_0x2b159b,weight:_0x120310}=_0x2f89f3,_0xf79f60=await this[_0x186dfc(0x76)][_0x186dfc(0x94)]({'where':[{'name':_0x2b159b},{'weight':_0x120310}]});if(_0xf79f60)throw new common_1[(_0x186dfc(0x72))](_0x186dfc(0xaa),common_1['HttpStatus'][_0x186dfc(0xc3)]);try{return await this[_0x186dfc(0x76)][_0x186dfc(0x71)](_0x2f89f3);}catch(_0x227c9d){console[_0x186dfc(0xb1)](_0x186dfc(0xc2),_0x227c9d);throw new common_1[(_0x186dfc(0x72))](_0x227c9d,common_1['HttpStatus'][_0x186dfc(0xc3)]);}}async[_0x4068a8(0x82)](_0x1535ce){const _0x4f981b=_0x4068a8,{id:_0x33d757,name:_0x18474c,weight:_0x19717b}=_0x1535ce,_0x54bf2f=await this[_0x4f981b(0x76)][_0x4f981b(0x94)]({'where':{'id':_0x33d757}});if(!_0x54bf2f)throw new common_1['HttpException']('当前套餐不存在、请检查你的输入参数！',common_1[_0x4f981b(0x74)][_0x4f981b(0xc3)]);const _0x34d69d=await this[_0x4f981b(0x76)][_0x4f981b(0x91)]({'where':[{'name':_0x18474c,'id':(0x0,typeorm_2[_0x4f981b(0xb4)])(_0x33d757)},{'weight':_0x19717b,'id':(0x0,typeorm_2[_0x4f981b(0xb4)])(_0x33d757)}]});if(_0x34d69d)throw new common_1[(_0x4f981b(0x72))](_0x4f981b(0xaa),common_1[_0x4f981b(0x74)][_0x4f981b(0xc3)]);const _0x2c7ff0=await this[_0x4f981b(0x76)][_0x4f981b(0x70)]({'id':_0x33d757},_0x1535ce);if(_0x2c7ff0['affected']>0x0)return'更新套餐成功！';else throw new common_1['HttpException'](_0x4f981b(0xb2),common_1[_0x4f981b(0x74)][_0x4f981b(0xc3)]);}async['delPackage'](_0x51d928){const _0x413840=_0x4068a8,{id:_0xe76be1}=_0x51d928,_0x9735ea=await this['cramiEntity']['count']({'where':{'packageId':_0xe76be1}});if(_0x9735ea)throw new common_1['HttpException'](_0x413840(0x7d),common_1[_0x413840(0x74)][_0x413840(0xc3)]);return await this[_0x413840(0x76)][_0x413840(0xbf)]({'id':_0xe76be1});}async[_0x4068a8(0x80)](_0x1b820f){const _0x32600e=_0x4068a8,{packageId:_0x1939d0,count:count=0x1}=_0x1b820f;if(_0x1939d0){const _0x2915a0=await this[_0x32600e(0x76)][_0x32600e(0x94)]({'where':{'id':_0x1939d0}});if(!_0x2915a0)throw new common_1[(_0x32600e(0x72))](_0x32600e(0x96),common_1['HttpStatus'][_0x32600e(0xc3)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2915a0,_0x4c89ce={'packageId':_0x1939d0,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x32600e(0xa2)](_0x4c89ce,count);}if(!_0x1939d0){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x1b820f;if([model3Count,model4Count,drawMjCount][_0x32600e(0xbb)](_0x2434e9=>!_0x2434e9))throw new common_1[(_0x32600e(0x72))]('自定义卡密必须至少一项余额不为0️零！',common_1[_0x32600e(0x74)][_0x32600e(0xc3)]);const _0x3a8610={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x32600e(0xa2)](_0x3a8610,count);}}async[_0x4068a8(0xa2)](_0x11f5b7,_0xd893b0){const _0x17798c=_0x4068a8,_0x3de24c=[];for(let _0x35c92a=0x0;_0x35c92a<_0xd893b0;_0x35c92a++){const _0x597fe0=(0x0,utils_1['generateCramiCode'])(),_0x2d95bd=this['cramiEntity']['create'](Object[_0x17798c(0xa0)](Object['assign']({},_0x11f5b7),{'code':_0x597fe0}));_0x3de24c['push'](_0x2d95bd);}return await this[_0x17798c(0xa6)]['save'](_0x3de24c);}async[_0x4068a8(0x92)](_0x4d5547,_0x2d4a11){const _0x32fbf8=_0x4068a8,{id:_0xf7b74c}=_0x4d5547['user'],_0x32bd14=await this[_0x32fbf8(0xa6)]['findOne']({'where':{'code':_0x2d4a11[_0x32fbf8(0xb9)]}});if(!_0x32bd14)throw new common_1['HttpException'](_0x32fbf8(0x73),common_1[_0x32fbf8(0x74)][_0x32fbf8(0xc3)]);const {status:_0xd8b9a9,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x3577f0}=_0x32bd14;if(_0xd8b9a9===0x1)throw new common_1[(_0x32fbf8(0x72))](_0x32fbf8(0xa5),common_1['HttpStatus'][_0x32fbf8(0xc3)]);const _0x4b9d2e={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x3577f0};return await this['userBalanceService'][_0x32fbf8(0x90)](_0xf7b74c,Object['assign']({},_0x4b9d2e),days),await this[_0x32fbf8(0x87)][_0x32fbf8(0x6c)]({'userId':_0xf7b74c,'rechargeType':balance_constant_1['RechargeType']['PACKAGE_GIFT'],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x32fbf8(0xa6)][_0x32fbf8(0x70)]({'code':_0x2d4a11[_0x32fbf8(0xb9)]},{'useId':_0xf7b74c,'status':0x1}),_0x32fbf8(0xab);}async[_0x4068a8(0xa9)](_0x2791ae,_0x52a1fb){const _0x1a31b4=_0x4068a8,{page:page=0x1,size:size=0xa,status:_0x1f7dfe,useId:_0x8159d2}=_0x2791ae,_0x4016bd={};_0x1f7dfe&&Object[_0x1a31b4(0xa0)](_0x4016bd,{'status':_0x1f7dfe}),_0x8159d2&&Object[_0x1a31b4(0xa0)](_0x4016bd,{'useId':_0x8159d2});const [_0x2ab40c,_0x25ba87]=await this[_0x1a31b4(0xa6)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x1a31b4(0x6d)},'where':_0x4016bd}),_0x20ece3=_0x2ab40c[_0x1a31b4(0x86)](_0xc50ece=>_0xc50ece['useId']),_0x408126=_0x2ab40c[_0x1a31b4(0x86)](_0x354d00=>_0x354d00['packageId']),_0x2165e6=await this[_0x1a31b4(0x85)][_0x1a31b4(0x9f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x20ece3)}}),_0x2ecd7d=await this[_0x1a31b4(0x76)][_0x1a31b4(0x9f)]({'where':{'id':(0x0,typeorm_2['In'])(_0x408126)}});return _0x2ab40c[_0x1a31b4(0x8b)](_0x26ee94=>{const _0x42c75c=_0x1a31b4;var _0xb1e022,_0x40d754,_0x545bb4;_0x26ee94['username']=(_0xb1e022=_0x2165e6[_0x42c75c(0x9f)](_0x4c37d6=>_0x4c37d6['id']===_0x26ee94[_0x42c75c(0xa8)]))===null||_0xb1e022===void 0x0?void 0x0:_0xb1e022[_0x42c75c(0x78)],_0x26ee94[_0x42c75c(0x88)]=(_0x40d754=_0x2165e6[_0x42c75c(0x9f)](_0x37d18b=>_0x37d18b['id']===_0x26ee94[_0x42c75c(0xa8)]))===null||_0x40d754===void 0x0?void 0x0:_0x40d754[_0x42c75c(0x88)],_0x26ee94[_0x42c75c(0x6e)]=(_0x545bb4=_0x2ecd7d[_0x42c75c(0x9f)](_0x36d57b=>_0x36d57b['id']===_0x26ee94[_0x42c75c(0xb7)]))===null||_0x545bb4===void 0x0?void 0x0:_0x545bb4[_0x42c75c(0x6b)];}),_0x52a1fb[_0x1a31b4(0x9a)]['role']!==_0x1a31b4(0x8e)&&_0x2ab40c['forEach'](_0x1693c4=>_0x1693c4['email']=(0x0,utils_1[_0x1a31b4(0x7b)])(_0x1693c4[_0x1a31b4(0x88)])),_0x52a1fb[_0x1a31b4(0x9a)][_0x1a31b4(0xa3)]!==_0x1a31b4(0x8e)&&_0x2ab40c[_0x1a31b4(0x8b)](_0x2eb954=>_0x2eb954[_0x1a31b4(0xb9)]=(0x0,utils_1[_0x1a31b4(0x9e)])(_0x2eb954['code'])),{'rows':_0x2ab40c,'count':_0x25ba87};}async[_0x4068a8(0x6f)](_0x27074f){const _0x59754c=_0x4068a8,_0x5a29b1=await this[_0x59754c(0xa6)]['findOne']({'where':{'id':_0x27074f}});if(!_0x5a29b1)throw new common_1['HttpException'](_0x59754c(0xb3),common_1['HttpStatus'][_0x59754c(0xc3)]);if(_0x5a29b1[_0x59754c(0x8c)]===0x1)throw new common_1[(_0x59754c(0x72))](_0x59754c(0xb5),common_1[_0x59754c(0x74)]['BAD_REQUEST']);return await this[_0x59754c(0xa6)][_0x59754c(0xbf)]({'id':_0x27074f});}async[_0x4068a8(0x81)](_0x116bf7){const _0x1efe25=_0x4068a8,{ids:_0x482b77}=_0x116bf7,_0x3e38f2=await this['cramiEntity']['delete'](_0x482b77);if(_0x3e38f2['affected']>0x0)return _0x1efe25(0xc4);else throw new common_1['HttpException']('删除卡密失败、请重试！',common_1[_0x1efe25(0x74)]['BAD_REQUEST']);}};CramiService=__decorate([(0x0,common_1[_0x4068a8(0xa1)])(),__param(0x0,(0x0,typeorm_1[_0x4068a8(0xb8)])(crami_entity_1[_0x4068a8(0x77)])),__param(0x1,(0x0,typeorm_1[_0x4068a8(0xb8)])(cramiPackage_entity_1[_0x4068a8(0xa4)])),__param(0x2,(0x0,typeorm_1[_0x4068a8(0xb8)])(user_entity_1[_0x4068a8(0x7c)])),__metadata(_0x4068a8(0x95),[typeorm_2[_0x4068a8(0x98)],typeorm_2[_0x4068a8(0x98)],typeorm_2['Repository'],userBalance_service_1[_0x4068a8(0xb6)]])],CramiService),exports[_0x4068a8(0x83)]=CramiService;