'use strict';const _0x35fab0=_0x79f9;(function(_0x174532,_0xd3c454){const _0x35e829=_0x79f9,_0x905431=_0x174532();while(!![]){try{const _0x1dff8b=parseInt(_0x35e829(0x12f))/0x1*(-parseInt(_0x35e829(0x153))/0x2)+parseInt(_0x35e829(0x157))/0x3+-parseInt(_0x35e829(0x142))/0x4*(-parseInt(_0x35e829(0x12d))/0x5)+-parseInt(_0x35e829(0x148))/0x6*(parseInt(_0x35e829(0x169))/0x7)+-parseInt(_0x35e829(0x163))/0x8*(parseInt(_0x35e829(0x126))/0x9)+parseInt(_0x35e829(0x16f))/0xa*(-parseInt(_0x35e829(0x11d))/0xb)+parseInt(_0x35e829(0x11f))/0xc;if(_0x1dff8b===_0xd3c454)break;else _0x905431['push'](_0x905431['shift']());}catch(_0x55ed0a){_0x905431['push'](_0x905431['shift']());}}}(_0xa67e,0x70007));function _0x79f9(_0xf7d739,_0x2151e7){const _0xa67e71=_0xa67e();return _0x79f9=function(_0x79f9aa,_0xde7cfd){_0x79f9aa=_0x79f9aa-0x104;let _0x208833=_0xa67e71[_0x79f9aa];return _0x208833;},_0x79f9(_0xf7d739,_0x2151e7);}function _0xa67e(){const _0x1952ef=['createdAt','message_id','InjectRepository','?imageView2/1/w/','find','save','includes','isGroup','DESC','findOne','../user/user.entity','11ftZtdu','../chatGroup/chatGroup.entity','24351600yIfHzY','HttpException','UserEntity','取消推荐','attachment;\x20filename=','__esModule','update','54ubueQc','delByGroupId','parse','userId','ChatGroupEntity','你操作的图片不存在、请检查！','components','920tZJIES','formatDate','1agHUkg','super','prompt','rec','chatGroupEntity','chatlog','count','ChatLogService','addWorksheet','assistant','end','user','Not','Workbook','@nestjs/common','type','affected','length','你删除的对话记录不存在、请检查！','5028sTiHVS','model','/q/55','HttpStatus','paintCount','../../common/utils','54jrxLUO','chat.xlsx','saveChatLog','Injectable','function','BAD_REQUEST','PAINT_TYPE','图片成功！','提问问题','__metadata','ChatLogEntity','948886jHpYQA','querDrawLog','删除对话记录成功！','DeductionKey','266556WRolhL','role','tencent','recDrawImg','回答答案','CHAT_TYPE','columns','setHeader','findAndCount','cos','ali','assign','995184bvMsan','提问时间','defineProperty','decorate','getOwnPropertyDescriptor','object','359443dljMJc','addRow','design:paramtypes','answer','?x-oss-process=image/resize,w_','Like','2077090LGmFlB','../../common/constants/balance.constant','userEntity','用户邮箱','Repository','__param','chatLogEntity','metadata','extend','username','email','deleteChatLog','thumbImg','typeorm','forEach','querAllDrawLog','Content-Disposition','exceljs','map','chatList'];_0xa67e=function(){return _0x1952ef;};return _0xa67e();}var __decorate=this&&this['__decorate']||function(_0x129728,_0x39af9d,_0x212a99,_0x42bedb){const _0x41be91=_0x79f9;var _0x1e7d13=arguments[_0x41be91(0x140)],_0x4abbbf=_0x1e7d13<0x3?_0x39af9d:_0x42bedb===null?_0x42bedb=Object[_0x41be91(0x167)](_0x39af9d,_0x212a99):_0x42bedb,_0x27c8f5;if(typeof Reflect===_0x41be91(0x168)&&typeof Reflect[_0x41be91(0x166)]===_0x41be91(0x14c))_0x4abbbf=Reflect['decorate'](_0x129728,_0x39af9d,_0x212a99,_0x42bedb);else{for(var _0xfd3295=_0x129728[_0x41be91(0x140)]-0x1;_0xfd3295>=0x0;_0xfd3295--)if(_0x27c8f5=_0x129728[_0xfd3295])_0x4abbbf=(_0x1e7d13<0x3?_0x27c8f5(_0x4abbbf):_0x1e7d13>0x3?_0x27c8f5(_0x39af9d,_0x212a99,_0x4abbbf):_0x27c8f5(_0x39af9d,_0x212a99))||_0x4abbbf;}return _0x1e7d13>0x3&&_0x4abbbf&&Object['defineProperty'](_0x39af9d,_0x212a99,_0x4abbbf),_0x4abbbf;},__metadata=this&&this[_0x35fab0(0x151)]||function(_0x804f4c,_0x1bf1fb){const _0x1c4d26=_0x35fab0;if(typeof Reflect===_0x1c4d26(0x168)&&typeof Reflect['metadata']===_0x1c4d26(0x14c))return Reflect[_0x1c4d26(0x105)](_0x804f4c,_0x1bf1fb);},__param=this&&this[_0x35fab0(0x174)]||function(_0x567fb5,_0x5138c9){return function(_0x18fbc6,_0x4a1257){_0x5138c9(_0x18fbc6,_0x4a1257,_0x567fb5);};};Object[_0x35fab0(0x165)](exports,_0x35fab0(0x124),{'value':!![]}),exports[_0x35fab0(0x136)]=void 0x0;const common_1=require(_0x35fab0(0x13d)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x35fab0(0x10b)),balance_constant_1=require(_0x35fab0(0x170)),user_entity_1=require(_0x35fab0(0x11c)),utils_1=require(_0x35fab0(0x147)),ExcelJS=require(_0x35fab0(0x10f)),chatGroup_entity_1=require(_0x35fab0(0x11e));let ChatLogService=class ChatLogService{constructor(_0x53827f,_0x2290ab,_0x93f4f8){const _0x22d998=_0x35fab0;this[_0x22d998(0x104)]=_0x53827f,this[_0x22d998(0x171)]=_0x2290ab,this[_0x22d998(0x133)]=_0x93f4f8;}async[_0x35fab0(0x14a)](_0xdfc40){const _0x3f8a34=_0x35fab0;return await this[_0x3f8a34(0x104)][_0x3f8a34(0x117)](_0xdfc40);}async[_0x35fab0(0x154)](_0x980463,_0x4305cb){const _0x67a1c1=_0x35fab0,{id:_0x211171}=_0x980463[_0x67a1c1(0x13a)],{model:_0x392bd4}=_0x4305cb,_0x467a4f={'userId':_0x211171,'type':balance_constant_1[_0x67a1c1(0x156)][_0x67a1c1(0x14e)]};_0x392bd4&&(_0x467a4f[_0x67a1c1(0x143)]=_0x392bd4);const _0xc6cb0c=await this[_0x67a1c1(0x104)][_0x67a1c1(0x116)]({'where':_0x467a4f,'order':{'id':_0x67a1c1(0x11a)},'select':['id',_0x67a1c1(0x16c),_0x67a1c1(0x131),_0x67a1c1(0x113),'group',_0x67a1c1(0x143),_0x67a1c1(0x106),_0x67a1c1(0x13e)]});return _0xc6cb0c[_0x67a1c1(0x10c)](_0x1b59b1=>{const _0x3a8144=_0x67a1c1;var _0x18bf78;if(_0x1b59b1['type']===_0x3a8144(0x146)){const _0x240f26=_0x1b59b1[_0x3a8144(0x143)]==='mj'?0x136:0xa0,_0xae359c=_0x1b59b1[_0x3a8144(0x16c)][_0x3a8144(0x118)](_0x3a8144(0x160))?'tencent':'ali',_0xdf5222=_0xae359c===_0x3a8144(0x159)?'?imageView2/1/w/'+_0x240f26+_0x3a8144(0x144):_0x3a8144(0x16d)+_0x240f26;_0x1b59b1[_0x3a8144(0x10a)]=_0x1b59b1[_0x3a8144(0x16c)]+_0xdf5222;const _0x168bab=_0x1b59b1[_0x3a8144(0x106)]?JSON['parse'](_0x1b59b1[_0x3a8144(0x106)]):null;_0x168bab&&(_0x168bab?_0x1b59b1['isGroup']=((_0x18bf78=_0x168bab===null||_0x168bab===void 0x0?void 0x0:_0x168bab[_0x3a8144(0x12c)][0x0])===null||_0x18bf78===void 0x0?void 0x0:_0x18bf78[_0x3a8144(0x12c)][_0x3a8144(0x140)])===0x5:_0x1b59b1[_0x3a8144(0x119)]=![]);}}),_0xc6cb0c;}async[_0x35fab0(0x10d)](_0x7417c0){const _0x4ccbc8=_0x35fab0,{page:page=0x1,size:size=0x14,rec:_0x3a063c,userId:_0x4c4080,model:_0x5048b0}=_0x7417c0,_0x2ee0e9={'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'prompt':(0x0,typeorm_2[_0x4ccbc8(0x13b)])(''),'answer':(0x0,typeorm_2[_0x4ccbc8(0x13b)])('')};_0x3a063c&&Object['assign'](_0x2ee0e9,{'rec':_0x3a063c}),_0x4c4080&&Object[_0x4ccbc8(0x162)](_0x2ee0e9,{'userId':_0x4c4080}),_0x5048b0&&Object[_0x4ccbc8(0x162)](_0x2ee0e9,{'model':_0x5048b0});const [_0x39be93,_0x3ce9c5]=await this[_0x4ccbc8(0x104)][_0x4ccbc8(0x15f)]({'order':{'id':_0x4ccbc8(0x11a)},'skip':(page-0x1)*size,'take':size,'where':_0x2ee0e9});return _0x39be93['forEach'](_0x3dda89=>{const _0x38de9b=_0x4ccbc8;var _0x30db90;if(_0x3dda89['type']==='paintCount'){const _0x19556f=_0x3dda89[_0x38de9b(0x143)]==='mj'?0x136:0xa0,_0x578665=_0x3dda89['answer'][_0x38de9b(0x118)](_0x38de9b(0x160))?'tencent':_0x38de9b(0x161),_0x448a95=_0x578665===_0x38de9b(0x159)?_0x38de9b(0x115)+_0x19556f+_0x38de9b(0x144):_0x38de9b(0x16d)+_0x19556f;_0x3dda89['thumbImg']=_0x3dda89[_0x38de9b(0x16c)]+_0x448a95;const _0x2bc59d=_0x3dda89[_0x38de9b(0x106)]?JSON[_0x38de9b(0x128)](_0x3dda89[_0x38de9b(0x106)]):null;_0x2bc59d&&(_0x2bc59d?_0x3dda89[_0x38de9b(0x119)]=((_0x30db90=_0x2bc59d===null||_0x2bc59d===void 0x0?void 0x0:_0x2bc59d['components'][0x0])===null||_0x30db90===void 0x0?void 0x0:_0x30db90[_0x38de9b(0x12c)][_0x38de9b(0x140)])===0x5:_0x3dda89[_0x38de9b(0x119)]=![]);}}),{'rows':_0x39be93,'count':_0x3ce9c5};}async[_0x35fab0(0x15a)](_0x4c1a3e){const _0xa428a5=_0x35fab0,{id:_0x150f01}=_0x4c1a3e,_0x4d2c75=await this[_0xa428a5(0x104)][_0xa428a5(0x11b)]({'where':{'id':_0x150f01,'type':balance_constant_1[_0xa428a5(0x156)][_0xa428a5(0x14e)]}});if(!_0x4d2c75)throw new common_1['HttpException']('你推荐的图片不存在、请检查！',common_1[_0xa428a5(0x145)][_0xa428a5(0x14d)]);const _0x2762c2=_0x4d2c75[_0xa428a5(0x132)]===0x1?0x0:0x1,_0x7ad23d=await this[_0xa428a5(0x104)][_0xa428a5(0x125)]({'id':_0x150f01},{'rec':_0x2762c2});if(_0x7ad23d[_0xa428a5(0x13f)]>0x0)return(_0x2762c2?'推荐':_0xa428a5(0x122))+_0xa428a5(0x14f);throw new common_1[(_0xa428a5(0x120))](_0xa428a5(0x12b),common_1[_0xa428a5(0x145)]['BAD_REQUEST']);}async['exportExcel'](_0x4b3bb8,_0x29b446){const _0x3617d0=_0x35fab0,_0x3b01dc={'type':balance_constant_1[_0x3617d0(0x156)][_0x3617d0(0x15c)]},{page:page=0x1,size:size=0x1e,prompt:_0x298909,email:_0x4978bf}=_0x4b3bb8;_0x298909&&Object['assign'](_0x3b01dc,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x298909+'%')});if(_0x4978bf){const _0x5281ed=await this[_0x3617d0(0x171)][_0x3617d0(0x11b)]({'where':{'email':_0x4978bf}});(_0x5281ed===null||_0x5281ed===void 0x0?void 0x0:_0x5281ed['id'])&&Object['assign'](_0x3b01dc,{'userId':_0x5281ed['id']});}const [_0x4f1cf5,_0x1082a9]=await this[_0x3617d0(0x104)][_0x3617d0(0x15f)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3b01dc}),_0x43d3f8=_0x4f1cf5[_0x3617d0(0x110)](_0x163608=>_0x163608[_0x3617d0(0x129)]),_0x3a9afc=await this[_0x3617d0(0x171)][_0x3617d0(0x116)]({'where':{'id':(0x0,typeorm_2['In'])(_0x43d3f8)}}),_0x58accf=_0x4f1cf5['map'](_0x1041f0=>{const _0x5989a1=_0x3617d0,_0x3af42f=_0x3a9afc[_0x5989a1(0x116)](_0x50aba6=>_0x50aba6['id']===_0x1041f0[_0x5989a1(0x129)]);return{'username':_0x3af42f?_0x3af42f['username']:'','email':_0x3af42f?_0x3af42f[_0x5989a1(0x108)]:'','prompt':_0x1041f0[_0x5989a1(0x131)],'answer':_0x1041f0[_0x5989a1(0x16c)],'createdAt':(0x0,utils_1['formatDate'])(_0x1041f0[_0x5989a1(0x112)])};}),_0x25d9e9=new ExcelJS[(_0x3617d0(0x13c))](),_0x6d2b=_0x25d9e9[_0x3617d0(0x137)](_0x3617d0(0x134));_0x6d2b[_0x3617d0(0x15d)]=[{'header':'用户名','key':_0x3617d0(0x107),'width':0x14},{'header':_0x3617d0(0x172),'key':_0x3617d0(0x108),'width':0x14},{'header':_0x3617d0(0x164),'key':_0x3617d0(0x112),'width':0x14},{'header':_0x3617d0(0x150),'key':_0x3617d0(0x131),'width':0x50},{'header':_0x3617d0(0x15b),'key':_0x3617d0(0x16c),'width':0x96}],_0x58accf['forEach'](_0xe582d5=>_0x6d2b[_0x3617d0(0x16a)](_0xe582d5)),_0x29b446[_0x3617d0(0x15e)]('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x29b446[_0x3617d0(0x15e)](_0x3617d0(0x10e),_0x3617d0(0x123)+_0x3617d0(0x149)),await _0x25d9e9['xlsx']['write'](_0x29b446),_0x29b446[_0x3617d0(0x139)]();}async['querAllChatLog'](_0x3d603e,_0x3fd234){const _0x35b441=_0x35fab0,{page:page=0x1,size:size=0x14,userId:_0x363fc1,prompt:_0xd7cf2f}=_0x3d603e,_0x2e6f7a={'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x35b441(0x13b)])('')};_0x363fc1&&Object[_0x35b441(0x162)](_0x2e6f7a,{'userId':_0x363fc1}),_0xd7cf2f&&Object[_0x35b441(0x162)](_0x2e6f7a,{'prompt':(0x0,typeorm_2[_0x35b441(0x16e)])('%'+_0xd7cf2f+'%')});const [_0x4ca391,_0x209683]=await this[_0x35b441(0x104)][_0x35b441(0x15f)]({'order':{'id':_0x35b441(0x11a)},'skip':(page-0x1)*size,'take':size,'where':_0x2e6f7a}),_0x29210a=_0x4ca391[_0x35b441(0x110)](_0x2c6633=>_0x2c6633['userId']),_0x151675=await this[_0x35b441(0x171)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x29210a)},'select':['id',_0x35b441(0x107),_0x35b441(0x108)]});return _0x4ca391[_0x35b441(0x10c)](_0x57b192=>{const _0x18e131=_0x35b441,{username:_0x247557,email:_0x349812}=_0x151675[_0x18e131(0x116)](_0xc0c8f5=>_0xc0c8f5['id']===_0x57b192[_0x18e131(0x129)])||{};_0x57b192[_0x18e131(0x107)]=_0x247557,_0x57b192[_0x18e131(0x108)]=_0x349812;}),_0x3fd234[_0x35b441(0x13a)][_0x35b441(0x158)]!==_0x35b441(0x130)&&_0x4ca391[_0x35b441(0x10c)](_0x12ed92=>_0x12ed92[_0x35b441(0x108)]=(0x0,utils_1['maskEmail'])(_0x12ed92[_0x35b441(0x108)])),{'rows':_0x4ca391,'count':_0x209683};}async[_0x35fab0(0x111)](_0x122bd0,_0x3839f0){const _0x4ff6ad=_0x35fab0,{id:_0x448e04}=_0x122bd0['user'],{groupId:_0x3c8f93}=_0x3839f0,_0x2aaab5={'userId':_0x448e04,'isDelete':![]};_0x3c8f93&&Object['assign'](_0x2aaab5,{'groupId':_0x3c8f93});if(_0x3c8f93){const _0x28b517=await this['chatGroupEntity'][_0x4ff6ad(0x135)]({'where':{'isDelete':![]}});if(_0x28b517===0x0)return[];}const _0x7c4e91=await this['chatLogEntity'][_0x4ff6ad(0x116)]({'where':_0x2aaab5});return _0x7c4e91[_0x4ff6ad(0x110)](_0x419d47=>{const _0x3d21ef=_0x4ff6ad,{prompt:_0x3e0b5b,role:_0x1707d9,answer:_0x50d1fb,createdAt:_0x2eeecb,model:_0xa49c15,conversationOptions:_0x20c893,requestOptions:_0x5bb321,id:_0x582007}=_0x419d47;return{'chatId':_0x582007,'dateTime':(0x0,utils_1[_0x3d21ef(0x12e)])(_0x2eeecb),'text':_0x1707d9===_0x3d21ef(0x13a)?_0x3e0b5b:_0x50d1fb,'inversion':_0x1707d9===_0x3d21ef(0x13a),'error':![],'conversationOptions':_0x20c893?JSON[_0x3d21ef(0x128)](_0x20c893):null,'requestOptions':_0x5bb321?JSON['parse'](_0x5bb321):null};});}async[_0x35fab0(0x109)](_0x452e55,_0x14beed){const _0x2e9954=_0x35fab0,{id:_0x23a156}=_0x452e55[_0x2e9954(0x13a)],{id:_0x408918}=_0x14beed,_0xd7c6af=await this[_0x2e9954(0x104)]['findOne']({'where':{'id':_0x408918,'userId':_0x23a156}});if(!_0xd7c6af)throw new common_1[(_0x2e9954(0x120))](_0x2e9954(0x141),common_1[_0x2e9954(0x145)]['BAD_REQUEST']);const _0x3bd7e3=await this[_0x2e9954(0x104)][_0x2e9954(0x125)]({'id':_0x408918},{'isDelete':!![]});if(_0x3bd7e3[_0x2e9954(0x13f)]>0x0)return _0x2e9954(0x155);else throw new common_1['HttpException']('你删除的对话记录不存在、请检查！',common_1[_0x2e9954(0x145)][_0x2e9954(0x14d)]);}async[_0x35fab0(0x127)](_0xec5d42,_0x30cbc5){const _0x1ffadd=_0x35fab0,{groupId:_0x29b71a}=_0x30cbc5,{id:_0x54f59c}=_0xec5d42[_0x1ffadd(0x13a)],_0xf9bb8d=await this[_0x1ffadd(0x133)][_0x1ffadd(0x11b)]({'where':{'id':_0x29b71a,'userId':_0x54f59c}});if(!_0xf9bb8d)throw new common_1[(_0x1ffadd(0x120))](_0x1ffadd(0x141),common_1['HttpStatus'][_0x1ffadd(0x14d)]);const _0x4c76a5=await this[_0x1ffadd(0x104)]['update']({'groupId':_0x29b71a},{'isDelete':!![]});if(_0x4c76a5[_0x1ffadd(0x13f)]>0x0)return'删除对话记录成功！';if(_0x4c76a5[_0x1ffadd(0x13f)]===0x0)throw new common_1[(_0x1ffadd(0x120))]('当前页面已经没有东西可以删除了！',common_1[_0x1ffadd(0x145)][_0x1ffadd(0x14d)]);}async['byAppId'](_0x185645,_0x967836){const _0x32c1ff=_0x35fab0,{id:_0xce04fb}=_0x185645['user'],{appId:_0x11980f,page:page=0x1,size:size=0xa}=_0x967836,[_0x46b27b,_0x1cd80f]=await this[_0x32c1ff(0x104)][_0x32c1ff(0x15f)]({'where':{'userId':_0xce04fb,'appId':_0x11980f,'role':_0x32c1ff(0x138)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x46b27b,'count':_0x1cd80f};}};ChatLogService=__decorate([(0x0,common_1[_0x35fab0(0x14b)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x35fab0(0x152)])),__param(0x1,(0x0,typeorm_1[_0x35fab0(0x114)])(user_entity_1[_0x35fab0(0x121)])),__param(0x2,(0x0,typeorm_1[_0x35fab0(0x114)])(chatGroup_entity_1[_0x35fab0(0x12a)])),__metadata(_0x35fab0(0x16b),[typeorm_2[_0x35fab0(0x173)],typeorm_2[_0x35fab0(0x173)],typeorm_2['Repository']])],ChatLogService),exports[_0x35fab0(0x136)]=ChatLogService;