'use strict';const _0x1b55d9=_0x25e6;(function(_0xc07ae4,_0x1fbe47){const _0x33bf15=_0x25e6,_0x58ad7c=_0xc07ae4();while(!![]){try{const _0x31cf0a=parseInt(_0x33bf15(0x263))/0x1+-parseInt(_0x33bf15(0x23d))/0x2*(parseInt(_0x33bf15(0x1fa))/0x3)+-parseInt(_0x33bf15(0x271))/0x4+-parseInt(_0x33bf15(0x255))/0x5*(-parseInt(_0x33bf15(0x1ff))/0x6)+parseInt(_0x33bf15(0x26c))/0x7*(parseInt(_0x33bf15(0x1e5))/0x8)+-parseInt(_0x33bf15(0x1fc))/0x9+-parseInt(_0x33bf15(0x258))/0xa;if(_0x31cf0a===_0x1fbe47)break;else _0x58ad7c['push'](_0x58ad7c['shift']());}catch(_0xc3c23f){_0x58ad7c['push'](_0x58ad7c['shift']());}}}(_0x4792,0x7fcc5));var __decorate=this&&this[_0x1b55d9(0x208)]||function(_0x3e7bdd,_0x530741,_0x5858ae,_0x5f4d51){const _0x4b1b48=_0x1b55d9;var _0x3853bd=arguments[_0x4b1b48(0x284)],_0x523722=_0x3853bd<0x3?_0x530741:_0x5f4d51===null?_0x5f4d51=Object[_0x4b1b48(0x21a)](_0x530741,_0x5858ae):_0x5f4d51,_0x1ef32c;if(typeof Reflect===_0x4b1b48(0x26d)&&typeof Reflect[_0x4b1b48(0x250)]==='function')_0x523722=Reflect['decorate'](_0x3e7bdd,_0x530741,_0x5858ae,_0x5f4d51);else{for(var _0x3fab00=_0x3e7bdd[_0x4b1b48(0x284)]-0x1;_0x3fab00>=0x0;_0x3fab00--)if(_0x1ef32c=_0x3e7bdd[_0x3fab00])_0x523722=(_0x3853bd<0x3?_0x1ef32c(_0x523722):_0x3853bd>0x3?_0x1ef32c(_0x530741,_0x5858ae,_0x523722):_0x1ef32c(_0x530741,_0x5858ae))||_0x523722;}return _0x3853bd>0x3&&_0x523722&&Object['defineProperty'](_0x530741,_0x5858ae,_0x523722),_0x523722;},__metadata=this&&this[_0x1b55d9(0x280)]||function(_0x280ce6,_0x36d940){const _0x3ae789=_0x1b55d9;if(typeof Reflect===_0x3ae789(0x26d)&&typeof Reflect[_0x3ae789(0x21f)]===_0x3ae789(0x233))return Reflect[_0x3ae789(0x21f)](_0x280ce6,_0x36d940);},__param=this&&this['__param']||function(_0x343637,_0x192c72){return function(_0x3106f3,_0x1becd1){_0x192c72(_0x3106f3,_0x1becd1,_0x343637);};};function _0x4792(){const _0x5878b6=['epay\x20--->\x20res:\x20','type','微信支付通知params:\x20','TRADE_SUCCESS','createRandomNonceStr','payWeChatAppId','328cedVXR','jsapi支付结果返回值:\x20','epay','sign','payHupiNotifyUrl','notifyMpay','套餐不存在!','payEpayNotifyUrl','Repository','sign_type','getConfigs','https://api.xunhupay.com/payment/do.html','Wap','total_fee','affected','WxPay','appid','findOne','InjectRepository','1.1','importDynamic','12VKDiBQ','cramiPackageEntity','9152721qTuGvm','submit.php','map','4487550TwRMHc','unsupported\x20pay\x20type','orderEntity','queryMpay','../order/order.entity','payWeChatSecret','addBalanceToOrder','h5_info','version','__decorate','default','HttpStatus','event_type','includes','UserService','param','time','userBalanceService','resource','native','device','name','query','title','money','订单不存在!','192.168.1.100','getOwnPropertyDescriptor','act','payWeChatNotifyUrl','notifyHupi','log','metadata','payWeChatPrivateKey','payer','notify','@nestjs/common','queryWeChat','BAD_REQUEST','payHupi','payEpayPid','keys','userService','payWeChatH5Url','payMpayReturnUrl','data','@nestjs/typeorm','https://api.xunhupay.com/payment/query.html','trade_state','toFixed','../globalConfig/globalConfig.service','update','function','UserBalanceService','join','axios','MD5','payHupiAppId','pid','wxpay','globalConfigService','hupi','25886KVWddA','attach','__esModule','status','payMpayApiQueryUrl','../userBalance/userBalance.service','now','payMpayNotifyUrl','order_no','out_trade_order','toString','微信H5支付失败！','payWeChatPublicKey','payMpay','out_trade_no','HttpException','hash','payEpayReturnUrl','get','decorate','GlobalConfigService','return_url','trade_status','md5','5tPABva','mpay','payMpayApiPayUrl','3733860VQPJJr','OrderEntity','sort','message','error:\x20','queryEpay','design:paramtypes','nonce_str','transactions_jsapi','../user/user.service','payEpayApiQueryUrl','604852hrAmgJ','payMpaySecret','payWeChat','errRaw','notifyEpay','payMpayPid','payWeChatMchId','payEpay','getOpenIdByUserId','106729IbTXXZ','object','notifyWeChat','支付通知验证失败:\x20','order','49264ZRAAyW','total','post','decipher_gcm','校验签名通过','text','status:\x20','createHash','jsapi','payHupiSecret','trade_order_id','payType:\x20','success','transactions_native','PayService','__metadata','clientip','payPlatform','notify_url','length','goodsId','payEpaySecret','TRANSACTION.SUCCESS','failed'];_0x4792=function(){return _0x5878b6;};return _0x4792();}function _0x25e6(_0x5af97f,_0x2000ec){const _0x479289=_0x4792();return _0x25e6=function(_0x25e61b,_0x38827c){_0x25e61b=_0x25e61b-0x1de;let _0x13ccc2=_0x479289[_0x25e61b];return _0x13ccc2;},_0x25e6(_0x5af97f,_0x2000ec);}Object['defineProperty'](exports,_0x1b55d9(0x23f),{'value':!![]}),exports[_0x1b55d9(0x27f)]=void 0x0;const typeorm_1=require(_0x1b55d9(0x22d)),typeorm_2=require('typeorm'),common_1=require(_0x1b55d9(0x223)),crypto=require('crypto'),axios_1=require(_0x1b55d9(0x236)),order_entity_1=require(_0x1b55d9(0x203)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x1b55d9(0x242)),globalConfig_service_1=require(_0x1b55d9(0x231)),utils_1=require('../../common/utils'),user_service_1=require(_0x1b55d9(0x261));let PayService=class PayService{constructor(_0x232c12,_0x14b892,_0x187f96,_0x4b39f5,_0x198ce4){const _0x12ae06=_0x1b55d9;this['cramiPackageEntity']=_0x232c12,this[_0x12ae06(0x201)]=_0x14b892,this[_0x12ae06(0x210)]=_0x187f96,this[_0x12ae06(0x23b)]=_0x4b39f5,this[_0x12ae06(0x229)]=_0x198ce4;}async['onModuleInit'](){const _0x5419d5=_0x1b55d9,_0x24b583=await(0x0,utils_1[_0x5419d5(0x1f9)])('wechatpay-node-v3');this[_0x5419d5(0x1f4)]=(_0x24b583===null||_0x24b583===void 0x0?void 0x0:_0x24b583[_0x5419d5(0x209)])?_0x24b583[_0x5419d5(0x209)]:_0x24b583;}async[_0x1b55d9(0x222)](_0x42aa06){const _0x1e4ae5=_0x1b55d9;if(_0x42aa06[_0x1e4ae5(0x20e)]==_0x1e4ae5(0x1e7))return this['notifyEpay'](_0x42aa06);if(_0x42aa06['attach']==_0x1e4ae5(0x23c))return this[_0x1e4ae5(0x21d)](_0x42aa06);if(typeof _0x42aa06[_0x1e4ae5(0x211)]==_0x1e4ae5(0x26d))return this[_0x1e4ae5(0x26e)](_0x42aa06);return this['notifyMpay'](_0x42aa06);}async['pay'](_0x5d98e1,_0x2f451c,_0x308e11=_0x1b55d9(0x23a)){const _0x1117f2=_0x1b55d9,_0x1e8c2c=await this[_0x1117f2(0x201)][_0x1117f2(0x1f6)]({'where':{'userId':_0x5d98e1,'orderId':_0x2f451c}});if(!_0x1e8c2c)throw new common_1[(_0x1117f2(0x24c))](_0x1117f2(0x218),common_1[_0x1117f2(0x20a)][_0x1117f2(0x225)]);const _0x4012e0=await this[_0x1117f2(0x1fb)]['findOne']({'where':{'id':_0x1e8c2c[_0x1117f2(0x285)]}});if(!_0x4012e0)throw new common_1[(_0x1117f2(0x24c))](_0x1117f2(0x1eb),common_1[_0x1117f2(0x20a)]['BAD_REQUEST']);console['log']('本次支付类型:\x20',_0x1e8c2c['payPlatform']);try{if(_0x1e8c2c[_0x1117f2(0x282)]=='wechat')return this[_0x1117f2(0x265)](_0x5d98e1,_0x2f451c,_0x308e11);if(_0x1e8c2c[_0x1117f2(0x282)]==_0x1117f2(0x1e7))return this[_0x1117f2(0x26a)](_0x5d98e1,_0x2f451c,_0x308e11);if(_0x1e8c2c['payPlatform']==_0x1117f2(0x256))return this[_0x1117f2(0x24a)](_0x5d98e1,_0x2f451c,_0x308e11);if(_0x1e8c2c[_0x1117f2(0x282)]=='hupi')return this[_0x1117f2(0x226)](_0x5d98e1,_0x2f451c,_0x308e11);}catch(_0x29ab14){console[_0x1117f2(0x21e)]('支付请求失败:\x20',_0x29ab14);throw new common_1[(_0x1117f2(0x24c))]('支付请求失败!',common_1['HttpStatus'][_0x1117f2(0x225)]);}}async[_0x1b55d9(0x215)](_0xa8b64){const _0x3873cd=_0x1b55d9,_0xee0319=await this[_0x3873cd(0x201)][_0x3873cd(0x1f6)]({'where':{'orderId':_0xa8b64}});if(!_0xee0319)throw new common_1['HttpException'](_0x3873cd(0x218),common_1['HttpStatus'][_0x3873cd(0x225)]);return _0xee0319;}async[_0x1b55d9(0x21d)](_0x2cae03){const _0x3bf47c=_0x1b55d9,_0xdc8dc1=await this[_0x3bf47c(0x23b)][_0x3bf47c(0x1ef)]([_0x3bf47c(0x27a)]),_0x4d895c=_0x2cae03[_0x3bf47c(0x24d)];delete _0x2cae03[_0x3bf47c(0x24d)];if(this[_0x3bf47c(0x1e8)](_0x2cae03,_0xdc8dc1)!=_0x4d895c)return _0x3bf47c(0x1de);const _0x229f15=await this[_0x3bf47c(0x201)][_0x3bf47c(0x1f6)]({'where':{'orderId':_0x2cae03[_0x3bf47c(0x27b)],'status':0x0}});if(!_0x229f15)return'failed';await this['userBalanceService'][_0x3bf47c(0x205)](_0x229f15);const _0x39146c=await this[_0x3bf47c(0x201)]['update']({'orderId':_0x2cae03[_0x3bf47c(0x27b)]},{'status':0x1,'paydAt':new Date()});if(_0x39146c[_0x3bf47c(0x1f3)]!=0x1)return'failed';return _0x3bf47c(0x27d);}async[_0x1b55d9(0x226)](_0x4f357b,_0x34f2e2,_0x1f5351=_0x1b55d9(0x23a)){const _0x196caa=_0x1b55d9,_0x36e41d=await this[_0x196caa(0x201)]['findOne']({'where':{'userId':_0x4f357b,'orderId':_0x34f2e2}});if(!_0x36e41d)throw new common_1['HttpException']('订单不存在!',common_1[_0x196caa(0x20a)]['BAD_REQUEST']);const _0x3f69b6=await this[_0x196caa(0x1fb)][_0x196caa(0x1f6)]({'where':{'id':_0x36e41d['goodsId']}});if(!_0x3f69b6)throw new common_1[(_0x196caa(0x24c))](_0x196caa(0x1eb),common_1[_0x196caa(0x20a)][_0x196caa(0x225)]);const {payHupiAppId:_0x103759,payHupiSecret:_0x39166d,payHupiNotifyUrl:_0x18fab1,payHupiReturnUrl:_0x1be4d4}=await this[_0x196caa(0x23b)]['getConfigs']([_0x196caa(0x238),_0x196caa(0x27a),_0x196caa(0x1e9),'payHupiReturnUrl']),_0x147468={};_0x147468[_0x196caa(0x207)]=_0x196caa(0x1f8),_0x147468[_0x196caa(0x1f5)]=_0x103759,_0x147468[_0x196caa(0x20f)]=(Date[_0x196caa(0x243)]()/0x3e8)['toFixed'](0x0),_0x147468[_0x196caa(0x25f)]=(0x0,utils_1[_0x196caa(0x1e3)])(0x20),_0x147468[_0x196caa(0x27b)]=_0x34f2e2,_0x147468[_0x196caa(0x216)]=_0x3f69b6[_0x196caa(0x214)],_0x147468[_0x196caa(0x1f2)]=_0x36e41d[_0x196caa(0x272)],_0x147468[_0x196caa(0x283)]=_0x18fab1,_0x147468[_0x196caa(0x252)]=_0x1be4d4,_0x147468[_0x196caa(0x23e)]='hupi',_0x147468['hash']=this['sign'](_0x147468,_0x39166d);const {data:{errcode:_0x4f50d8,errmsg:_0x442661,url_qrcode:_0x251953,url:_0x1ac515}}=await axios_1[_0x196caa(0x209)]['post'](_0x196caa(0x1f0),_0x147468);if(_0x4f50d8!=0x0)throw new common_1[(_0x196caa(0x24c))](_0x442661,common_1[_0x196caa(0x20a)]['BAD_REQUEST']);return{'url_qrcode':_0x251953,'url':_0x1ac515};}async['queryHupi'](_0x1d14d2){const _0x3331b1=_0x1b55d9,{payHupiAppId:_0x2b458e,payHupiSecret:_0x4c42e6}=await this[_0x3331b1(0x23b)]['getConfigs']([_0x3331b1(0x238),'payHupiSecret']),_0x232a9b={};_0x232a9b[_0x3331b1(0x207)]=_0x3331b1(0x1f8),_0x232a9b['appid']=_0x2b458e,_0x232a9b[_0x3331b1(0x20f)]=(Date[_0x3331b1(0x243)]()/0x3e8)[_0x3331b1(0x230)](0x0),_0x232a9b['nonce_str']=(0x0,utils_1[_0x3331b1(0x1e3)])(0x20),_0x232a9b[_0x3331b1(0x246)]=_0x1d14d2,_0x232a9b['hash']=this['sign'](_0x232a9b,_0x4c42e6);const {data:{errcode:_0x42ae14,errmsg:_0x41a201,data:_0x50b14a}}=await axios_1[_0x3331b1(0x209)][_0x3331b1(0x273)](_0x3331b1(0x22e),_0x232a9b);if(_0x42ae14!=0x0)throw new common_1[(_0x3331b1(0x24c))](_0x41a201,common_1[_0x3331b1(0x20a)][_0x3331b1(0x225)]);return _0x50b14a;}async[_0x1b55d9(0x267)](_0x1c30c8){const _0x5e0b19=_0x1b55d9,_0x1c3382=_0x1c30c8['sign'];delete _0x1c30c8[_0x5e0b19(0x1e8)],delete _0x1c30c8[_0x5e0b19(0x1ee)];const _0x16ea03=await this[_0x5e0b19(0x23b)][_0x5e0b19(0x1ef)](['payEpaySecret']);if(this['sign'](_0x1c30c8,_0x16ea03)!=_0x1c3382)return _0x5e0b19(0x1de);console[_0x5e0b19(0x21e)]('校验签名通过');const _0x23dca4=await this[_0x5e0b19(0x201)][_0x5e0b19(0x1f6)]({'where':{'orderId':_0x1c30c8[_0x5e0b19(0x24b)],'status':0x0}});if(!_0x23dca4)return _0x5e0b19(0x1de);const _0x141f0b=_0x1c30c8['trade_status']==_0x5e0b19(0x1e2)?0x1:0x2,_0xc54d87=await this[_0x5e0b19(0x201)][_0x5e0b19(0x232)]({'orderId':_0x1c30c8[_0x5e0b19(0x24b)]},{'status':_0x141f0b,'paydAt':new Date()});_0x141f0b===0x1&&await this['userBalanceService'][_0x5e0b19(0x205)](_0x23dca4);if(_0xc54d87[_0x5e0b19(0x1f3)]!=0x1)return _0x5e0b19(0x1de);return _0x5e0b19(0x27d);}async['payEpay'](_0x2c95fc,_0x24b7c5,_0x37907e='alipay'){const _0x313120=_0x1b55d9,_0x1e0102=await this[_0x313120(0x201)][_0x313120(0x1f6)]({'where':{'userId':_0x2c95fc,'orderId':_0x24b7c5}});if(!_0x1e0102)throw new common_1['HttpException'](_0x313120(0x218),common_1[_0x313120(0x20a)][_0x313120(0x225)]);const _0xf40353=await this[_0x313120(0x1fb)][_0x313120(0x1f6)]({'where':{'id':_0x1e0102[_0x313120(0x285)]}});if(!_0xf40353)throw new common_1[(_0x313120(0x24c))](_0x313120(0x1eb),common_1['HttpStatus'][_0x313120(0x225)]);const {payEpayPid:_0x1c8d97,payEpaySecret:_0xa02001,payEpayNotifyUrl:_0x3c9f7e,payEpayReturnUrl:_0x502ebf,payEpayApiPayUrl:_0x248623}=await this[_0x313120(0x23b)][_0x313120(0x1ef)]([_0x313120(0x227),_0x313120(0x286),_0x313120(0x1ec),_0x313120(0x24e),'payEpayApiPayUrl']);let _0xb8e0ad;_0x1c8d97[_0x313120(0x284)]<=0x10?_0xb8e0ad=Number(_0x1c8d97):_0xb8e0ad=BigInt(_0x1c8d97);const _0x2d0a54={};_0x2d0a54[_0x313120(0x239)]=_0xb8e0ad,_0x2d0a54[_0x313120(0x1e0)]=_0x37907e,_0x2d0a54['out_trade_no']=_0x24b7c5,_0x2d0a54[_0x313120(0x214)]=_0xf40353['name'],_0x2d0a54[_0x313120(0x217)]=_0x1e0102[_0x313120(0x272)],_0x2d0a54[_0x313120(0x281)]=_0x313120(0x219),_0x2d0a54[_0x313120(0x213)]='pc',_0x2d0a54[_0x313120(0x283)]=_0x3c9f7e,_0x2d0a54[_0x313120(0x252)]=_0x502ebf,_0x2d0a54[_0x313120(0x20e)]=_0x313120(0x1e7),_0x2d0a54[_0x313120(0x1e8)]=this[_0x313120(0x1e8)](_0x2d0a54,_0xa02001),_0x2d0a54[_0x313120(0x1ee)]=_0x313120(0x237);const _0x340094=new URLSearchParams(_0x2d0a54)[_0x313120(0x247)](),_0x33fbd7=_0x248623+'?'+_0x340094;if(_0x248623[_0x313120(0x20c)](_0x313120(0x1fd)))return{'url_qrcode':null,'redirectUrl':_0x33fbd7,'channel':_0x37907e,'isRedirect':!![]};else{const _0x5cf3a1=await axios_1['default'][_0x313120(0x24f)](_0x248623,{'params':_0x2d0a54});console[_0x313120(0x21e)](_0x313120(0x1df),_0x5cf3a1[_0x313120(0x22c)]);const {data:{code:_0x1e0d59,msg:_0x166aca,qrcode:_0x30b159}}=_0x5cf3a1;if(_0x1e0d59!=0x1)throw new common_1[(_0x313120(0x24c))](_0x166aca,common_1[_0x313120(0x20a)]['BAD_REQUEST']);return{'url_qrcode':_0x30b159,'redirectUrl':null,'channel':_0x37907e,'isRedirect':![]};}}async[_0x1b55d9(0x25d)](_0x571b2b){const _0x297116=_0x1b55d9,{payEpayPid:_0x467313,payEpaySecret:_0x9eb1bd,payEpayApiQueryUrl:_0xc85aaf}=await this['globalConfigService'][_0x297116(0x1ef)](['payEpayPid',_0x297116(0x286),_0x297116(0x262)]),_0x5556db={};_0x5556db[_0x297116(0x21b)]=_0x297116(0x270),_0x5556db['out_trade_no']=_0x571b2b,_0x5556db['pid']=_0x467313,_0x5556db['key']=_0x9eb1bd;const {data:{code:_0x36f7b8,msg:_0x28eb74,data:_0x30ca69}}=await axios_1[_0x297116(0x209)]['get'](_0xc85aaf,{'params':_0x5556db});if(_0x36f7b8!=0x1)throw new common_1[(_0x297116(0x24c))](_0x28eb74,common_1['HttpStatus'][_0x297116(0x225)]);return _0x30ca69;}async[_0x1b55d9(0x1ea)](_0x1a2931){const _0x3322a5=_0x1b55d9,_0x59b552=_0x1a2931[_0x3322a5(0x1e8)];delete _0x1a2931[_0x3322a5(0x1e8)],delete _0x1a2931[_0x3322a5(0x1ee)];const _0x51e50c=await this[_0x3322a5(0x23b)][_0x3322a5(0x1ef)]([_0x3322a5(0x264)]);console[_0x3322a5(0x21e)]('校验签名');if(this[_0x3322a5(0x1e8)](_0x1a2931,_0x51e50c)!=_0x59b552)return'failed';console['log'](_0x3322a5(0x275));const _0x4bb3ba=await this['orderEntity'][_0x3322a5(0x1f6)]({'where':{'orderId':_0x1a2931['out_trade_no'],'status':0x0}});if(!_0x4bb3ba)return'failed';const _0x64a96=_0x1a2931[_0x3322a5(0x253)]=='TRADE_SUCCESS'?0x1:0x2;console['log'](_0x3322a5(0x277),_0x64a96);const _0x21b419=await this['orderEntity'][_0x3322a5(0x232)]({'orderId':_0x1a2931[_0x3322a5(0x24b)]},{'status':_0x64a96,'paydAt':new Date()});_0x64a96===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x4bb3ba);if(_0x21b419[_0x3322a5(0x1f3)]!=0x1)return _0x3322a5(0x1de);return _0x3322a5(0x27d);}async['payMpay'](_0xad57f,_0x24e6d2,_0x545fa0='wxpay'){const _0x417da2=_0x1b55d9,_0x504880=await this[_0x417da2(0x201)][_0x417da2(0x1f6)]({'where':{'userId':_0xad57f,'orderId':_0x24e6d2}});if(!_0x504880)throw new common_1[(_0x417da2(0x24c))](_0x417da2(0x218),common_1[_0x417da2(0x20a)][_0x417da2(0x225)]);const _0x5aa731=await this[_0x417da2(0x1fb)][_0x417da2(0x1f6)]({'where':{'id':_0x504880[_0x417da2(0x285)]}});if(!_0x5aa731)throw new common_1[(_0x417da2(0x24c))](_0x417da2(0x1eb),common_1[_0x417da2(0x20a)][_0x417da2(0x225)]);const {payMpayPid:_0x5560b8,payMpaySecret:_0xb05128,payMpayNotifyUrl:_0x7f2ea6,payMpayReturnUrl:_0x4be0ab,payMpayApiPayUrl:_0x2b9d33}=await this[_0x417da2(0x23b)][_0x417da2(0x1ef)]([_0x417da2(0x268),_0x417da2(0x264),_0x417da2(0x244),_0x417da2(0x22b),_0x417da2(0x257)]),_0x3fbc8b={};_0x3fbc8b[_0x417da2(0x239)]=Number(_0x5560b8),_0x3fbc8b[_0x417da2(0x1e0)]=_0x545fa0,_0x3fbc8b[_0x417da2(0x24b)]=_0x24e6d2,_0x3fbc8b[_0x417da2(0x214)]=_0x5aa731[_0x417da2(0x214)],_0x3fbc8b[_0x417da2(0x217)]=_0x504880[_0x417da2(0x272)],_0x3fbc8b[_0x417da2(0x283)]=_0x7f2ea6,_0x3fbc8b[_0x417da2(0x252)]=_0x4be0ab,_0x3fbc8b['sign']=this[_0x417da2(0x1e8)](_0x3fbc8b,_0xb05128),_0x3fbc8b[_0x417da2(0x1ee)]=_0x417da2(0x237);const _0x189ed0=new URLSearchParams(_0x3fbc8b)[_0x417da2(0x247)](),_0x5d5735=_0x2b9d33+'?'+_0x189ed0;return{'url_qrcode':null,'redirectUrl':_0x5d5735,'channel':_0x545fa0,'isRedirect':!![]};const _0x5dbd23=await axios_1['default'][_0x417da2(0x24f)](_0x2b9d33,{'params':_0x3fbc8b});}async[_0x1b55d9(0x202)](_0x431f3){const _0x490af3=_0x1b55d9,{payMpayApiQueryUrl:_0x4e7972}=await this[_0x490af3(0x23b)]['getConfigs']([_0x490af3(0x268),_0x490af3(0x264),_0x490af3(0x241)]),_0x2445c6={};_0x2445c6[_0x490af3(0x1e0)]=0x2,_0x2445c6[_0x490af3(0x245)]=_0x431f3;const {data:{code:_0x4b3d54,msg:_0x2a8e27,data:_0x3fef6a}}=await axios_1[_0x490af3(0x209)][_0x490af3(0x24f)](_0x4e7972,{'params':_0x2445c6});if(_0x4b3d54!=0x1)throw new common_1[(_0x490af3(0x24c))](_0x2a8e27,common_1['HttpStatus']['BAD_REQUEST']);return _0x3fef6a;}async['notifyWeChat'](_0x5010b3){const _0x12831a=_0x1b55d9;console[_0x12831a(0x21e)](_0x12831a(0x1e1),_0x5010b3);const {payWeChatAppId:_0x318fa0,payWeChatMchId:_0x148d3e,payWeChatSecret:_0x32c334,payWeChatPublicKey:_0x343947,payWeChatPrivateKey:_0x4e93ce}=await this[_0x12831a(0x23b)][_0x12831a(0x1ef)]([_0x12831a(0x1e4),_0x12831a(0x269),_0x12831a(0x204),_0x12831a(0x249),_0x12831a(0x220)]),_0x5bc8e8=new this[(_0x12831a(0x1f4))]({'appid':_0x318fa0,'mchid':_0x148d3e,'publicKey':_0x343947,'privateKey':_0x4e93ce});try{if(_0x5010b3[_0x12831a(0x20b)]==_0x12831a(0x287)){const {ciphertext:_0x4f4d92,associated_data:_0x5c7923,nonce:_0x1d4453}=_0x5010b3[_0x12831a(0x211)],_0x6c62a=_0x5bc8e8[_0x12831a(0x274)](_0x4f4d92,_0x5c7923,_0x1d4453,_0x32c334),_0x5ec009=await this[_0x12831a(0x201)]['findOne']({'where':{'orderId':_0x6c62a['out_trade_no'],'status':0x0}});if(!_0x5ec009)return _0x12831a(0x1de);const _0x3cd0e6=_0x6c62a[_0x12831a(0x22f)]=='SUCCESS'?0x1:0x2,_0x2728a7=await this[_0x12831a(0x201)][_0x12831a(0x232)]({'orderId':_0x6c62a[_0x12831a(0x24b)]},{'status':_0x3cd0e6,'paydAt':new Date()});_0x3cd0e6===0x1&&await this[_0x12831a(0x210)][_0x12831a(0x205)](_0x5ec009);if(_0x2728a7[_0x12831a(0x1f3)]!=0x1)return _0x12831a(0x1de);}return _0x12831a(0x27d);}catch(_0x520de3){return console[_0x12831a(0x21e)](_0x12831a(0x25c),_0x520de3),console['log'](_0x12831a(0x26f),_0x520de3),_0x12831a(0x1de);}}async[_0x1b55d9(0x265)](_0x12eb2a,_0x58e008,_0x7c52b8=_0x1b55d9(0x212)){const _0x56b637=_0x1b55d9;var _0x4f97d8,_0xa8a1d5,_0xaf00c6;console[_0x56b637(0x21e)](_0x56b637(0x27c),_0x7c52b8);const _0x54053a=await this[_0x56b637(0x201)]['findOne']({'where':{'userId':_0x12eb2a,'orderId':_0x58e008}});if(!_0x54053a)throw new common_1[(_0x56b637(0x24c))]('订单不存在!',common_1[_0x56b637(0x20a)][_0x56b637(0x225)]);const _0x4e9bcf=await this[_0x56b637(0x1fb)][_0x56b637(0x1f6)]({'where':{'id':_0x54053a[_0x56b637(0x285)]}});if(!_0x4e9bcf)throw new common_1[(_0x56b637(0x24c))](_0x56b637(0x1eb),common_1[_0x56b637(0x20a)][_0x56b637(0x225)]);const {payWeChatAppId:_0x542dff,payWeChatMchId:_0x535234,payWeChatPublicKey:_0x1ea942,payWeChatPrivateKey:_0x91f010,payWeChatNotifyUrl:_0x2395de,payWeChatH5Name:_0x14295e,payWeChatH5Url:_0x15d61d}=await this[_0x56b637(0x23b)][_0x56b637(0x1ef)]([_0x56b637(0x1e4),_0x56b637(0x269),'payWeChatPublicKey',_0x56b637(0x220),_0x56b637(0x21c),'payWeChatH5Name',_0x56b637(0x22a)]),_0x4daec5=new this[(_0x56b637(0x1f4))]({'appid':_0x542dff,'mchid':_0x535234,'publicKey':_0x1ea942,'privateKey':_0x91f010}),_0x4d5219={'appid':_0x542dff,'mchid':_0x535234,'description':_0x4e9bcf['name'],'out_trade_no':_0x58e008,'notify_url':_0x2395de,'amount':{'total':Number(_0x54053a['total']*0x64)},'scene_info':{'payer_client_ip':_0x56b637(0x219)}};console[_0x56b637(0x21e)]('wechat-pay:\x20',_0x4d5219);if(_0x7c52b8=='h5'){_0x4d5219['scene_info'][_0x56b637(0x206)]={'type':_0x56b637(0x1f1),'app_name':_0x14295e,'app_url':_0x15d61d};const _0x599ade=await _0x4daec5['transactions_h5'](_0x4d5219);if(_0x599ade[_0x56b637(0x240)]===0x193){const _0x2c38ce=(_0xaf00c6=(_0xa8a1d5=(_0x4f97d8=_0x599ade===null||_0x599ade===void 0x0?void 0x0:_0x599ade[_0x56b637(0x266)])===null||_0x4f97d8===void 0x0?void 0x0:_0x4f97d8['response'])===null||_0xa8a1d5===void 0x0?void 0x0:_0xa8a1d5[_0x56b637(0x276)])===null||_0xaf00c6===void 0x0?void 0x0:_0xaf00c6['message'];throw new common_1[(_0x56b637(0x24c))]((_0x599ade===null||_0x599ade===void 0x0?void 0x0:_0x599ade[_0x56b637(0x25b)])||_0x56b637(0x248),common_1[_0x56b637(0x20a)]['BAD_REQUEST']);}const {h5_url:_0x43e334}=_0x599ade;return{'url':_0x43e334};}if(_0x7c52b8==_0x56b637(0x279)){const _0x22b05a=await this[_0x56b637(0x229)][_0x56b637(0x26b)](_0x12eb2a);console[_0x56b637(0x21e)]('用户openId:\x20',_0x22b05a),_0x4d5219[_0x56b637(0x221)]={'openid':_0x22b05a};const _0x18b81a=await _0x4daec5[_0x56b637(0x260)](_0x4d5219);return console[_0x56b637(0x21e)](_0x56b637(0x1e6),_0x18b81a),_0x18b81a;}if(_0x7c52b8=='native'){const _0x9957d8=await _0x4daec5[_0x56b637(0x27e)](_0x4d5219),{code_url:_0x1aab00}=_0x9957d8;return!_0x1aab00&&console[_0x56b637(0x21e)]('wx-native',_0x9957d8),{'url_qrcode':_0x1aab00,'isRedirect':![]};}throw new common_1[(_0x56b637(0x24c))](_0x56b637(0x200),common_1['HttpStatus'][_0x56b637(0x225)]);}async[_0x1b55d9(0x224)](_0x183aad){const _0x24ffba=_0x1b55d9,{payWeChatAppId:_0x12f98a,payWeChatMchId:_0x21b1a8,payWeChatPublicKey:_0x5cc1af,payWeChatPrivateKey:_0x56ce8e,payWeChatNotifyUrl:_0x56e5a9,payWeChatH5Name:_0x259feb,payWeChatH5Url:_0x460fcc}=await this['globalConfigService'][_0x24ffba(0x1ef)]([_0x24ffba(0x1e4),_0x24ffba(0x269),_0x24ffba(0x249),'payWeChatPrivateKey']),_0x463e13=new this[(_0x24ffba(0x1f4))]({'appid':_0x12f98a,'mchid':_0x21b1a8,'publicKey':_0x5cc1af,'privateKey':_0x56ce8e}),_0x591f51=await _0x463e13[_0x24ffba(0x215)]({'out_trade_no':_0x183aad});return _0x591f51;}['sign'](_0xdff82e,_0x5ee443){const _0x3c0fd5=_0x1b55d9,_0x5c1d98=Object[_0x3c0fd5(0x228)](_0xdff82e)[_0x3c0fd5(0x25a)]()[_0x3c0fd5(0x1fe)](_0x9eefde=>_0x9eefde+'='+_0xdff82e[_0x9eefde])[_0x3c0fd5(0x235)]('&')+_0x5ee443;return crypto[_0x3c0fd5(0x278)](_0x3c0fd5(0x254))[_0x3c0fd5(0x232)](_0x5c1d98)['digest']('hex');}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1b55d9(0x1f7)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x1b55d9(0x1f7)])(order_entity_1[_0x1b55d9(0x259)])),__metadata(_0x1b55d9(0x25e),[typeorm_2[_0x1b55d9(0x1ed)],typeorm_2['Repository'],userBalance_service_1[_0x1b55d9(0x234)],globalConfig_service_1[_0x1b55d9(0x251)],user_service_1[_0x1b55d9(0x20d)]])],PayService),exports['PayService']=PayService;