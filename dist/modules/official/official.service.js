'use strict';const _0x187d54=_0x27b4;function _0x27b4(_0x1643ed,_0x26413f){const _0x112174=_0x1121();return _0x27b4=function(_0x27b48d,_0x182e27){_0x27b48d=_0x27b48d-0x168;let _0x30c98e=_0x112174[_0x27b48d];return _0x30c98e;},_0x27b4(_0x1643ed,_0x26413f);}(function(_0x407e9d,_0x18c618){const _0x5be15b=_0x27b4,_0x1bcdb2=_0x407e9d();while(!![]){try{const _0x438772=-parseInt(_0x5be15b(0x1c7))/0x1+parseInt(_0x5be15b(0x1a1))/0x2*(-parseInt(_0x5be15b(0x18f))/0x3)+parseInt(_0x5be15b(0x1a9))/0x4*(parseInt(_0x5be15b(0x19c))/0x5)+parseInt(_0x5be15b(0x183))/0x6*(-parseInt(_0x5be15b(0x17a))/0x7)+-parseInt(_0x5be15b(0x195))/0x8*(parseInt(_0x5be15b(0x16b))/0x9)+parseInt(_0x5be15b(0x1b0))/0xa+-parseInt(_0x5be15b(0x19f))/0xb*(-parseInt(_0x5be15b(0x1af))/0xc);if(_0x438772===_0x18c618)break;else _0x1bcdb2['push'](_0x1bcdb2['shift']());}catch(_0xa3786f){_0x1bcdb2['push'](_0x1bcdb2['shift']());}}}(_0x1121,0x90975));var __decorate=this&&this[_0x187d54(0x182)]||function(_0x4e2f06,_0xba27c3,_0x3a867c,_0x4a907b){const _0x3c6842=_0x187d54;var _0x20eaf7=arguments[_0x3c6842(0x189)],_0x3e8060=_0x20eaf7<0x3?_0xba27c3:_0x4a907b===null?_0x4a907b=Object[_0x3c6842(0x1bc)](_0xba27c3,_0x3a867c):_0x4a907b,_0xa4790d;if(typeof Reflect===_0x3c6842(0x179)&&typeof Reflect[_0x3c6842(0x19d)]===_0x3c6842(0x1a2))_0x3e8060=Reflect[_0x3c6842(0x19d)](_0x4e2f06,_0xba27c3,_0x3a867c,_0x4a907b);else{for(var _0x3b0170=_0x4e2f06[_0x3c6842(0x189)]-0x1;_0x3b0170>=0x0;_0x3b0170--)if(_0xa4790d=_0x4e2f06[_0x3b0170])_0x3e8060=(_0x20eaf7<0x3?_0xa4790d(_0x3e8060):_0x20eaf7>0x3?_0xa4790d(_0xba27c3,_0x3a867c,_0x3e8060):_0xa4790d(_0xba27c3,_0x3a867c))||_0x3e8060;}return _0x20eaf7>0x3&&_0x3e8060&&Object[_0x3c6842(0x1ad)](_0xba27c3,_0x3a867c,_0x3e8060),_0x3e8060;},__metadata=this&&this[_0x187d54(0x1a0)]||function(_0x37ba23,_0x310ece){const _0x56503d=_0x187d54;if(typeof Reflect===_0x56503d(0x179)&&typeof Reflect[_0x56503d(0x1a7)]===_0x56503d(0x1a2))return Reflect[_0x56503d(0x1a7)](_0x37ba23,_0x310ece);};Object[_0x187d54(0x1ad)](exports,_0x187d54(0x1b3),{'value':!![]}),exports['OfficialService']=void 0x0;const globalConfig_service_1=require(_0x187d54(0x1b4)),auth_service_1=require(_0x187d54(0x1c1)),user_service_1=require(_0x187d54(0x188)),autoreply_service_1=require(_0x187d54(0x17f)),common_1=require(_0x187d54(0x181)),crypto=require('crypto'),axios_1=require(_0x187d54(0x1b8)),utils_1=require(_0x187d54(0x17c));function _0x1121(){const _0x88185e=['933rHwBEp','getQRSceneStrByBind','fromusername','tousername','UserService','Injectable','4232544MTPECK','loginByCode','authService','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','post','bindWxBySceneStr','userService','121455IHxjFR','decorate','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','11HPiapG','__metadata','4808ieeoTk','function','QR_STR_SCENE','user','AuthService',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','metadata','getRedirectUrl','144jhUARm','sort','&timestamp=','scanedSceneStrMap','defineProperty','verify','25521264evhicG','8208750rXgADA',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','非法参数','__esModule','./../globalConfig/globalConfig.service','HttpException','&code=','HttpStatus','axios','getUserFromOpenId','aotoPlay','get','getOwnPropertyDescriptor','onModuleInit','GlobalConfigService','default','getJsapiTicket','./../auth/auth.service','回跳跳转地址:\x20','genXmlMsgByConfig','design:paramtypes','fetchQRCodeTicket','log','447722EKUncG','bindWx','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','now','checkAutoReply','18CtbeCx',']]></Content>\x0a\x20\x20\x20\x20</xml>','sha1','jiangly','BAD_REQUEST','sceneStrMap','loginByOpenId','globalConfigService','createRandomNonceStr','getTime','autoreplyService','getQRCodeTicket','&secret=','digest','object','53816sBAKuK','toFixed','../../common/utils','createHash','wechatJsapiTicket','./../autoreply/autoreply.service','wechatOfficialAppId','@nestjs/common','__decorate','762AwNHuz','scan','update','appId:\x20','getConfigs','./../user/user.service','length','hex','genXmlMsg','loginBySceneStr','&grant_type=authorization_code','&noncestr='];_0x1121=function(){return _0x88185e;};return _0x1121();}let OfficialService=class OfficialService{constructor(_0x44642d,_0x5389aa,_0x4e2ad1,_0x5a09d0){const _0x18dd52=_0x187d54;this[_0x18dd52(0x175)]=_0x44642d,this['userService']=_0x5389aa,this[_0x18dd52(0x197)]=_0x4e2ad1,this['globalConfigService']=_0x5a09d0,this['sceneStrMap']={},this['scanedSceneStrMap']={};}async[_0x187d54(0x1bd)](){const _0x579389=_0x187d54;await this[_0x579389(0x172)]['getWechatAccessToken'](!![]);}async['getQRSceneStr'](_0x4e759a){const _0x30a697=_0x187d54,{invitedBy:_0x4e86d4}=_0x4e759a;let _0x80b5f=(0x0,utils_1[_0x30a697(0x173)])(0x20);return _0x4e86d4&&(_0x80b5f+=':'+_0x4e86d4),this['sceneStrMap'][_0x80b5f]=!![],_0x80b5f;}async[_0x187d54(0x190)](_0x2b6980){const _0x2cc0ed=_0x187d54,{id:_0x46faaf}=_0x2b6980[_0x2cc0ed(0x1a4)],_0x59c301=(0x0,utils_1[_0x2cc0ed(0x173)])(0x20)+'/'+_0x46faaf;return this[_0x2cc0ed(0x170)][_0x59c301]=!![],_0x59c301;}async[_0x187d54(0x176)](_0x57274d){const _0x2b4fcb=_0x187d54;return this[_0x2b4fcb(0x1c5)](_0x57274d);}async[_0x187d54(0x1a8)](_0x4125fd){const _0x9f455b=_0x187d54,_0x33d22b=await this['globalConfigService'][_0x9f455b(0x187)]([_0x9f455b(0x180)]),_0x582576=_0x9f455b(0x198)+_0x33d22b+'&redirect_uri='+encodeURIComponent(_0x4125fd)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x9f455b(0x1c6)](_0x9f455b(0x1c2),_0x582576),_0x582576;}async[_0x187d54(0x1c0)](_0x297313){const _0x5914e0=_0x187d54,_0x30fb94=(0x0,utils_1[_0x5914e0(0x173)])(0x20),_0x5ae85e=(Date[_0x5914e0(0x169)]()/0x3e8)[_0x5914e0(0x17b)](0x0),_0x29c72a=await this[_0x5914e0(0x172)][_0x5914e0(0x187)]([_0x5914e0(0x17e)]);console[_0x5914e0(0x1c6)]('jsapiTicket:\x20',_0x29c72a);const _0x54d946=await this['globalConfigService'][_0x5914e0(0x187)]([_0x5914e0(0x180)]);console[_0x5914e0(0x1c6)](_0x5914e0(0x186),_0x54d946);const _0x12d84b='jsapi_ticket='+_0x29c72a+_0x5914e0(0x18e)+_0x30fb94+_0x5914e0(0x1ab)+_0x5ae85e+'&url='+_0x297313;console[_0x5914e0(0x1c6)]('str:\x20',_0x12d84b);const _0x31d1d0=this[_0x5914e0(0x16d)](_0x12d84b);return{'appId':_0x54d946,'nonceStr':_0x30fb94,'timestamp':_0x5ae85e,'signature':_0x31d1d0};}async[_0x187d54(0x1c5)](_0x57cd41){const _0x1a2a06=_0x187d54,_0x577a1a=await this[_0x1a2a06(0x172)][_0x1a2a06(0x187)](['wechatAccessToken']),_0x5a04b5={'action_name':_0x1a2a06(0x1a3),'action_info':{'scene':{'scene_str':_0x57cd41}}},_0x41c092=await axios_1[_0x1a2a06(0x1bf)][_0x1a2a06(0x199)](_0x1a2a06(0x19e)+_0x577a1a,_0x5a04b5),{data:{errmsg:_0x5d3087,ticket:_0x6f0998}}=_0x41c092;if(_0x5d3087)throw new common_1['HttpException'](_0x5d3087,common_1[_0x1a2a06(0x1b7)]['BAD_REQUEST']);return _0x6f0998;}async[_0x187d54(0x196)](_0x2829f3,_0x474a6c){const _0x3f39df=_0x187d54,_0x423a95=await this[_0x3f39df(0x172)][_0x3f39df(0x187)]([_0x3f39df(0x180)]),_0xae2565=await this[_0x3f39df(0x172)]['getConfigs'](['wechatOfficialAppSecret']),_0x413daf=await axios_1['default'][_0x3f39df(0x1bb)](_0x3f39df(0x168)+_0x423a95+_0x3f39df(0x177)+_0xae2565+_0x3f39df(0x1b6)+_0x474a6c+_0x3f39df(0x18d)),{data:{errmsg:_0xba48b9,openid:_0x473104}}=_0x413daf;if(_0xba48b9)throw new common_1[(_0x3f39df(0x1b5))](_0xba48b9,common_1[_0x3f39df(0x1b7)][_0x3f39df(0x16f)]);let _0xe72dc0;return _0xe72dc0=await this[_0x3f39df(0x19b)]['getUserOpenId'](_0x473104),!_0xe72dc0&&(_0xe72dc0=await this[_0x3f39df(0x19b)][_0x3f39df(0x1b9)](_0x473104)),this[_0x3f39df(0x197)][_0x3f39df(0x171)](_0xe72dc0,_0x2829f3);}async[_0x187d54(0x184)](_0x1affdc,_0x3aba6a){const _0x1e1aae=_0x187d54;if(!this[_0x1e1aae(0x170)][_0x3aba6a])throw new common_1[(_0x1e1aae(0x1b5))](_0x1e1aae(0x1b2),common_1['HttpStatus'][_0x1e1aae(0x16f)]);const _0x412c69=await this['userService'][_0x1e1aae(0x1b9)](_0x1affdc,_0x3aba6a);this[_0x1e1aae(0x1ac)][_0x3aba6a]=_0x412c69['id'];}async[_0x187d54(0x18c)](_0x2c3467,_0x547655){const _0x2b7725=_0x187d54;if(!this[_0x2b7725(0x170)][_0x547655])return;const _0x1835e2=this[_0x2b7725(0x1ac)][_0x547655];if(!_0x1835e2)return'';const _0x47ed48=await this[_0x2b7725(0x19b)]['getUserById'](_0x1835e2);return delete this['scanedSceneStrMap'][_0x547655],this[_0x2b7725(0x197)][_0x2b7725(0x171)](_0x47ed48,_0x2c3467);}async['scanBindWx'](_0x4e7025,_0x2a6b7c){const _0x4cedbc=_0x187d54;if(!this[_0x4cedbc(0x170)][_0x2a6b7c])throw new common_1[(_0x4cedbc(0x1b5))]('非法参数',common_1[_0x4cedbc(0x1b7)]['BAD_REQUEST']);const _0x31f681=_0x2a6b7c['split']('/')[0x1],_0x38363a=await this[_0x4cedbc(0x19b)][_0x4cedbc(0x1c8)](_0x4e7025,_0x31f681);this[_0x4cedbc(0x1ac)][_0x2a6b7c]=_0x38363a;}async[_0x187d54(0x19a)](_0x30a3c5,_0x15f8d7){const _0x574722=_0x187d54;if(!this[_0x574722(0x170)][_0x15f8d7])throw new common_1['HttpException'](_0x574722(0x1b2),common_1[_0x574722(0x1b7)][_0x574722(0x16f)]);const {id:_0x5a12a1}=_0x30a3c5['user'],_0x388ee7=this[_0x574722(0x1ac)][_0x15f8d7];if(!_0x388ee7)return'';return delete this['scanedSceneStrMap'][_0x15f8d7],_0x388ee7;}async[_0x187d54(0x1ae)](_0x9e1e4d,_0x48da0a,_0x48e8c2){const _0x150256=_0x187d54,_0x10d771=await this[_0x150256(0x172)][_0x150256(0x187)](['wechatOfficialToken'])||_0x150256(0x16e);return await this[_0x150256(0x16d)]([_0x10d771,_0x48da0a,_0x48e8c2][_0x150256(0x1aa)]()['join'](''))==_0x9e1e4d;}[_0x187d54(0x16d)](_0x599793){const _0x36670b=_0x187d54;return crypto[_0x36670b(0x17d)](_0x36670b(0x16d))[_0x36670b(0x185)](_0x599793)[_0x36670b(0x178)](_0x36670b(0x18a));}async[_0x187d54(0x1c3)](_0x140e0c,_0x83aecd){const _0x16b931=_0x187d54,_0x537a10=await this[_0x16b931(0x172)][_0x16b931(0x187)]([_0x83aecd]);return this[_0x16b931(0x18b)](_0x140e0c,_0x537a10);}async['genXmlMsg'](_0x1af2e6,_0x2b9c01){const _0x5c5cfd=_0x187d54;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x1af2e6[_0x5c5cfd(0x191)][0x0]+_0x5c5cfd(0x1b1)+_0x1af2e6[_0x5c5cfd(0x192)][0x0]+_0x5c5cfd(0x1a6)+new Date()[_0x5c5cfd(0x174)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x2b9c01+_0x5c5cfd(0x16c);}async[_0x187d54(0x1ba)](_0x259b6d){const _0xfa2391=_0x187d54;let _0x24e9b7=await this['autoreplyService'][_0xfa2391(0x16a)](_0x259b6d);if(!_0x24e9b7){const _0x5d4819=await this[_0xfa2391(0x172)][_0xfa2391(0x187)](['officialAutoReplyText']);_0x24e9b7=_0x5d4819;}return _0x24e9b7;}};OfficialService=__decorate([(0x0,common_1[_0x187d54(0x194)])(),__metadata(_0x187d54(0x1c4),[autoreply_service_1['AutoreplyService'],user_service_1[_0x187d54(0x193)],auth_service_1[_0x187d54(0x1a5)],globalConfig_service_1[_0x187d54(0x1be)]])],OfficialService),exports['OfficialService']=OfficialService;