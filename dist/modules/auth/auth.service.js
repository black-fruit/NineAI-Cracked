'use strict';const _0x35338f=_0x5ebe;(function(_0x16b3b6,_0x44a007){const _0x5d50d9=_0x5ebe,_0x4334f9=_0x16b3b6();while(!![]){try{const _0x4bb6d0=parseInt(_0x5d50d9(0x1f7))/0x1+parseInt(_0x5d50d9(0x21b))/0x2+parseInt(_0x5d50d9(0x201))/0x3*(parseInt(_0x5d50d9(0x1c5))/0x4)+-parseInt(_0x5d50d9(0x206))/0x5*(parseInt(_0x5d50d9(0x197))/0x6)+-parseInt(_0x5d50d9(0x1bf))/0x7+-parseInt(_0x5d50d9(0x1eb))/0x8*(parseInt(_0x5d50d9(0x1d5))/0x9)+-parseInt(_0x5d50d9(0x1e4))/0xa;if(_0x4bb6d0===_0x44a007)break;else _0x4334f9['push'](_0x4334f9['shift']());}catch(_0xadfff1){_0x4334f9['push'](_0x4334f9['shift']());}}}(_0x156b,0x7854f));function _0x156b(){const _0x51dddf=['createRandomCode','&registerFailEmailTitle=','userId','saveToken','configKey','4pqJhsN','UserBalanceService','秒内不得重复发送短信！','padStart','#fff','registerFailEmailTitle','/api/auth/registerError?message=','redirect','admin','verifyUserCredentials','find','toString','login','VerificationService','object','127.0.0.1','194121SlQqdZ','@nestjs/typeorm','hashSync','Registration','keys','../globalConfig/config.entity','HttpException','length','ACTIVE','verifyUserRegisterByPhone','getUserInfo','qureyUserInfoByInviteCode','register','log','createMathExpr','1352150UJdcNx','createRandomUid','RedisCacheService','queryUserInfoById','verificationService','redisCacheService','UserStatusEnum','88bSBIpB','loginByOpenId','addBalanceToNewUser','onModuleInit','bcryptjs','HttpStatus','IPv4',':PHONECODE:','decorate','error:\x20','../../common/utils','family','902292xHLAFc','getClientIp','updateUserStatus','ConfigEntity','password','activateAccount','getIp','账户已被激活过','updateUserPassword','address','668697mwlTzn','getUserStatus','userBalanceService','UserStatusErrMsg','Injectable','2929945dFdLKJ','registerByPhone','function','createUserAndVerifycation','../redisCache/redisCache.service','userDefautlAvatar','text','密码修改成功','ttl',':CAPTCHA:','savaLoginIp','set','messageInfo:\x20','userService','验证码填写错误、请重新输入！','defineProperty','client','__metadata','getInfo','sendPhoneCode','无权此操作、请联系管理员！','760636GgwSwU','6BFBojE','&registerFailEmailTeamName=','internal','reduce','sign','configEntity','验证码已过期、请重新发送！','../userBalance/userBalance.service','registerFailEmailTeamName','configVal','captcha','JwtService','BAD_REQUEST','design:paramtypes','loginByPhone','globalConfigService','registerSuccessEmailTitle','typeorm','avatar','&registerSuccessEmaileAppend=','registerSuccessEmaileAppend','Repository','MailerService','__decorate','&email=','data','response','svg-captcha','user','registerSuccessEmailTeamName','验证码类型错误','createUser','../../common/constants/user.constant','&registerSuccessEmailTitle=','jwtService','&registerSuccessEmailTeamName=','&username=','metadata','../../common/constants/verification.constant','getNamespace','379169nYWHqr'];_0x156b=function(){return _0x51dddf;};return _0x156b();}var __decorate=this&&this[_0x35338f(0x1ae)]||function(_0x3dbaf7,_0x3baf90,_0x24dd95,_0x202273){const _0x447bba=_0x35338f;var _0x36d681=arguments[_0x447bba(0x1dc)],_0x41f455=_0x36d681<0x3?_0x3baf90:_0x202273===null?_0x202273=Object['getOwnPropertyDescriptor'](_0x3baf90,_0x24dd95):_0x202273,_0x3951e2;if(typeof Reflect===_0x447bba(0x1d3)&&typeof Reflect[_0x447bba(0x1f3)]===_0x447bba(0x208))_0x41f455=Reflect[_0x447bba(0x1f3)](_0x3dbaf7,_0x3baf90,_0x24dd95,_0x202273);else{for(var _0x5340ff=_0x3dbaf7[_0x447bba(0x1dc)]-0x1;_0x5340ff>=0x0;_0x5340ff--)if(_0x3951e2=_0x3dbaf7[_0x5340ff])_0x41f455=(_0x36d681<0x3?_0x3951e2(_0x41f455):_0x36d681>0x3?_0x3951e2(_0x3baf90,_0x24dd95,_0x41f455):_0x3951e2(_0x3baf90,_0x24dd95))||_0x41f455;}return _0x36d681>0x3&&_0x41f455&&Object[_0x447bba(0x215)](_0x3baf90,_0x24dd95,_0x41f455),_0x41f455;},__metadata=this&&this[_0x35338f(0x217)]||function(_0x28137e,_0x1e3810){const _0x2b3a81=_0x35338f;if(typeof Reflect===_0x2b3a81(0x1d3)&&typeof Reflect[_0x2b3a81(0x1bc)]===_0x2b3a81(0x208))return Reflect[_0x2b3a81(0x1bc)](_0x28137e,_0x1e3810);},__param=this&&this['__param']||function(_0x27e40c,_0x63e13c){return function(_0x615bec,_0x28cf4a){_0x63e13c(_0x615bec,_0x28cf4a,_0x27e40c);};};Object[_0x35338f(0x215)](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;function _0x5ebe(_0x35d0cf,_0x4fb981){const _0x156b6d=_0x156b();return _0x5ebe=function(_0x5ebe6a,_0x3e37df){_0x5ebe6a=_0x5ebe6a-0x197;let _0x19eace=_0x156b6d[_0x5ebe6a];return _0x19eace;},_0x5ebe(_0x35d0cf,_0x4fb981);}const globalConfig_service_1=require('../globalConfig/globalConfig.service'),verification_constant_1=require(_0x35338f(0x1bd)),verification_service_1=require('./../verification/verification.service'),common_1=require('@nestjs/common'),jwt_1=require('@nestjs/jwt'),user_service_1=require('../user/user.service'),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x35338f(0x1b7)),userBalance_service_1=require(_0x35338f(0x19e)),config_entity_1=require(_0x35338f(0x1da)),typeorm_1=require(_0x35338f(0x1a8)),typeorm_2=require(_0x35338f(0x1d6)),utils_1=require(_0x35338f(0x1f5)),os=require('os'),redisCache_service_1=require(_0x35338f(0x20a)),svgCaptcha=require(_0x35338f(0x1b2)),bcrypt=require(_0x35338f(0x1ef));let AuthService=class AuthService{constructor(_0x213969,_0x2914f2,_0x3f62c8,_0x5ed871,_0xce4972,_0x4d8a6c,_0x4ed37a,_0x684e75){const _0x358805=_0x35338f;this[_0x358805(0x19c)]=_0x213969,this[_0x358805(0x213)]=_0x2914f2,this[_0x358805(0x1b9)]=_0x3f62c8,this['mailerService']=_0x5ed871,this[_0x358805(0x1e8)]=_0xce4972,this['userBalanceService']=_0x4d8a6c,this[_0x358805(0x1e9)]=_0x4ed37a,this[_0x358805(0x1a6)]=_0x684e75;}async[_0x35338f(0x1ee)](){this['getIp']();}async[_0x35338f(0x1e1)](_0x5b44ec,_0x21569d){const _0x4b9ae6=_0x35338f;await this[_0x4b9ae6(0x1e8)]['verifyCaptcha'](_0x5b44ec);const _0x3958d1=await this[_0x4b9ae6(0x213)][_0x4b9ae6(0x209)](_0x5b44ec,_0x21569d),{username:_0x195e06,email:_0x19b799,client:_0x4d2b8d,id:_0xea76a1}=_0x3958d1,_0x18d907={'username':_0x195e06,'email':_0x19b799,'id':_0xea76a1};return _0x4d2b8d&&(_0x18d907[_0x4b9ae6(0x216)]=_0x4d2b8d),_0x18d907;}async[_0x35338f(0x207)](_0x1fd362,_0x287f2d){const _0x33ae6d=_0x35338f,{username:_0x2c99b5,password:_0xcb9e30,phone:_0x26b618,phoneCode:_0x3cc947,invitedBy:_0x270b25}=_0x1fd362;await this[_0x33ae6d(0x213)][_0x33ae6d(0x1de)](_0x1fd362);const _0x229d08=await this[_0x33ae6d(0x1a6)][_0x33ae6d(0x1be)](),_0x423b43=_0x229d08+_0x33ae6d(0x1f2)+_0x26b618,_0x357e11=await this['redisCacheService']['get']({'key':_0x423b43});if(!_0x357e11)throw new common_1['HttpException'](_0x33ae6d(0x19d),common_1[_0x33ae6d(0x1f0)][_0x33ae6d(0x1a3)]);if(_0x3cc947!==_0x357e11)throw new common_1[(_0x33ae6d(0x1db))](_0x33ae6d(0x214),common_1[_0x33ae6d(0x1f0)][_0x33ae6d(0x1a3)]);const _0x349c9d=(0x0,utils_1[_0x33ae6d(0x1e5)])()+'@nine.com',_0x5c0513={'username':_0x2c99b5,'password':_0xcb9e30,'phone':_0x26b618,'invitedBy':_0x270b25,'email':_0x349c9d,'status':user_constant_1['UserStatusEnum'][_0x33ae6d(0x1dd)]},_0x5cf099=await this[_0x33ae6d(0x1a6)]['getConfigs']([_0x33ae6d(0x20b)]);_0x5c0513[_0x33ae6d(0x1a9)]=_0x5cf099;const _0x3dc698=bcrypt[_0x33ae6d(0x1d7)](_0xcb9e30,0xa);_0x5c0513['password']=_0x3dc698;const _0x2a6b12=await this[_0x33ae6d(0x213)][_0x33ae6d(0x1b6)](_0x5c0513);let _0xb5981;_0x270b25&&(_0xb5981=await this['userService']['qureyUserInfoByInviteCode'](_0x270b25));await this[_0x33ae6d(0x203)][_0x33ae6d(0x1ed)](_0x2a6b12['id'],_0xb5981===null||_0xb5981===void 0x0?void 0x0:_0xb5981['id']),console[_0x33ae6d(0x1e2)]('输入一样进入注册流程');return;}async[_0x35338f(0x1d1)](_0x3c2b31,_0x369ffe){const _0x105d83=_0x35338f,_0xb2a78e=await this['userService'][_0x105d83(0x1ce)](_0x3c2b31),{username:_0x48361b,id:_0xf9ee10,email:_0x5448e9,role:_0x30b7ce,openId:_0x1fe28c,client:_0x5cc07a}=_0xb2a78e,_0x10134f=(0x0,utils_1[_0x105d83(0x1f8)])(_0x369ffe);await this[_0x105d83(0x213)][_0x105d83(0x210)](_0xf9ee10,_0x10134f);const _0x403e41=await this[_0x105d83(0x1b9)]['sign']({'username':_0x48361b,'id':_0xf9ee10,'email':_0x5448e9,'role':_0x30b7ce,'openId':_0x1fe28c,'client':_0x5cc07a});return await this['redisCacheService']['saveToken'](_0xf9ee10,_0x403e41),_0x403e41;}async[_0x35338f(0x1a5)](_0x4bd975,_0x146c52){const _0x4b3a4e=_0x35338f,_0x4f841e=await this[_0x4b3a4e(0x213)]['verifyUserCredentials'](_0x4bd975),{username:_0xf05afe,id:_0x3aeaa8,email:_0x1e5600,role:_0x557ba5,openId:_0x3063d1,client:_0x3a0977}=_0x4f841e,_0x5945eb=(0x0,utils_1[_0x4b3a4e(0x1f8)])(_0x146c52);await this[_0x4b3a4e(0x213)][_0x4b3a4e(0x210)](_0x3aeaa8,_0x5945eb);const {phone:_0x3b1fc9}=_0x4bd975,_0x4aa8ad=await this['jwtService'][_0x4b3a4e(0x19b)]({'username':_0xf05afe,'id':_0x3aeaa8,'email':_0x1e5600,'role':_0x557ba5,'openId':_0x3063d1,'client':_0x3a0977,'phone':_0x3b1fc9});return await this[_0x4b3a4e(0x1e9)][_0x4b3a4e(0x1c3)](_0x3aeaa8,_0x4aa8ad),_0x4aa8ad;}async[_0x35338f(0x1ec)](_0x470a22,_0x3c9f09){const _0x1438a8=_0x35338f,{status:_0xceba9c}=_0x470a22;if(_0xceba9c!==user_constant_1[_0x1438a8(0x1ea)][_0x1438a8(0x1dd)])throw new common_1[(_0x1438a8(0x1db))](user_constant_1[_0x1438a8(0x204)][_0xceba9c],common_1[_0x1438a8(0x1f0)][_0x1438a8(0x1a3)]);const {username:_0x7aa216,id:_0x2b64e1,email:_0x420d26,role:_0x27f811,openId:_0x461cdf,client:_0x20ca22}=_0x470a22,_0x18aabf=(0x0,utils_1[_0x1438a8(0x1f8)])(_0x3c9f09);await this[_0x1438a8(0x213)][_0x1438a8(0x210)](_0x2b64e1,_0x18aabf);const _0x423bbe=await this[_0x1438a8(0x1b9)]['sign']({'username':_0x7aa216,'id':_0x2b64e1,'email':_0x420d26,'role':_0x27f811,'openId':_0x461cdf,'client':_0x20ca22});return await this[_0x1438a8(0x1e9)][_0x1438a8(0x1c3)](_0x2b64e1,_0x423bbe),_0x423bbe;}async[_0x35338f(0x218)](_0x1333b0){const _0xce438d=_0x35338f,{id:_0x872a06}=_0x1333b0[_0xce438d(0x1b3)];return await this[_0xce438d(0x213)][_0xce438d(0x1df)](_0x872a06);}async[_0x35338f(0x1fc)](_0x1eb90f,_0x54a43c){const _0x141c8f=_0x35338f,_0xfd93be=await this[_0x141c8f(0x19c)][_0x141c8f(0x1cf)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x141c8f(0x1a7),_0x141c8f(0x1b4),'registerSuccessEmaileAppend',_0x141c8f(0x1ca),_0x141c8f(0x19f)])}}),_0x16bd3b=_0xfd93be[_0x141c8f(0x19a)]((_0x195ff1,_0x596b84)=>{const _0xa9bda4=_0x141c8f;return _0x195ff1[_0x596b84[_0xa9bda4(0x1c4)]]=_0x596b84[_0xa9bda4(0x1a0)],_0x195ff1;},{});try{const _0x10c9c5=await this['verificationService']['verifyCode'](_0x1eb90f,verification_constant_1['VerificationEnum'][_0x141c8f(0x1d8)]),{type:_0x3f6025,userId:_0x29540d}=_0x10c9c5;if(_0x3f6025!==verification_constant_1['VerificationEnum']['Registration'])throw new common_1[(_0x141c8f(0x1db))](_0x141c8f(0x1b5),common_1['HttpStatus'][_0x141c8f(0x1a3)]);const _0x5e563a=await this['userService'][_0x141c8f(0x202)](_0x29540d);if(_0x5e563a===user_constant_1[_0x141c8f(0x1ea)][_0x141c8f(0x1dd)])throw new common_1[(_0x141c8f(0x1db))](_0x141c8f(0x1fe),common_1[_0x141c8f(0x1f0)][_0x141c8f(0x1a3)]);await this[_0x141c8f(0x213)][_0x141c8f(0x1f9)](_0x10c9c5[_0x141c8f(0x1c2)],user_constant_1[_0x141c8f(0x1ea)][_0x141c8f(0x1dd)]);const _0x2a6f25=await this['userService'][_0x141c8f(0x1e7)](_0x10c9c5[_0x141c8f(0x1c2)]),{username:_0x5079d2,email:_0x4c5007,id:_0x316495,invitedBy:_0x40f164}=_0x2a6f25;let _0x4a24a8;_0x40f164&&(_0x4a24a8=await this[_0x141c8f(0x213)][_0x141c8f(0x1e0)](_0x40f164)),await this[_0x141c8f(0x203)][_0x141c8f(0x1ed)](_0x316495,_0x4a24a8===null||_0x4a24a8===void 0x0?void 0x0:_0x4a24a8['id']),_0x54a43c[_0x141c8f(0x1cc)]('/api/auth/registerSuccess?id='+_0x316495[_0x141c8f(0x1d0)]()[_0x141c8f(0x1c8)](0x4,'0')+_0x141c8f(0x1bb)+_0x5079d2+_0x141c8f(0x1af)+_0x4c5007+_0x141c8f(0x1b8)+_0x16bd3b['registerSuccessEmailTitle']+_0x141c8f(0x1ba)+_0x16bd3b['registerSuccessEmailTeamName']+_0x141c8f(0x1aa)+_0x16bd3b[_0x141c8f(0x1ab)]);}catch(_0x29095d){console[_0x141c8f(0x1e2)](_0x141c8f(0x1f4),_0x29095d);const _0x3e4ca1=_0x29095d[_0x141c8f(0x1b1)];_0x54a43c[_0x141c8f(0x1cc)](_0x141c8f(0x1cb)+_0x3e4ca1+_0x141c8f(0x1c1)+_0x16bd3b['registerFailEmailTitle']+_0x141c8f(0x198)+_0x16bd3b[_0x141c8f(0x19f)]);}}async['updatePassword'](_0x1c46f6,_0x54cfa3){const _0x42efd0=_0x35338f,{id:_0x2667cb,client:_0x3a7a15,role:_0x13ce78}=_0x1c46f6[_0x42efd0(0x1b3)];if(_0x3a7a15&&Number(_0x3a7a15)>0x0)throw new common_1['HttpException'](_0x42efd0(0x21a),common_1[_0x42efd0(0x1f0)][_0x42efd0(0x1a3)]);if(_0x13ce78===_0x42efd0(0x1cd))throw new common_1['HttpException']('非法操作、请联系管理员！',common_1[_0x42efd0(0x1f0)][_0x42efd0(0x1a3)]);const _0x5b74f1=await this['userService']['verifyUserPassword'](_0x2667cb,_0x54cfa3['oldPassword']);if(!_0x5b74f1)throw new common_1['HttpException']('旧密码错误、请检查提交',common_1[_0x42efd0(0x1f0)][_0x42efd0(0x1a3)]);return this['userService'][_0x42efd0(0x1ff)](_0x2667cb,_0x54cfa3[_0x42efd0(0x1fb)]),_0x42efd0(0x20d);}async['updatePassByOther'](_0x430647,_0x28becf){const _0x5655dd=_0x35338f,{id:_0x2bada4,client:_0x1c95e4}=_0x430647[_0x5655dd(0x1b3)];if(!_0x1c95e4)throw new common_1[(_0x5655dd(0x1db))]('无权此操作！',common_1[_0x5655dd(0x1f0)][_0x5655dd(0x1a3)]);return this['userService'][_0x5655dd(0x1ff)](_0x2bada4,_0x28becf[_0x5655dd(0x1fb)]),_0x5655dd(0x20d);}[_0x35338f(0x1fd)](){const _0x971846=_0x35338f;let _0x192318;const _0x5db08b=os['networkInterfaces']();Object[_0x971846(0x1d9)](_0x5db08b)['forEach'](_0x11c59d=>{const _0x683ac6=_0x971846,_0x41c979=_0x5db08b[_0x11c59d];for(let _0xe46726=0x0;_0xe46726<_0x41c979[_0x683ac6(0x1dc)];_0xe46726++){const _0x2f7a6c=_0x41c979[_0xe46726];if(_0x2f7a6c[_0x683ac6(0x1f6)]===_0x683ac6(0x1f1)&&_0x2f7a6c['address']!==_0x683ac6(0x1d4)&&!_0x2f7a6c[_0x683ac6(0x199)]){_0x192318=_0x2f7a6c[_0x683ac6(0x200)];break;}}}),this['ipAddress']=_0x192318;}async[_0x35338f(0x1a1)](_0x4ae0cb){const _0x5ceeeb=_0x35338f,_0x5aee8d=await this[_0x5ceeeb(0x1a6)][_0x5ceeeb(0x1be)](),{color:color=_0x5ceeeb(0x1c9)}=_0x4ae0cb,_0x21ac5b=svgCaptcha[_0x5ceeeb(0x1e3)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5b4c00=_0x21ac5b[_0x5ceeeb(0x20c)],_0x33b821=(0x0,utils_1[_0x5ceeeb(0x1e5)])(),_0x220531=_0x5aee8d+_0x5ceeeb(0x20f)+_0x33b821;return await this[_0x5ceeeb(0x1e9)][_0x5ceeeb(0x211)]({'key':_0x220531,'val':_0x21ac5b[_0x5ceeeb(0x20c)]},0x5*0x3c),{'svgCode':_0x21ac5b[_0x5ceeeb(0x1b0)],'code':_0x33b821};}async[_0x35338f(0x219)](_0x198b76){const _0x4f5b0c=_0x35338f;await this[_0x4f5b0c(0x1e8)]['verifyCaptcha'](_0x198b76);const {phone:_0x4d6333}=_0x198b76,_0x32b62f=await this[_0x4f5b0c(0x1a6)]['getNamespace'](),_0x403670=_0x32b62f+_0x4f5b0c(0x1f2)+_0x4d6333,_0x42fb27=await this['redisCacheService'][_0x4f5b0c(0x20e)](_0x403670);if(_0x42fb27&&_0x42fb27>0x0)throw new common_1[(_0x4f5b0c(0x1db))](_0x42fb27+_0x4f5b0c(0x1c7),common_1['HttpStatus']['BAD_REQUEST']);const _0x2b10fd=(0x0,utils_1[_0x4f5b0c(0x1c0)])(),_0x3a4e55={'phone':_0x4d6333,'code':_0x2b10fd};return console[_0x4f5b0c(0x1e2)](_0x4f5b0c(0x212),_0x3a4e55),await this[_0x4f5b0c(0x1e8)]['sendPhoneCode'](_0x3a4e55),await this[_0x4f5b0c(0x1e9)][_0x4f5b0c(0x211)]({'key':_0x403670,'val':_0x2b10fd},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}};AuthService=__decorate([(0x0,common_1[_0x35338f(0x205)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x35338f(0x1fa)])),__metadata(_0x35338f(0x1a4),[typeorm_1[_0x35338f(0x1ac)],user_service_1['UserService'],jwt_1[_0x35338f(0x1a2)],mailer_service_1[_0x35338f(0x1ad)],verification_service_1[_0x35338f(0x1d2)],userBalance_service_1[_0x35338f(0x1c6)],redisCache_service_1[_0x35338f(0x1e6)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports['AuthService']=AuthService;